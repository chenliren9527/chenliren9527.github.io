<!DOCTYPE HTML><html lang="zh-CN"><head><meta charset="utf-8"><meta name="keywords" content="就业技术加强(05)-DUBBO&amp;Zookeeper(2), 薛定谔的腿毛"><meta name="description" content="0、课程目标目标1: 能够配置dubbo-springboot工程
目标2: 能够配置dubbo的容错和降级
目标3: 能够说出dubbo的负载均衡策略
目标4: 能够应用dubbo的灰度发布
目标5: 能够说出dubbo的常见面试题
1、"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width,initial-scale=1,user-scalable=no"><meta name="renderer" content="webkit|ie-stand|ie-comp"><meta name="mobile-web-app-capable" content="yes"><meta name="format-detection" content="telephone=no"><meta name="apple-mobile-web-app-capable" content="yes"><meta name="apple-mobile-web-app-status-bar-style" content="black-translucent"><meta name="referrer" content="no-referrer-when-downgrade"><title>就业技术加强(05)-DUBBO&amp;Zookeeper(2) | 薛定谔的腿毛</title><link rel="icon" type="image/png" href="/favicon.png"><link rel="stylesheet" href="/libs/awesome/css/all.min.css"><link rel="stylesheet" href="/libs/materialize/materialize.min.css"><link rel="stylesheet" href="/libs/aos/aos.css"><link rel="stylesheet" href="/libs/animate/animate.min.css"><link rel="stylesheet" href="/libs/lightGallery/css/lightgallery.min.css"><link rel="stylesheet" href="/css/matery.css"><link rel="stylesheet" href="/css/my.css"><script src="/libs/jquery/jquery-3.6.0.min.js"></script><meta name="generator" content="Hexo 5.3.0"><style>.github-emoji{position:relative;display:inline-block;width:1.2em;min-height:1.2em;overflow:hidden;vertical-align:top;color:transparent}.github-emoji>span{position:relative;z-index:10}.github-emoji .fancybox,.github-emoji img{margin:0!important;padding:0!important;border:none!important;outline:0!important;text-decoration:none!important;user-select:none!important;cursor:auto!important}.github-emoji img{height:1.2em!important;width:1.2em!important;position:absolute!important;left:50%!important;top:50%!important;transform:translate(-50%,-50%)!important;user-select:none!important;cursor:auto!important}.github-emoji-fallback{color:inherit}.github-emoji-fallback img{opacity:0!important}</style><link rel="alternate" href="/atom.xml" title="薛定谔的腿毛" type="application/atom+xml"></head><body><header class="navbar-fixed"><nav id="headNav" class="bg-color nav-transparent"><div id="navContainer" class="nav-wrapper container"><div class="brand-logo"><a href="/" class="waves-effect waves-light"><img src="/medias/logo.png" class="logo-img" alt="LOGO"> <span class="logo-span">薛定谔的腿毛</span></a></div><a href="#" data-target="mobile-nav" class="sidenav-trigger button-collapse"><i class="fas fa-bars"></i></a><ul class="right nav-menu"><li class="hide-on-med-and-down nav-item"><a href="/" class="waves-effect waves-light"><i class="fas fa-home" style="zoom:.6"></i> <span>首页</span></a></li><li class="hide-on-med-and-down nav-item"><a href="/tags" class="waves-effect waves-light"><i class="fas fa-tags" style="zoom:.6"></i> <span>标签</span></a></li><li class="hide-on-med-and-down nav-item"><a href="/categories" class="waves-effect waves-light"><i class="fas fa-bookmark" style="zoom:.6"></i> <span>分类</span></a></li><li class="hide-on-med-and-down nav-item"><a href="/archives" class="waves-effect waves-light"><i class="fas fa-archive" style="zoom:.6"></i> <span>归档</span></a></li><li class="hide-on-med-and-down nav-item"><a href="/about" class="waves-effect waves-light"><i class="fas fa-user-circle" style="zoom:.6"></i> <span>关于</span></a></li><li><a href="#searchModal" class="modal-trigger waves-effect waves-light"><i id="searchIcon" class="fas fa-search" title="搜索" style="zoom:.85"></i></a></li></ul><div id="mobile-nav" class="side-nav sidenav"><div class="mobile-head bg-color"><img src="/medias/logo.png" class="logo-img circle responsive-img"><div class="logo-name">薛定谔的腿毛</div><div class="logo-desc">Never really desperate, only the lost of the soul.</div></div><ul class="menu-list mobile-menu-list"><li class="m-nav-item"><a href="/" class="waves-effect waves-light"><i class="fa-fw fas fa-home"></i> 首页</a></li><li class="m-nav-item"><a href="/tags" class="waves-effect waves-light"><i class="fa-fw fas fa-tags"></i> 标签</a></li><li class="m-nav-item"><a href="/categories" class="waves-effect waves-light"><i class="fa-fw fas fa-bookmark"></i> 分类</a></li><li class="m-nav-item"><a href="/archives" class="waves-effect waves-light"><i class="fa-fw fas fa-archive"></i> 归档</a></li><li class="m-nav-item"><a href="/about" class="waves-effect waves-light"><i class="fa-fw fas fa-user-circle"></i> 关于</a></li></ul></div></div></nav></header><script src="/libs/cryptojs/crypto-js.min.js"></script><script>(function() {
        let pwd = '';
        if (pwd && pwd.length > 0) {
            if (pwd !== CryptoJS.SHA256(prompt('请输入访问本文章的密码')).toString(CryptoJS.enc.Hex)) {
                alert('密码错误，将返回主页！');
                location.href = '/';
            }
        }
    })();</script><div class="bg-cover pd-header post-cover" style="background-image:url(/medias/featureimages/105.jpg)"><div class="container" style="right:0;left:0"><div class="row"><div class="col s12 m12 l12"><div class="brand"><h1 class="description center-align post-title">就业技术加强(05)-DUBBO&amp;Zookeeper(2)</h1></div></div></div></div></div><main class="post-container content"><link rel="stylesheet" href="/libs/tocbot/tocbot.css"><style>#articleContent h1::before,#articleContent h2::before,#articleContent h3::before,#articleContent h4::before,#articleContent h5::before,#articleContent h6::before{display:block;content:" ";height:100px;margin-top:-100px;visibility:hidden}#articleContent :focus{outline:0}.toc-fixed{position:fixed;top:64px}.toc-widget{width:345px;padding-left:20px}.toc-widget .toc-title{padding:35px 0 15px 17px;font-size:1.5rem;font-weight:700;line-height:1.5rem}.toc-widget ol{padding:0;list-style:none}#toc-content{padding-bottom:30px;overflow:auto}#toc-content ol{padding-left:10px}#toc-content ol li{padding-left:10px}#toc-content .toc-link:hover{color:#42b983;font-weight:700;text-decoration:underline}#toc-content .toc-link::before{background-color:transparent;max-height:25px;position:absolute;right:23.5vw;display:block}#toc-content .is-active-link{color:#42b983}#floating-toc-btn{position:fixed;right:15px;bottom:76px;padding-top:15px;margin-bottom:0;z-index:998}#floating-toc-btn .btn-floating{width:48px;height:48px}#floating-toc-btn .btn-floating i{line-height:48px;font-size:1.4rem}</style><div class="row"><div id="main-content" class="col s12 m12 l9"><div id="artDetail"><div class="card"><div class="card-content article-info"><div class="row tag-cate"><div class="col s7"><div class="article-tag"><a href="/tags/%E7%AC%94%E8%AE%B0/"><span class="chip bg-color">笔记</span></a> <a href="/tags/%E5%B0%B1%E4%B8%9A%E6%8A%80%E6%9C%AF%E5%8A%A0%E5%BC%BA/"><span class="chip bg-color">就业技术加强</span></a> <a href="/tags/DUBBO/"><span class="chip bg-color">DUBBO</span></a> <a href="/tags/Zookeeper/"><span class="chip bg-color">Zookeeper</span></a> <a href="/tags/%E9%9B%86%E7%BE%A4/"><span class="chip bg-color">集群</span></a> <a href="/tags/%E4%BC%98%E5%8C%96/"><span class="chip bg-color">优化</span></a></div></div><div class="col s5 right-align"><div class="post-cate"><i class="fas fa-bookmark fa-fw icon-category"></i> <a href="/categories/%E5%B0%B1%E4%B8%9A%E6%8A%80%E6%9C%AF%E5%8A%A0%E5%BC%BA/" class="post-category">就业技术加强</a></div></div></div><div class="post-info"><div class="post-date info-break-policy"><i class="far fa-calendar-minus fa-fw"></i> 发布日期:&nbsp;&nbsp; 2021-01-28</div><div class="post-date info-break-policy"><i class="far fa-calendar-check fa-fw"></i> 更新日期:&nbsp;&nbsp; 2023-10-15</div><div class="info-break-policy"><i class="far fa-file-word fa-fw"></i> 文章字数:&nbsp;&nbsp; 5.5k</div><div class="info-break-policy"><i class="far fa-clock fa-fw"></i> 阅读时长:&nbsp;&nbsp; 20 分</div><div id="busuanzi_container_page_pv" class="info-break-policy"><i class="far fa-eye fa-fw"></i> 阅读次数:&nbsp;&nbsp;<span id="busuanzi_value_page_pv"></span></div></div></div><hr class="clearfix"><link rel="stylesheet" href="/libs/prism/prism.css"><style>code[class*=language-],pre[class*=language-]{white-space:pre-wrap!important}</style><div class="card-content article-card-content"><div id="articleContent"><h2 id="0、课程目标"><a href="#0、课程目标" class="headerlink" title="0、课程目标"></a>0、课程目标</h2><p>目标1: 能够配置dubbo-springboot工程</p><p>目标2: 能够配置dubbo的容错和降级</p><p>目标3: 能够说出dubbo的负载均衡策略</p><p>目标4: 能够应用dubbo的灰度发布</p><p>目标5: 能够说出dubbo的常见面试题</p><h2 id="1、DUBBO架构"><a href="#1、DUBBO架构" class="headerlink" title="1、DUBBO架构"></a>1、DUBBO架构</h2><p>Apache Dubbo 是一款高性能、轻量级的开源 Java 服务框架。</p><p>Apache Dubbo |ˈdʌbəʊ| 提供了六大核心能力：面向接口代理的高性能RPC调用，智能容错和负载均衡，服务自动注册和发现，高度可扩展能力，运行期流量调度，可视化的服务治理与运维。</p><p><img src="%E5%B0%B1%E4%B8%9A%E6%8A%80%E6%9C%AF%E5%8A%A0%E5%BC%BA-05-DUBBO-Zookeeper-2.assets/image-20201225191632016.png" alt="image-20201225191632016"></p><p><strong>图例说明</strong>：</p><ul><li>图中小方块 Protocol, Cluster, Proxy, Service, Container, Registry, Monitor 代表层或模块，蓝色的表示与业务有交互，绿色的表示只对 Dubbo 内部交互。</li><li>图中背景方块 Consumer, Provider, Registry, Monitor 代表部署逻辑拓扑节点。</li><li>图中蓝色虚线为初始化时调用，红色虚线为运行时异步调用，红色实线为运行时同步调用。</li><li>图中只包含 RPC 的层，不包含 Remoting 的层，Remoting 整体都隐含在 Protocol 中。</li></ul><p><strong>调用关系说明：</strong></p><ol start="0"><li><p>服务容器负责启动，加载，运行服务提供者。</p></li><li><p>服务提供者在启动时，向注册中心注册自己提供的服务。</p></li><li><p>服务消费者在启动时，向注册中心订阅自己所需的服务。</p></li><li><p>注册中心返回服务提供者地址列表给消费者，如果有变更，注册中心将基于长连接推送变更数据给消费者。</p></li><li><p>服务消费者，从提供者地址列表中，基于软负载均衡算法，选一台提供者进行调用，如果调用失败，再选另一台调用。</p></li><li><p>服务消费者和提供者，在内存中累计调用次数和调用时间，定时每分钟发送一次统计数据到监控中心。</p></li></ol><p>【软负载均衡】软件负载均衡则是通过在服务器上安装的特定的负载均衡软件或是自带负载均衡模块完成对请求的分配派发。如：轮询法、随机法、源地址哈希法、最小连接数法等。在消费方中声明服务的时候可以指定负载均衡的策略，dubbo在返回的服务地址列表中使用负载均衡策略选择一个服务地址；默认是使用随机法。</p><h2 id="2、DUBBO-SpringBoot"><a href="#2、DUBBO-SpringBoot" class="headerlink" title="2、DUBBO SpringBoot"></a>2、DUBBO SpringBoot</h2><p>使用DUBBO 及 Spring Boot的工程，通过如下的案例来了解其整合。</p><h3 id="2-1、导入案例工程"><a href="#2-1、导入案例工程" class="headerlink" title="2.1、导入案例工程"></a>2.1、导入案例工程</h3><h4 id="1）创建空工程"><a href="#1）创建空工程" class="headerlink" title="1）创建空工程"></a>1）创建空工程</h4><p><img src="%E5%B0%B1%E4%B8%9A%E6%8A%80%E6%9C%AF%E5%8A%A0%E5%BC%BA-05-DUBBO-Zookeeper-2.assets/image-20201225211919776.png" alt="image-20201225211919776"></p><p><img src="%E5%B0%B1%E4%B8%9A%E6%8A%80%E6%9C%AF%E5%8A%A0%E5%BC%BA-05-DUBBO-Zookeeper-2.assets/image-20201225213243775.png" alt="image-20201225213243775"></p><p><img src="%E5%B0%B1%E4%B8%9A%E6%8A%80%E6%9C%AF%E5%8A%A0%E5%BC%BA-05-DUBBO-Zookeeper-2.assets/image-20201225213413917.png" alt="image-20201225213413917"></p><p>创建好一个空工程是如下的目录结构：</p><p><img src="%E5%B0%B1%E4%B8%9A%E6%8A%80%E6%9C%AF%E5%8A%A0%E5%BC%BA-05-DUBBO-Zookeeper-2.assets/image-20201225213511930.png" alt="image-20201225213511930"></p><h4 id="2）导入案例工程"><a href="#2）导入案例工程" class="headerlink" title="2）导入案例工程"></a>2）导入案例工程</h4><p>复制 <code>资料\案例工程\dubbo-springboot</code> 到刚刚创建的空工程目录下；</p><p><img src="%E5%B0%B1%E4%B8%9A%E6%8A%80%E6%9C%AF%E5%8A%A0%E5%BC%BA-05-DUBBO-Zookeeper-2.assets/image-20201225213705391.png" alt="image-20201225213705391"></p><p><img src="%E5%B0%B1%E4%B8%9A%E6%8A%80%E6%9C%AF%E5%8A%A0%E5%BC%BA-05-DUBBO-Zookeeper-2.assets/image-20201225213739109.png" alt="image-20201225213739109"></p><p><img src="%E5%B0%B1%E4%B8%9A%E6%8A%80%E6%9C%AF%E5%8A%A0%E5%BC%BA-05-DUBBO-Zookeeper-2.assets/image-20201225213826129.png" alt="image-20201225213826129"></p><p>导入完成后如下：</p><p><img src="%E5%B0%B1%E4%B8%9A%E6%8A%80%E6%9C%AF%E5%8A%A0%E5%BC%BA-05-DUBBO-Zookeeper-2.assets/image-20201225213844081.png" alt="image-20201225213844081"></p><p><code>goods-service</code> 表示商品系统，既是服务提供者也是服务消费者；</p><p><code>order-service</code> 表示订单系统，既是服务提供者也是服务消费者；</p><h3 id="2-2、注册中心"><a href="#2-2、注册中心" class="headerlink" title="2.2、注册中心"></a>2.2、注册中心</h3><p>Dubbo默认支持五种注册中心： 推荐使用&nbsp;<a target="_blank" rel="noopener" href="http://dubbo.apache.org/zh-cn/docs/user/references/registry/zookeeper.html">Zookeeper 注册中心</a></p><p><a target="_blank" rel="noopener" href="http://zookeeper.apache.org/">Zookeeper</a>&nbsp;是 Apacahe Hadoop 的子项目，是一个树型的目录服务，支持变更推送，适合作为 Dubbo 服务的注册中心，工业强度较高，可用于生产环境，并推荐使用。</p><p>先使用windows版本；解压 <code>资料\zookeeper-3.4.14.zip</code> ；</p><p>进入解压后目录并双击启动 <code>zookeeper-3.4.14\bin\zkServer.cmd</code></p><p><img src="%E5%B0%B1%E4%B8%9A%E6%8A%80%E6%9C%AF%E5%8A%A0%E5%BC%BA-05-DUBBO-Zookeeper-2.assets/image-20201225214233070.png" alt="image-20201225214233070"></p><h3 id="2-3、导入DUBBO监控中心"><a href="#2-3、导入DUBBO监控中心" class="headerlink" title="2.3、导入DUBBO监控中心"></a>2.3、导入DUBBO监控中心</h3><p>可以到 dubbo-admin.zip(<a target="_blank" rel="noopener" href="https://github.com/apache/dubbo-admin">https://github.com/apache/dubbo-admin</a>) 下载</p><p>git clone <a target="_blank" rel="noopener" href="https://github.com/apache/dubbo-admin.git(%E5%85%8B%E9%9A%86%E4%BB%93%E5%BA%93)">https://github.com/apache/dubbo-admin.git(克隆仓库)</a></p><p><img src="%E5%B0%B1%E4%B8%9A%E6%8A%80%E6%9C%AF%E5%8A%A0%E5%BC%BA-05-DUBBO-Zookeeper-2.assets/image-20201225215303175.png" alt="image-20201225215303175"></p><h4 id="1）解压"><a href="#1）解压" class="headerlink" title="1）解压"></a>1）解压</h4><p>解压 <code>资料\dubbo-admin-master.zip</code> 到创建的空工程目录下如下：</p><p><img src="%E5%B0%B1%E4%B8%9A%E6%8A%80%E6%9C%AF%E5%8A%A0%E5%BC%BA-05-DUBBO-Zookeeper-2.assets/image-20201225214505292.png" alt="image-20201225214505292"></p><h4 id="2）导入工程"><a href="#2）导入工程" class="headerlink" title="2）导入工程"></a>2）导入工程</h4><p>将在工程目录下的 <code>dubbo-admin-master</code> 导入到IDEA中：</p><p><img src="%E5%B0%B1%E4%B8%9A%E6%8A%80%E6%9C%AF%E5%8A%A0%E5%BC%BA-05-DUBBO-Zookeeper-2.assets/image-20201225214529395.png" alt="image-20201225214529395"></p><p><img src="%E5%B0%B1%E4%B8%9A%E6%8A%80%E6%9C%AF%E5%8A%A0%E5%BC%BA-05-DUBBO-Zookeeper-2.assets/image-20201225214633695.png" alt="image-20201225214633695"></p><p><img src="%E5%B0%B1%E4%B8%9A%E6%8A%80%E6%9C%AF%E5%8A%A0%E5%BC%BA-05-DUBBO-Zookeeper-2.assets/image-20201225214654381.png" alt="image-20201225214654381"></p><h2 id="3、DUBBO优化配置"><a href="#3、DUBBO优化配置" class="headerlink" title="3、DUBBO优化配置"></a>3、DUBBO优化配置</h2><h3 id="3-1、启动时检查"><a href="#3-1、启动时检查" class="headerlink" title="3.1、启动时检查"></a>3.1、启动时检查</h3><h4 id="1）问题"><a href="#1）问题" class="headerlink" title="1）问题"></a>1）问题</h4><ul><li>在实际的项目开发时，如果服务提供者没有启动，这个时候消费者就会报错影响项目的运行；</li><li>在项目之间如果出现服务之间相互调用，那么也会出现启动时错误</li></ul><p><img src="%E5%B0%B1%E4%B8%9A%E6%8A%80%E6%9C%AF%E5%8A%A0%E5%BC%BA-05-DUBBO-Zookeeper-2.assets/image-20201225220128072.png" alt="image-20201225220128072"></p><h4 id="2）简介"><a href="#2）简介" class="headerlink" title="2）简介"></a>2）简介</h4><p>官方文档: <a target="_blank" rel="noopener" href="http://dubbo.apache.org/zh-cn/docs/user/demos/preflight-check.html">http://dubbo.apache.org/zh-cn/docs/user/demos/preflight-check.html</a></p><ul><li>dubbo 缺省会在启动时检查依赖的服务是否可用，不可用时会抛出异常，阻止 Spring 初始化完成，以便上线时，能及早发现问题，默认 <code>check="true"</code>。</li><li>可以通过 <code>check="false"</code> 关闭检查，比如，测试时，有些服务不关心，或者出现了循环依赖，必须有一方先启动。</li><li>另外，如果你的 Spring 容器是懒加载的，或者通过 API 编程延迟引用服务，请关闭 check，否则服务临时不可用时，会抛出异常，拿到 null 引用，如果 <code>check="false"</code>，总是会返回引用，当服务恢复时，能自动连上。</li></ul><h4 id="3）使用"><a href="#3）使用" class="headerlink" title="3）使用"></a>3）使用</h4><ul><li><strong>方式一</strong>：注解中局部使用<code>@DubboReference(check=true|false)</code> ；check的默认值为<code>true</code></li></ul><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token annotation punctuation">@RestController</span>
<span class="token annotation punctuation">@RequestMapping</span><span class="token punctuation">(</span><span class="token string">"/order"</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">OrderController</span> <span class="token punctuation">{</span>

    <span class="token comment">/**
     * check = false 表示启动时不检查服务是否可用
     */</span>
    <span class="token annotation punctuation">@DubboReference</span><span class="token punctuation">(</span>
            check <span class="token operator">=</span> <span class="token boolean">false</span>
    <span class="token punctuation">)</span>
    <span class="token keyword">private</span> <span class="token class-name">GoodsService</span> goodsService<span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><ul><li><strong>方式二</strong>：全局配置在<code>application.yml</code>文件中；</li></ul><ul><li><p>配置(格式一)：dubbo.reference.(包名+接口类名).check=false</p><pre class="line-numbers language-yml" data-language="yml"><code class="language-yml">...
dubbo:
  registry:
    address: zookeeper://127.0.0.1:2181
    timeout: 10000
  reference:
    com.itheima.goods.service.GoodsService:
      check: false
...<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>配置(格式二)：dubbo.consumer.check=false</p><pre class="line-numbers language-yaml" data-language="yaml"><code class="language-yaml"><span class="token comment"># 关闭全部的服务接口启动时不检查</span>
<span class="token key atrule">dubbo</span><span class="token punctuation">:</span>
  <span class="token key atrule">consumer</span><span class="token punctuation">:</span>
  	<span class="token key atrule">check</span><span class="token punctuation">:</span> <span class="token boolean important">false</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre><p><strong>注意:</strong></p><p>如果全局配置了check，局部也配置了check, dubbo会采用并且的方式得到最终的check；</p><p>​ <strong>启动时检查check = 全局的check &amp;&amp; 局部的check</strong></p></li></ul><ul><li><p>能解决什么问题？</p><pre class="line-numbers language-txt" data-language="txt"><code class="language-txt">如果在开发时候可能一个服务已依赖很多提供者，如果这个时候仅仅在开发order服务，其他的服务就必须运行起来，才能够去开发，这样可能会影响开发效率。开启false后只需要开启当前开发的服务<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre></li><li><p>到底要不要把check改成false？</p><pre class="line-numbers language-开txt" data-language="开txt"><code class="language-开txt">开发时改成false，上线时尽量改成true<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre></li><li><p>用全局配置还是局部配置，为什么？</p><pre class="line-numbers language-txt" data-language="txt"><code class="language-txt">用全局的配置；修改灵活方便<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><h3 id="3-2、结果缓存"><a href="#3-2、结果缓存" class="headerlink" title="3.2、结果缓存"></a>3.2、结果缓存</h3></li></ul><p>结果缓存，用于加速热门数据的访问速度，Dubbo 提供声明式缓存，以减少用户加缓存的工作量。</p><p><strong>缓存类型</strong></p><ul><li><code>lru</code> 基于最近最少使用原则删除多余缓存，保持最热的数据被缓存。</li><li><code>threadlocal</code> 当前线程缓存，比如一个页面渲染，用到很多 portal，每个 portal 都要去查用户信息，通过线程缓存，可以减少这种多余访问。</li><li><code>jcache</code> 与 <a target="_blank" rel="noopener" href="http://jcp.org/en/jsr/detail?id=107%27">JSR107</a> 集成，可以桥接各种缓存实现。</li></ul><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token annotation punctuation">@RequestMapping</span><span class="token punctuation">(</span><span class="token string">"/order"</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">OrderController</span> <span class="token punctuation">{</span>

    <span class="token comment">/**
     * check = false 表示启动时不检查服务是否可用
     * cache = "lru" 调用服务的所有方法时候使用 最近最少使用 淘汰策略方式删除缓存结果
     * methods 则是针对服务中的特定方法
     */</span>
    <span class="token annotation punctuation">@DubboReference</span><span class="token punctuation">(</span>
            check <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">,</span>
            <span class="token comment">//cache = "lru",</span>
            methods <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token annotation punctuation">@Method</span><span class="token punctuation">(</span>name <span class="token operator">=</span> <span class="token string">"findGoodsByOrderId"</span><span class="token punctuation">,</span> cache <span class="token operator">=</span> <span class="token string">"lru"</span><span class="token punctuation">)</span><span class="token punctuation">}</span>
    <span class="token punctuation">)</span>
    <span class="token keyword">private</span> <span class="token class-name">GoodsService</span> goodsService<span class="token punctuation">;</span>

    <span class="token annotation punctuation">@Resource</span>
    <span class="token keyword">private</span> <span class="token class-name">OrderService</span> orderService<span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><blockquote><p>不管是开发还是生产环境；一般都不开启。缓存要根据系统业务逻辑设计、处理</p></blockquote><h3 id="3-3、集群容错"><a href="#3-3、集群容错" class="headerlink" title="3.3、集群容错"></a>3.3、集群容错</h3><p>为了服务的稳定性，一般会有多个服务提供者提供服务，也即<code>服务集群</code>；而 <code>消费者</code> 在调用服务的时候如果遇到一个提供者失败之后可以再次尝试其它提供者获取服务。这也称为 <code>集群容错</code>。</p><h4 id="3-3-1、案例1"><a href="#3-3-1、案例1" class="headerlink" title="3.3.1、案例1"></a>3.3.1、案例1</h4><ul><li><strong>需求</strong></li></ul><blockquote><p>访问订单系统（order-service） <a target="_blank" rel="noopener" href="http://localhost:9200/order/1">http://localhost:9200/order/1</a> 获取商品系统（goods-service）中订单对应的商品列表；其中，在商品系统中根据订单查询商品需要耗时2000毫秒。</p><p>商品系统goods-service 提供3台集群节点服务器分别对外的服务端口为：（9100/20880）（9101/20881）（9102/20882）</p></blockquote><ul><li><strong>实现</strong></li></ul><p><strong>1、修改GoodsServiceImpl的findGoodsByOrderId方法</strong></p><p><img src="%E5%B0%B1%E4%B8%9A%E6%8A%80%E6%9C%AF%E5%8A%A0%E5%BC%BA-05-DUBBO-Zookeeper-2.assets/image-20201226112039952.png" alt="image-20201226112039952"></p><p><strong>2、部署3台goods-service集群节点</strong></p><p>修改application.yml配置文件如下：</p><p><img src="%E5%B0%B1%E4%B8%9A%E6%8A%80%E6%9C%AF%E5%8A%A0%E5%BC%BA-05-DUBBO-Zookeeper-2.assets/image-20201226112223289.png" alt="image-20201226112223289"></p><p>这时可以打开 <code>GoodsApplication</code> 启动第1台商品系统。</p><p><strong>配置其它两台商品系统启动项</strong>：</p><p><img src="%E5%B0%B1%E4%B8%9A%E6%8A%80%E6%9C%AF%E5%8A%A0%E5%BC%BA-05-DUBBO-Zookeeper-2.assets/image-20201226112508971.png" alt="image-20201226112508971"></p><p><img src="%E5%B0%B1%E4%B8%9A%E6%8A%80%E6%9C%AF%E5%8A%A0%E5%BC%BA-05-DUBBO-Zookeeper-2.assets/image-20201226112603750.png" alt="image-20201226112603750"></p><p><img src="%E5%B0%B1%E4%B8%9A%E6%8A%80%E6%9C%AF%E5%8A%A0%E5%BC%BA-05-DUBBO-Zookeeper-2.assets/image-20201226112706216.png" alt="image-20201226112706216"></p><p>重复刚才的操作，并修改对应名称和启动参数。</p><p><img src="%E5%B0%B1%E4%B8%9A%E6%8A%80%E6%9C%AF%E5%8A%A0%E5%BC%BA-05-DUBBO-Zookeeper-2.assets/image-20201226112758378.png" alt="image-20201226112758378"></p><p><strong>3、测试</strong></p><p>a，正常启动（不要debug启动） <code>GoodsApplication</code> <code>GoodsApplication20881</code> <code>GoodsApplication20882</code></p><p>b，修改 <code>OrderController</code> 结果缓存的设置去掉；</p><p><img src="%E5%B0%B1%E4%B8%9A%E6%8A%80%E6%9C%AF%E5%8A%A0%E5%BC%BA-05-DUBBO-Zookeeper-2.assets/image-20201226114207165.png" alt="image-20201226114207165"></p><p>c，启动 <code>OrderApplication</code></p><p><img src="%E5%B0%B1%E4%B8%9A%E6%8A%80%E6%9C%AF%E5%8A%A0%E5%BC%BA-05-DUBBO-Zookeeper-2.assets/image-20201226114124980.png" alt="image-20201226114124980"></p><p>f，访问 <a target="_blank" rel="noopener" href="http://localhost:9200/order/1%EF%BC%9B%E5%86%8D%E6%9F%A5%E7%9C%8B%E5%90%8E%E5%8F%B0%E4%B8%AD%E7%9A%843%E5%8F%B0%E5%95%86%E5%93%81%E7%B3%BB%E7%BB%9F%E6%8E%A7%E5%88%B6%E5%8F%B0%E7%9A%84%E8%BE%93%E5%87%BA%E6%83%85%E5%86%B5%E3%80%82">http://localhost:9200/order/1；再查看后台中的3台商品系统控制台的输出情况。</a></p><blockquote><p>发现在调用商品系统服务的时候，如果失败的话；那么会尝试从3台服务中都去获取服务；直到获取到数据或者所有服务器都访问失败。这是DUBBO默认的集群容错策略：failover 适用于读取数据。</p><p>如果对应的服务是写数据失败进行重试，会引发什么问题呢？</p></blockquote><h4 id="3-3-2、案例2"><a href="#3-3-2、案例2" class="headerlink" title="3.3.2、案例2"></a>3.3.2、案例2</h4><blockquote><p>访问订单系统（order-service） <a target="_blank" rel="noopener" href="http://localhost:9200/order/add">http://localhost:9200/order/add</a> 生成订单；同时对商品系统（goods-service）中商品库存进行扣减；其中，在商品系统中扣减库存商品需要耗时2000毫秒。</p></blockquote><p><strong>分析</strong>：因为DUBBO远程服务调用的超时时间是1000毫秒，重试2次；像上述的需求，如果按照默认方式执行因为扣减库存时间超时，那么会进行重试调用其它服务，这样在3台商品服务系统中都尝试扣减库存，引起库存扣减异常。</p><p><strong>解决方法</strong>：</p><p>方式一、设置DUBBO引用服务的超时时间；如：</p><p><img src="%E5%B0%B1%E4%B8%9A%E6%8A%80%E6%9C%AF%E5%8A%A0%E5%BC%BA-05-DUBBO-Zookeeper-2.assets/image-20201226115728281.png" alt="image-20201226115728281"></p><p>方式二、设置DUBBO的集群容错策略为：<code>failfast</code> 一旦失败则不再重试</p><p><img src="%E5%B0%B1%E4%B8%9A%E6%8A%80%E6%9C%AF%E5%8A%A0%E5%BC%BA-05-DUBBO-Zookeeper-2.assets/image-20201226115833609.png" alt="image-20201226115833609"></p><p>修改容错方式之后；重启 <code>OrderApplication</code> 访问 <a target="_blank" rel="noopener" href="http://localhost:9200/order/add">http://localhost:9200/order/add</a> 查看可以发现，一旦商品服务调用失败，即使有其它的同类商品服务也不会进行重试。</p><h4 id="3-3-3、容错说明"><a href="#3-3-3、容错说明" class="headerlink" title="3.3.3、容错说明"></a>3.3.3、容错说明</h4><p><strong>在集群调用失败时，Dubbo默认提供了6种集群容错模式，缺省为 failover 重试。</strong></p><ul><li>Failover Cluster(默认): 失败自动切换，当出现失败，重试其它服务器。通常用于读操作，但重试会带来更长延迟。可通过<code>retries="2"</code> 来设置重试次数(不包含第一次)。</li><li>Failfast Cluster: 快速失败，只发起一次调用，失败立即报错。通常用于非幂等性的写操作，比如新增记录。</li><li>Failsafe Cluster: 失败安全，出现异常时，直接忽略。通常用于写入审计日志等操作。</li><li>Failback Cluster: 失败自动恢复，后台记录失败请求，<strong>定时重发</strong>。通常用于消息通知操作。</li><li>Forking Cluster: 并行调用多个服务器，只要一个成功即返回。通常用于实时性要求较高的读操作，但需要浪费更多服务资源。可通过 <code>forks="2"</code> 来设置最大并行数。</li><li>Broadcast Cluster: 广播调用所有提供者，逐个调用，任意一台报错则报错。通常用于通知所有提供者更新缓存或日志等本地资源信息。(暂不支持)</li></ul><p><img src="%E5%B0%B1%E4%B8%9A%E6%8A%80%E6%9C%AF%E5%8A%A0%E5%BC%BA-05-DUBBO-Zookeeper-2.assets/image-20201225231520135.png" alt="image-20201225231520135"></p><p>各节点关系：</p><ul><li>这里的 <code>Invoker</code> 是 <code>Provider</code> 的一个可调用 <code>Service</code> 的抽象，<code>Invoker</code> 封装了 <code>Provider</code> 地址及 <code>Service</code> 接口信息</li><li><code>Directory</code> 代表多个 <code>Invoker</code>，可以把它看成 <code>List</code> ，但与 <code>List</code> 不同的是，它的值可能是动态变化的，比如注册中心推送变更</li><li><code>Cluster</code> 将 <code>Directory</code> 中的多个 <code>Invoker</code> 伪装成一个 <code>Invoker</code>，对上层透明，伪装过程包含了容错逻辑，调用失败后，重试另一个</li><li><code>Router</code> 负责从多个 <code>Invoker</code> 中按路由规则选出子集，比如读写分离，应用隔离等</li><li><code>LoadBalance</code> 负责从多个 <code>Invoker</code> 中选出具体的一个用于本次调用，选的过程包含了负载均衡算法，调用失败后，需要重选</li></ul><blockquote><p>如何选择容错模式？</p><p>failover —— 读操作；可以重试<br>failfast —— 写操作；只发起一次调用，失败立即报错</p></blockquote><h3 id="3-4、服务降级"><a href="#3-4、服务降级" class="headerlink" title="3.4、服务降级"></a>3.4、服务降级</h3><h4 id="3-4-1、Mock本地伪装"><a href="#3-4-1、Mock本地伪装" class="headerlink" title="3.4.1、Mock本地伪装"></a>3.4.1、Mock本地伪装</h4><p>本地伪装 <a target="_blank" rel="noopener" href="http://dubbo.apache.org/zh/docs/v2.7/user/examples/local-mock/#fn:1">1</a> 通常用于服务降级，比如订单下单的时候，当商品服务提供方全部挂掉后，客户端不抛出异常，而是通过 Mock 数据返回失败。</p><p><strong>1）代码配置</strong></p><p>假设在已知 商品服务 未开发好的情况下，订单需要开发测试；那么可以在代码上配置如下：</p><ul><li>mock=force:return null（<strong>屏蔽,熔断</strong>）表示<strong>消费方</strong>对该服务的方法调用都直接返回 null 值，<strong>不发起远程调用</strong>。用来屏蔽不重要服务不可用时对调用方的影响。</li></ul><p><img src="%E5%B0%B1%E4%B8%9A%E6%8A%80%E6%9C%AF%E5%8A%A0%E5%BC%BA-05-DUBBO-Zookeeper-2.assets/image-20201226122210843.png" alt="image-20201226122210843"></p><ul><li>mock=fail:return null（<strong>容错,降级</strong>）表示<strong>消费方</strong>对该服务的方法调用在失败后，再返回 null 值，不抛异常。用来容忍不重要服务不稳定时对调用方的影响。</li></ul><p><img src="%E5%B0%B1%E4%B8%9A%E6%8A%80%E6%9C%AF%E5%8A%A0%E5%BC%BA-05-DUBBO-Zookeeper-2.assets/image-20201226122251180.png" alt="image-20201226122251180"></p><p><strong>2）控制台设置</strong></p><p>访问： <a target="_blank" rel="noopener" href="http://localhost:7001/governance/consumers">http://localhost:7001/governance/consumers</a></p><p><img src="%E5%B0%B1%E4%B8%9A%E6%8A%80%E6%9C%AF%E5%8A%A0%E5%BC%BA-05-DUBBO-Zookeeper-2.assets/image-20201226173332734.png" alt="image-20201226173332734"></p><p>屏蔽效果（熔断）：</p><p><img src="%E5%B0%B1%E4%B8%9A%E6%8A%80%E6%9C%AF%E5%8A%A0%E5%BC%BA-05-DUBBO-Zookeeper-2.assets/image-20201226173541048.png" alt="image-20201226173541048"></p><p>容错效果（降级）：</p><p><img src="%E5%B0%B1%E4%B8%9A%E6%8A%80%E6%9C%AF%E5%8A%A0%E5%BC%BA-05-DUBBO-Zookeeper-2.assets/image-20201226173624847.png" alt="image-20201226173624847"></p><blockquote><p>屏蔽: 屏蔽后，将不发起远程调用，直接在客户端返回空对象<br>容错: 容错后，当远程调用失败时，返回空对象。</p></blockquote><h4 id="3-4-2、整合Hystrix"><a href="#3-4-2、整合Hystrix" class="headerlink" title="3.4.2、整合Hystrix"></a>3.4.2、整合Hystrix</h4><p>DUBBO中也可以使用 <code>Hystrix</code> 进行熔断；具体配置步骤如下：</p><p>1）添加依赖</p><pre class="line-numbers language-xml" data-language="xml"><code class="language-xml"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>org.springframework.cloud<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>spring-cloud-starter-netflix-hystrix<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>version</span><span class="token punctuation">&gt;</span></span>2.2.6.RELEASE<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>version</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>2）配置</p><p>a、在 <code>OrderApplication</code> 启动引导类中添加 <code>@EnableCircuitBreaker</code> 注解</p><p><img src="%E5%B0%B1%E4%B8%9A%E6%8A%80%E6%9C%AF%E5%8A%A0%E5%BC%BA-05-DUBBO-Zookeeper-2.assets/image-20201226173953338.png" alt="image-20201226173953338"></p><p>b、在 <code>OrderController</code> 中配置如下：</p><p><img src="%E5%B0%B1%E4%B8%9A%E6%8A%80%E6%9C%AF%E5%8A%A0%E5%BC%BA-05-DUBBO-Zookeeper-2.assets/image-20201226174212538.png" alt="image-20201226174212538"></p><p>3）测试</p><p>重新启动 <code>OrderApplication</code> 访问：<a target="_blank" rel="noopener" href="http://localhost:9200/order/1">http://localhost:9200/order/1</a></p><p><img src="%E5%B0%B1%E4%B8%9A%E6%8A%80%E6%9C%AF%E5%8A%A0%E5%BC%BA-05-DUBBO-Zookeeper-2.assets/image-20201226174423596.png" alt="image-20201226174423596"></p><h3 id="3-5、负载均衡策略"><a href="#3-5、负载均衡策略" class="headerlink" title="3.5、负载均衡策略"></a>3.5、负载均衡策略</h3><p>在集群负载均衡时，Dubbo 提供了多种均衡策略，缺省为 <code>random</code> 随机调用。</p><h4 id="3-5-1、策略说明"><a href="#3-5-1、策略说明" class="headerlink" title="3.5.1、策略说明"></a>3.5.1、策略说明</h4><p><strong>Random LoadBalance</strong></p><ul><li><strong>随机</strong>，按权重设置随机概率。</li><li>在一个截面上碰撞的概率高，但调用量越大分布越均匀，而且按概率使用权重后也比较均匀，有利于动态调整提供者权重。</li></ul><p><img src="%E5%B0%B1%E4%B8%9A%E6%8A%80%E6%9C%AF%E5%8A%A0%E5%BC%BA-05-DUBBO-Zookeeper-2.assets/image-20201226182346717.png" alt="image-20201226182346717"></p><p><strong>RoundRobin LoadBalance</strong></p><ul><li><strong>轮询</strong>，按公约后的权重设置轮询比率。</li><li>存在慢的提供者累积请求的问题，比如：第二台机器很慢，但没挂，当请求调到第二台时就卡在那，久而久之，所有请求都卡在调到第二台上。</li></ul><p><img src="%E5%B0%B1%E4%B8%9A%E6%8A%80%E6%9C%AF%E5%8A%A0%E5%BC%BA-05-DUBBO-Zookeeper-2.assets/image-20201226182453983.png" alt="image-20201226182453983"></p><p><strong>LeastActive LoadBalance</strong></p><ul><li><strong>最少活跃调用数</strong>，相同活跃数的随机，活跃数指调用前后计数差。</li><li>使慢的提供者收到更少请求，因为越慢的提供者的调用前后计数差会越大。</li></ul><p><img src="%E5%B0%B1%E4%B8%9A%E6%8A%80%E6%9C%AF%E5%8A%A0%E5%BC%BA-05-DUBBO-Zookeeper-2.assets/image-20201226182525381.png" alt="image-20201226182525381"></p><p><strong>ConsistentHash LoadBalance</strong></p><ul><li><strong>一致性 Hash</strong>，相同参数的请求总是发到同一提供者。</li><li>当某一台提供者挂时，原本发往该提供者的请求，基于虚拟节点，平摊到其它提供者，不会引起剧烈变动。</li><li>算法参见：<a target="_blank" rel="noopener" href="http://en.wikipedia.org/wiki/Consistent_hashing">http://en.wikipedia.org/wiki/Consistent_hashing</a></li><li>缺省只对第一个参数 Hash</li><li>缺省用 160 份虚拟节点</li></ul><p><img src="%E5%B0%B1%E4%B8%9A%E6%8A%80%E6%9C%AF%E5%8A%A0%E5%BC%BA-05-DUBBO-Zookeeper-2.assets/image-20201226182554085.png" alt="image-20201226182554085"></p><h4 id="3-5-2、案例应用"><a href="#3-5-2、案例应用" class="headerlink" title="3.5.2、案例应用"></a>3.5.2、案例应用</h4><p><strong>需求</strong>：商品服务系统goods-service中有3台服务提供者，这3台服务机器配置性能都相当。在订单服务系统order-service调用的时候希望可以轮流调用 <code>findGoodsByOrderId</code></p><p><strong>实现方式一</strong>：代码中设置负载均衡策略为：轮询</p><p><img src="%E5%B0%B1%E4%B8%9A%E6%8A%80%E6%9C%AF%E5%8A%A0%E5%BC%BA-05-DUBBO-Zookeeper-2.assets/image-20201226185110709.png" alt="image-20201226185110709"></p><p>测试时候分别访问：<a target="_blank" rel="noopener" href="http://localhost:9200/order/1">http://localhost:9200/order/1</a> 请求地址3次；然后到商品服务的服务器控制台看输出即可。</p><p><strong>实现方式二</strong>：在监控中心中设置商品服务的对应方法的负载均衡策略为：轮询</p><p><img src="%E5%B0%B1%E4%B8%9A%E6%8A%80%E6%9C%AF%E5%8A%A0%E5%BC%BA-05-DUBBO-Zookeeper-2.assets/image-20201226184449059.png" alt="image-20201226184449059"></p><p><img src="%E5%B0%B1%E4%B8%9A%E6%8A%80%E6%9C%AF%E5%8A%A0%E5%BC%BA-05-DUBBO-Zookeeper-2.assets/image-20201226184726027.png" alt="image-20201226184726027"></p><p><img src="%E5%B0%B1%E4%B8%9A%E6%8A%80%E6%9C%AF%E5%8A%A0%E5%BC%BA-05-DUBBO-Zookeeper-2.assets/image-20201226184740153.png" alt="image-20201226184740153"></p><h3 id="3-6、灰度发布"><a href="#3-6、灰度发布" class="headerlink" title="3.6、灰度发布"></a>3.6、灰度发布</h3><p><strong>灰度发布</strong>：是指在黑与白之间，能够平滑过渡的一种发布方式。在其上可以进行A/B testing，即让一部分用户继续用产品特性A，一部分用户开始用产品特性B，如果用户对B没有什么反对意见，那么逐步扩大范围，把所有用户都迁移到B上面来。</p><p>在 Dubbo 中为同一个服务配置多个版本当一个接口实现，出现不兼容升级时，可以用版本号过渡，版本号不同的服务相互间不引用。</p><p>可以按照以下的步骤进行版本迁移：</p><ol><li>在低压力时间段，先升级一半提供者为新版本</li><li>再将所有消费者升级为新版本</li><li>然后将剩下的一半提供者升级为新版本</li></ol><p><strong>案例需求</strong>：</p><blockquote><p>将商品服务goods-service发布了新版的GoodsService，但是订单系统order-service在使用中不能停止等待商品服务的更新。所以需要保留一部分旧版的商品服务，给订单系统调用使用。同时也需要在订单系统可以使用到最新的商品服务。</p></blockquote><p><strong>分析</strong>：</p><p><img src="%E5%B0%B1%E4%B8%9A%E6%8A%80%E6%9C%AF%E5%8A%A0%E5%BC%BA-05-DUBBO-Zookeeper-2.assets/image-20201226191244872.png" alt="image-20201226191244872"></p><p><strong>实现</strong>：</p><p>1）修改 <code>商品服务goods-service</code> 的配置文件添加版本配置信息<code>1.0</code>如下：</p><p><img src="%E5%B0%B1%E4%B8%9A%E6%8A%80%E6%9C%AF%E5%8A%A0%E5%BC%BA-05-DUBBO-Zookeeper-2.assets/image-20201226192950328.png" alt="image-20201226192950328"></p><p>2）非debug 启动 <code>GoodsAppliaction</code></p><p><img src="%E5%B0%B1%E4%B8%9A%E6%8A%80%E6%9C%AF%E5%8A%A0%E5%BC%BA-05-DUBBO-Zookeeper-2.assets/image-20201226193037516.png" alt="image-20201226193037516"></p><p>3）修改 <code>商品服务goods-service</code> 的配置文件添加版本配置信息如<code>2.0</code>下：</p><p><img src="%E5%B0%B1%E4%B8%9A%E6%8A%80%E6%9C%AF%E5%8A%A0%E5%BC%BA-05-DUBBO-Zookeeper-2.assets/image-20201226193110872.png" alt="image-20201226193110872"></p><p>4）非debug 启动 <code>GoodsAppliaction20881</code></p><p><img src="%E5%B0%B1%E4%B8%9A%E6%8A%80%E6%9C%AF%E5%8A%A0%E5%BC%BA-05-DUBBO-Zookeeper-2.assets/image-20201226193201098.png" alt="image-20201226193201098"></p><p>5）修改 <code>订单服务order-service</code>的配置文件添加版本配置信息如下：</p><p><img src="%E5%B0%B1%E4%B8%9A%E6%8A%80%E6%9C%AF%E5%8A%A0%E5%BC%BA-05-DUBBO-Zookeeper-2.assets/image-20201226193251540.png" alt="image-20201226193251540"></p><p>6） 启动 <code>OrderAppliaction</code></p><p><img src="%E5%B0%B1%E4%B8%9A%E6%8A%80%E6%9C%AF%E5%8A%A0%E5%BC%BA-05-DUBBO-Zookeeper-2.assets/image-20201226193351856.png" alt="image-20201226193351856"></p><p>可以从访问中看出；订单服务只会调用版本号对应的服务，同样的服务可通过不同的版本号区分开来；从而实现灰度发布。</p><h2 id="4、Zookeeper集群"><a href="#4、Zookeeper集群" class="headerlink" title="4、Zookeeper集群"></a>4、Zookeeper集群</h2><h3 id="4-1、搭建"><a href="#4-1、搭建" class="headerlink" title="4.1、搭建"></a>4.1、搭建</h3><p>Zookeeper单机版的安装搭建可以参考《Linux安装zookeeper(单机版).md》</p><p>Zookeeper集群版的安装搭建可以参考《Linux安装zookeeper(集群版).md》</p><h3 id="4-2、应用"><a href="#4-2、应用" class="headerlink" title="4.2、应用"></a>4.2、应用</h3><h4 id="1）配置DUBBO监控中心"><a href="#1）配置DUBBO监控中心" class="headerlink" title="1）配置DUBBO监控中心"></a>1）配置DUBBO监控中心</h4><p>打开 <code>dubbo-admin-master\dubbo-admin\src\main\resources\application.properties</code> 文件；修改</p><p><code>dubbo.registry.address</code>的配置项内容为如下：</p><pre class="line-numbers language-properties" data-language="properties"><code class="language-properties"><span class="token attr-name">dubbo.registry.address</span><span class="token punctuation">=</span><span class="token attr-value">zookeeper://192.168.12.135:3181?backup=192.168.12.135:3182,192.168.12.135:3183</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p><img src="%E5%B0%B1%E4%B8%9A%E6%8A%80%E6%9C%AF%E5%8A%A0%E5%BC%BA-05-DUBBO-Zookeeper-2.assets/image-20201226194240161.png" alt="image-20201226194240161"></p><h4 id="2）配置商品服务系统"><a href="#2）配置商品服务系统" class="headerlink" title="2）配置商品服务系统"></a>2）配置商品服务系统</h4><p>打开 <code>dubbo-springboot\goods\goods-service\src\main\resources\application.yml</code> 文件；修改</p><p><code>dubbo.registry.address</code>的配置项内容为如下：</p><pre class="line-numbers language-yml" data-language="yml"><code class="language-yml"><span class="token key atrule">server</span><span class="token punctuation">:</span>
  <span class="token key atrule">port</span><span class="token punctuation">:</span> $<span class="token punctuation">{</span>port<span class="token punctuation">:</span><span class="token number">9100</span><span class="token punctuation">}</span>

<span class="token key atrule">spring</span><span class="token punctuation">:</span>
  <span class="token key atrule">application</span><span class="token punctuation">:</span>
    <span class="token key atrule">name</span><span class="token punctuation">:</span> goods<span class="token punctuation">-</span>service
<span class="token key atrule">dubbo</span><span class="token punctuation">:</span>
  <span class="token key atrule">registry</span><span class="token punctuation">:</span>
    <span class="token key atrule">address</span><span class="token punctuation">:</span> zookeeper<span class="token punctuation">:</span>//192.168.12.135<span class="token punctuation">:</span>3181<span class="token punctuation">?</span>backup=192.168.12.135<span class="token punctuation">:</span><span class="token number">3182</span><span class="token punctuation">,</span>192.168.12.135<span class="token punctuation">:</span><span class="token number">3183</span>
    <span class="token key atrule">timeout</span><span class="token punctuation">:</span> <span class="token number">10000</span>
  <span class="token key atrule">scan</span><span class="token punctuation">:</span>
    <span class="token key atrule">base-packages</span><span class="token punctuation">:</span> com.itheima.goods.service.impl
  <span class="token key atrule">protocol</span><span class="token punctuation">:</span>
    <span class="token key atrule">name</span><span class="token punctuation">:</span> dubbo
    <span class="token key atrule">port</span><span class="token punctuation">:</span> $<span class="token punctuation">{</span>dport<span class="token punctuation">:</span><span class="token number">20880</span><span class="token punctuation">}</span>
  <span class="token key atrule">provider</span><span class="token punctuation">:</span>
    <span class="token key atrule">version</span><span class="token punctuation">:</span> <span class="token number">2.0</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p><img src="%E5%B0%B1%E4%B8%9A%E6%8A%80%E6%9C%AF%E5%8A%A0%E5%BC%BA-05-DUBBO-Zookeeper-2.assets/image-20201226194527791.png" alt="image-20201226194527791"></p><h4 id="3）配置订单服务系统"><a href="#3）配置订单服务系统" class="headerlink" title="3）配置订单服务系统"></a>3）配置订单服务系统</h4><p>打开 <code>dubbo-springboot\order\order-service\src\main\resources\application.yml</code> 文件；修改</p><p><code>dubbo.registry.address</code>的配置项内容为如下：</p><pre class="line-numbers language-yml" data-language="yml"><code class="language-yml"><span class="token key atrule">server</span><span class="token punctuation">:</span>
  <span class="token key atrule">port</span><span class="token punctuation">:</span> <span class="token number">9200</span>

<span class="token key atrule">spring</span><span class="token punctuation">:</span>
  <span class="token key atrule">application</span><span class="token punctuation">:</span>
    <span class="token key atrule">name</span><span class="token punctuation">:</span> order<span class="token punctuation">-</span>service
<span class="token key atrule">dubbo</span><span class="token punctuation">:</span>
  <span class="token key atrule">registry</span><span class="token punctuation">:</span>
    <span class="token key atrule">address</span><span class="token punctuation">:</span> zookeeper<span class="token punctuation">:</span>//192.168.12.135<span class="token punctuation">:</span>3181<span class="token punctuation">?</span>backup=192.168.12.135<span class="token punctuation">:</span><span class="token number">3182</span><span class="token punctuation">,</span>192.168.12.135<span class="token punctuation">:</span><span class="token number">3183</span>
    <span class="token key atrule">timeout</span><span class="token punctuation">:</span> <span class="token number">10000</span>
  <span class="token key atrule">scan</span><span class="token punctuation">:</span>
    <span class="token key atrule">base-packages</span><span class="token punctuation">:</span> com.itheima.order.service.impl
  <span class="token key atrule">protocol</span><span class="token punctuation">:</span>
    <span class="token key atrule">name</span><span class="token punctuation">:</span> dubbo
    <span class="token key atrule">port</span><span class="token punctuation">:</span> <span class="token number">30880</span>
  <span class="token key atrule">consumer</span><span class="token punctuation">:</span>
    <span class="token key atrule">check</span><span class="token punctuation">:</span> <span class="token boolean important">false</span>
    <span class="token key atrule">version</span><span class="token punctuation">:</span> <span class="token number">2.0</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p><img src="%E5%B0%B1%E4%B8%9A%E6%8A%80%E6%9C%AF%E5%8A%A0%E5%BC%BA-05-DUBBO-Zookeeper-2.assets/image-20201226194643398.png" alt="image-20201226194643398"></p><p>可以到监控中心中查看注册中心的状态；比如注册中心的集群节点3台中，如果其中1台宕机了；也不会影响使用。</p><p><img src="%E5%B0%B1%E4%B8%9A%E6%8A%80%E6%9C%AF%E5%8A%A0%E5%BC%BA-05-DUBBO-Zookeeper-2.assets/image-20201226194812251.png" alt="image-20201226194812251"></p><h2 id="5、常见面试题"><a href="#5、常见面试题" class="headerlink" title="5、常见面试题"></a>5、常见面试题</h2><ul><li><strong>问题1</strong>：Dubbo与SpringCloud区别</li></ul><pre class="line-numbers language-none"><code class="language-none">两个没什么关联，如果硬要说区别，有以下几点:

通信方式不同: 
Dubbo使用的是RPC通信，而Spring Cloud使用的是 HTTP RESTful方式通信。
a）Dubbo底层使用Netty这样的NIO框架，基于TCP协议传输，配合Hession序列化完成RPC通信。
b）SpringCloud基于Http协议+Rest接口远程调用的通信，相对来说，Http请求会有更大的报文，占的带宽也会更多。但是REST相比RPC更为灵活，服务提供方和调用方的依赖只依靠一纸契约，不存在代码级别的强依赖，这在强调快速演化的微服务环境下，显得更为合适。

组成部分不同:
Dubbo是SOA时代的产物，它的关注点主要在于服务的调用，流量分发、流量监控和熔断。
Spring Cloud诞生于微服务架构时代，考虑的是微服务治理的方方面面，另外由于依托了Spirng、Spirng Boot的优势之上，两个框架在开始目标就不一致，Dubbo定位服务治理、Spirng Cloud是一个生态(更完善)。<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><ul><li><p><strong>问题2</strong>： Dubbo只能从注册中心获取服务吗?</p><pre class="line-numbers language-txt" data-language="txt"><code class="language-txt">不是，也可以使用直连，直连方式是不需要从注册中心获取服务。
在开发及测试环境下，经常需要绕过注册中心，只测试指定服务提供者，这时可能需要点对点直连方式。

@Reference(url = "dubbo://localhost:24567")
private IUserservice userservice;

直连方式会失去负载均衡的能力,所以不适合生产环境。<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></li><li><p><strong>问题3</strong>： Dubbo服务提供者一定要需要开启，消费者才可以开启吗?</p><pre class="line-numbers language-txt" data-language="txt"><code class="language-txt">服务提供者不一定需要开启，因为dubbo有启动时检查,如果check=false,服务提供者就不需要开启。<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre></li><li><p><strong>问题4</strong>： Dubbo默认调用服务超时时长是多少?</p><pre class="line-numbers language-txt" data-language="txt"><code class="language-txt">服务超时时长是: 1000毫秒；重试两次<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre></li><li><p><strong>问题5</strong>： Dubbo集群容错模式有哪些? 默认容错模式是什么?【重点】</p><pre class="line-numbers language-txt" data-language="txt"><code class="language-txt">Dubbo集群容错模式有6种: Failover、Failfast、Failsafe、Faillback、Forking、Broadcast
默认容错模式是: Failover(失败自动切换)<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre></li><li><p><strong>问题6</strong>： Dubbo注册中心有哪些?【重点】</p><pre class="line-numbers language-txt" data-language="txt"><code class="language-txt">Dubbo默认支持五种注册中心:
1. Multicast
2. Zookeeper(推荐)
3. Nacos
4. Redis
5. Simple<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></li><li><p><strong>问题7</strong>： Dubbo注册中心zookeeper挂掉，消费者还可以正常调用服务者吗?</p><pre class="line-numbers language-txt" data-language="txt"><code class="language-txt">可以正常调用，因为消费者从注册中心，获取服务地址后会在本地缓存。<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre></li><li><p><strong>问题8</strong>： Dubbo可以对调用结果进行缓存吗?</p><pre class="line-numbers language-txt" data-language="txt"><code class="language-txt">可以对调用结果进行缓存(默认是没有的),可以通过cache属性配置结果缓存(lru, threadlocal, jcache)<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre></li><li><p><strong>问题9</strong>： Dubbo屏蔽与熔错是什么?</p><pre class="line-numbers language-txt" data-language="txt"><code class="language-txt">屏蔽: 相当于熔断, 不发起远程调用。
     mock=force:return null

熔错: 相当于降级, 在远程调用失败时，返回null值，不抛出异常，对消费者不产生调用影响。
     mock=fail:return null<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre></li><li><p><strong>问题10</strong>： Dubbo可以整合Hystrix吗?</p><pre class="line-numbers language-txt" data-language="txt"><code class="language-txt">可以,用Hystrix框架来提供服务降级方法。<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre></li><li><p><strong>问题11</strong>： Dubbo负载均衡策略有哪些，默认负载均衡策略是什么?【重点】</p><pre class="line-numbers language-txt" data-language="txt"><code class="language-txt">负载均衡策略有4种:
1. random(随机)
2. roundrobin(轮询)
3. leastactive(最少活跃数)
4. consistanthash(一致性hash)

默认负载均衡策略是: random (随机)<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></li><li><p><strong>问题12</strong>： Dubbo注册中心zookeeper挂掉，负载均衡还有效吗?</p><pre class="line-numbers language-txt" data-language="txt"><code class="language-txt">有效。因为消费者从zookeeper注册中心获取服务地址后会在本地缓存。<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre></li><li><p><strong>问题13</strong>： Dubbo项目如何对服务升级?</p></li></ul><pre class="line-numbers language-none"><code class="language-none">使用服务提供者的版本号隔离，对服务进行灰度发布。<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre></div><hr><div class="reprint" id="reprint-statement"><div class="reprint__author"><span class="reprint-meta" style="font-weight:700"><i class="fas fa-user">文章作者:</i></span> <span class="reprint-info"><a href="/about" rel="external nofollow noreferrer">durex</a></span></div><div class="reprint__type"><span class="reprint-meta" style="font-weight:700"><i class="fas fa-link">文章链接:</i></span> <span class="reprint-info"><a href="https://chenliren9527.github.io/2021/01/28/jiu-ye-ji-zhu-jia-qiang-05-dubbo-zookeeper-2/">https://chenliren9527.github.io/2021/01/28/jiu-ye-ji-zhu-jia-qiang-05-dubbo-zookeeper-2/</a></span></div><div class="reprint__notice"><span class="reprint-meta" style="font-weight:700"><i class="fas fa-copyright">版权声明:</i></span> <span class="reprint-info">本博客所有文章除特別声明外，均采用 <a href="https://creativecommons.org/licenses/by/4.0/deed.zh" rel="external nofollow noreferrer" target="_blank">CC BY 4.0</a> 许可协议。转载请注明来源 <a href="/about" target="_blank">durex</a> !</span></div></div><script async defer>document.addEventListener("copy", function (e) {
        let toastHTML = '<span>复制成功，请遵循本文的转载规则</span><button class="btn-flat toast-action" onclick="navToReprintStatement()" style="font-size: smaller">查看</a>';
        M.toast({html: toastHTML})
      });

      function navToReprintStatement() {
        $("html, body").animate({scrollTop: $("#reprint-statement").offset().top - 80}, 800);
      }</script><div class="tag_share" style="display:block"><div class="post-meta__tag-list" style="display:inline-block"><div class="article-tag"><a href="/tags/%E7%AC%94%E8%AE%B0/"><span class="chip bg-color">笔记</span></a> <a href="/tags/%E5%B0%B1%E4%B8%9A%E6%8A%80%E6%9C%AF%E5%8A%A0%E5%BC%BA/"><span class="chip bg-color">就业技术加强</span></a> <a href="/tags/DUBBO/"><span class="chip bg-color">DUBBO</span></a> <a href="/tags/Zookeeper/"><span class="chip bg-color">Zookeeper</span></a> <a href="/tags/%E9%9B%86%E7%BE%A4/"><span class="chip bg-color">集群</span></a> <a href="/tags/%E4%BC%98%E5%8C%96/"><span class="chip bg-color">优化</span></a></div></div><div class="post_share" style="zoom:80%;width:fit-content;display:inline-block;float:right;margin:-.15rem 0"><link rel="stylesheet" href="/libs/share/css/share.min.css"><div id="article-share"><div class="social-share" data-sites="twitter,facebook,google,qq,qzone,wechat,weibo,douban,linkedin" data-wechat-qrcode-helper="<p>微信扫一扫即可分享！</p>"></div><script src="/libs/share/js/social-share.min.js"></script></div></div></div><style>#reward{margin:40px 0;text-align:center}#reward .reward-link{font-size:1.4rem;line-height:38px}#reward .btn-floating:hover{box-shadow:0 6px 12px rgba(0,0,0,.2),0 5px 15px rgba(0,0,0,.2)}#rewardModal{width:320px;height:350px}#rewardModal .reward-title{margin:15px auto;padding-bottom:5px}#rewardModal .modal-content{padding:10px}#rewardModal .close{position:absolute;right:15px;top:15px;color:rgba(0,0,0,.5);font-size:1.3rem;line-height:20px;cursor:pointer}#rewardModal .close:hover{color:#ef5350;transform:scale(1.3);-moz-transform:scale(1.3);-webkit-transform:scale(1.3);-o-transform:scale(1.3)}#rewardModal .reward-tabs{margin:0 auto;width:210px}.reward-tabs .tabs{height:38px;margin:10px auto;padding-left:0}.reward-content ul{padding-left:0!important}.reward-tabs .tabs .tab{height:38px;line-height:38px}.reward-tabs .tab a{color:#fff;background-color:#ccc}.reward-tabs .tab a:hover{background-color:#ccc;color:#fff}.reward-tabs .wechat-tab .active{color:#fff!important;background-color:#22ab38!important}.reward-tabs .alipay-tab .active{color:#fff!important;background-color:#019fe8!important}.reward-tabs .reward-img{width:210px;height:210px}</style><div id="reward"><a href="#rewardModal" class="reward-link modal-trigger btn-floating btn-medium waves-effect waves-light red">赏</a><div id="rewardModal" class="modal"><div class="modal-content"><a class="close modal-close"><i class="fas fa-times"></i></a><h4 class="reward-title">你的赏识是我前进的动力</h4><div class="reward-content"><div class="reward-tabs"><ul class="tabs row"><li class="tab col s6 alipay-tab waves-effect waves-light"><a href="#alipay">支付宝</a></li><li class="tab col s6 wechat-tab waves-effect waves-light"><a href="#wechat">微 信</a></li></ul><div id="alipay"><img src="/medias/reward/alipay.png" class="reward-img" alt="支付宝打赏二维码"></div><div id="wechat"><img src="/medias/reward/wechat.png" class="reward-img" alt="微信打赏二维码"></div></div></div></div></div></div><script>$(function(){$(".tabs").tabs()})</script></div></div><article id="prenext-posts" class="prev-next articles"><div class="row article-row"><div class="article col s12 m6" data-aos="fade-up"><div class="article-badge left-badge text-color"><i class="fas fa-chevron-left"></i> &nbsp;上一篇</div><div class="card"><a href="/2021/01/28/chang-jian-mian-shi-ti-zong-jie-05-dubbo-zookeeper/"><div class="card-image"><img src="/medias/featureimages/138.jpg" class="responsive-img" alt="常见面试题总结(05)-DUBBO&amp;Zookeeper"> <span class="card-title">常见面试题总结(05)-DUBBO&amp;Zookeeper</span></div></a><div class="card-content article-content"><div class="summary block-with-text"></div><div class="publish-info"><span class="publish-date"><i class="far fa-clock fa-fw icon-date"></i> 2021-01-28</span><span class="publish-author"><i class="fas fa-bookmark fa-fw icon-category"></i> <a href="/categories/%E5%B8%B8%E8%A7%81%E9%9D%A2%E8%AF%95%E9%A2%98%E6%80%BB%E7%BB%93/" class="post-category">常见面试题总结</a></span></div></div><div class="card-action article-tags"><a href="/tags/%E7%AC%94%E8%AE%B0/"><span class="chip bg-color">笔记</span></a> <a href="/tags/%E5%B0%B1%E4%B8%9A%E6%8A%80%E6%9C%AF%E5%8A%A0%E5%BC%BA/"><span class="chip bg-color">就业技术加强</span></a> <a href="/tags/DUBBO/"><span class="chip bg-color">DUBBO</span></a> <a href="/tags/Zookeeper/"><span class="chip bg-color">Zookeeper</span></a> <a href="/tags/%E9%9B%86%E7%BE%A4/"><span class="chip bg-color">集群</span></a> <a href="/tags/%E5%B8%B8%E8%A7%81%E9%9D%A2%E8%AF%95%E9%A2%98%E6%80%BB%E7%BB%93/"><span class="chip bg-color">常见面试题总结</span></a> <a href="/tags/%E4%BC%98%E5%8C%96/"><span class="chip bg-color">优化</span></a></div></div></div><div class="article col s12 m6" data-aos="fade-up"><div class="article-badge right-badge text-color">下一篇&nbsp;<i class="fas fa-chevron-right"></i></div><div class="card"><a href="/2021/01/28/jiu-ye-ji-zhu-jia-qiang-05-dubbo-zookeeper-1/"><div class="card-image"><img src="/medias/featureimages/136.jpg" class="responsive-img" alt="就业技术加强(05)-DUBBO&amp;Zookeeper(1)"> <span class="card-title">就业技术加强(05)-DUBBO&amp;Zookeeper(1)</span></div></a><div class="card-content article-content"><div class="summary block-with-text"></div><div class="publish-info"><span class="publish-date"><i class="far fa-clock fa-fw icon-date"></i> 2021-01-28</span><span class="publish-author"><i class="fas fa-bookmark fa-fw icon-category"></i> <a href="/categories/%E5%B0%B1%E4%B8%9A%E6%8A%80%E6%9C%AF%E5%8A%A0%E5%BC%BA/" class="post-category">就业技术加强</a></span></div></div><div class="card-action article-tags"><a href="/tags/%E7%AC%94%E8%AE%B0/"><span class="chip bg-color">笔记</span></a> <a href="/tags/%E5%B0%B1%E4%B8%9A%E6%8A%80%E6%9C%AF%E5%8A%A0%E5%BC%BA/"><span class="chip bg-color">就业技术加强</span></a> <a href="/tags/DUBBO/"><span class="chip bg-color">DUBBO</span></a> <a href="/tags/Zookeeper/"><span class="chip bg-color">Zookeeper</span></a> <a href="/tags/%E9%9B%86%E7%BE%A4/"><span class="chip bg-color">集群</span></a></div></div></div></div></article></div><script src="/libs/codeBlock/codeBlockFuction.js"></script><script src="/libs/codeBlock/codeLang.js"></script><script src="/libs/codeBlock/codeCopy.js"></script><script src="/libs/codeBlock/codeShrink.js"></script></div><div id="toc-aside" class="expanded col l3 hide-on-med-and-down"><div class="toc-widget card" style="background-color:#fff"><div class="toc-title"><i class="far fa-list-alt"></i>&nbsp;&nbsp;目录</div><div id="toc-content"></div></div></div></div><div id="floating-toc-btn" class="hide-on-med-and-down"><a class="btn-floating btn-large bg-color"><i class="fas fa-list-ul"></i></a></div><script src="/libs/tocbot/tocbot.min.js"></script><script>$(function () {
        tocbot.init({
            tocSelector: '#toc-content',
            contentSelector: '#articleContent',
            headingsOffset: -($(window).height() * 0.4 - 45),
            collapseDepth: Number('0'),
            headingSelector: 'h2, h3, h4'
        });

        // Set scroll toc fixed.
        let tocHeight = parseInt($(window).height() * 0.4 - 64);
        let $tocWidget = $('.toc-widget');
        $(window).scroll(function () {
            let scroll = $(window).scrollTop();
            /* add post toc fixed. */
            if (scroll > tocHeight) {
                $tocWidget.addClass('toc-fixed');
            } else {
                $tocWidget.removeClass('toc-fixed');
            }
        });

        
        /* 修复文章卡片 div 的宽度. */
        let fixPostCardWidth = function (srcId, targetId) {
            let srcDiv = $('#' + srcId);
            if (srcDiv.length === 0) {
                return;
            }

            let w = srcDiv.width();
            if (w >= 450) {
                w = w + 21;
            } else if (w >= 350 && w < 450) {
                w = w + 18;
            } else if (w >= 300 && w < 350) {
                w = w + 16;
            } else {
                w = w + 14;
            }
            $('#' + targetId).width(w);
        };

        // 切换TOC目录展开收缩的相关操作.
        const expandedClass = 'expanded';
        let $tocAside = $('#toc-aside');
        let $mainContent = $('#main-content');
        $('#floating-toc-btn .btn-floating').click(function () {
            if ($tocAside.hasClass(expandedClass)) {
                $tocAside.removeClass(expandedClass).hide();
                $mainContent.removeClass('l9');
            } else {
                $tocAside.addClass(expandedClass).show();
                $mainContent.addClass('l9');
            }
            fixPostCardWidth('artDetail', 'prenext-posts');
        });
        
    });</script></main><footer class="page-footer bg-color"><div class="container row center-align" style="margin-bottom:15px!important"><div class="col s12 m8 l8 copy-right">Copyright&nbsp;&copy; <span id="year">2021-2023</span> <a href="/about" target="_blank">durex</a> |&nbsp;Powered by&nbsp;<a href="https://hexo.io/" target="_blank">Hexo</a> |&nbsp;Theme&nbsp;<a href="https://github.com/blinkfox/hexo-theme-matery" target="_blank">Matery</a><br>&nbsp;<i class="fas fa-chart-area"></i>&nbsp;站点总字数:&nbsp;<span class="white-color">932k</span> <span id="busuanzi_container_site_pv">&nbsp;|&nbsp;<i class="far fa-eye"></i>&nbsp;总访问量:&nbsp;<span id="busuanzi_value_site_pv" class="white-color"></span></span> <span id="busuanzi_container_site_uv">&nbsp;|&nbsp;<i class="fas fa-users"></i>&nbsp;总访问人数:&nbsp;<span id="busuanzi_value_site_uv" class="white-color"></span></span><br><span id="sitetime">Loading ...</span><script>var calcSiteTime=function(){var e=new Date,t="2021",n=e.getFullYear(),i=e.getMonth()+1,a=e.getDate(),r=e.getHours(),s=e.getMinutes(),o=e.getSeconds(),g=Date.UTC(t,"1","08","0","0","0"),d=Date.UTC(n,i,a,r,s,o)-g,m=Math.floor(d/31536e6),l=Math.floor(d/864e5-365*m);if(t===String(n)){document.getElementById("year").innerHTML=n;var c="This site has been running for "+l+" days";c="本站已运行 "+l+" 天",document.getElementById("sitetime").innerHTML=c}else{document.getElementById("year").innerHTML=t+" - "+n;var u="This site has been running for "+m+" years and "+l+" days";u="本站已运行 "+m+" 年 "+l+" 天",document.getElementById("sitetime").innerHTML=u}};calcSiteTime()</script><br></div><div class="col s12 m4 l4 social-link social-statis"><a href="/atom.xml" class="tooltipped" target="_blank" data-tooltip="RSS 订阅" data-position="top" data-delay="50"><i class="fas fa-rss"></i></a></div></div></footer><div class="progress-bar"></div><div id="searchModal" class="modal"><div class="modal-content"><div class="search-header"><span class="title"><i class="fas fa-search"></i> &nbsp;&nbsp;搜索</span> <input type="search" id="searchInput" name="s" placeholder="请输入搜索的关键字" class="search-input"></div><div id="searchResult"></div></div></div><script>$(function(){!function(t,a,s){"use strict";$.ajax({url:t,dataType:"xml",success:function(t){var e=$("entry",t).map(function(){return{title:$("title",this).text(),content:$("content",this).text(),url:$("url",this).text()}}).get(),r=document.getElementById(a),n=document.getElementById(s);r.addEventListener("input",function(){var f='<ul class="search-result-list">',m=this.value.trim().toLowerCase().split(/[\s\-]+/);n.innerHTML="",this.value.trim().length<=0||(e.forEach(function(t){var r=!0,n=t.title.trim().toLowerCase(),a=t.content.trim().replace(/<[^>]+>/g,"").toLowerCase(),e=t.url;e=0===e.indexOf("/")?t.url:"/"+e;var s=-1,i=-1,l=-1;if(""!==n&&""!==a&&m.forEach(function(t,e){s=n.indexOf(t),i=a.indexOf(t),s<0&&i<0?r=!1:(i<0&&(i=0),0===e&&(l=i))}),r){f+="<li><a href='"+e+"' class='search-result-title'>"+n+"</a>";var c=t.content.trim().replace(/<[^>]+>/g,"");if(0<=l){var u=l-20,o=l+80;u<0&&(u=0),0===u&&(o=100),o>c.length&&(o=c.length);var h=c.substr(u,o);m.forEach(function(t){var e=new RegExp(t,"gi");h=h.replace(e,'<em class="search-keyword">'+t+"</em>")}),f+='<p class="search-result">'+h+"...</p>"}f+="</li>"}}),f+="</ul>",n.innerHTML=f)})}})}("/search.xml","searchInput","searchResult")})</script><div id="backTop" class="top-scroll"><a class="btn-floating btn-large waves-effect waves-light" href="#!"><i class="fas fa-arrow-up"></i></a></div><script src="/libs/materialize/materialize.min.js"></script><script src="/libs/masonry/masonry.pkgd.min.js"></script><script src="/libs/aos/aos.js"></script><script src="/libs/scrollprogress/scrollProgress.min.js"></script><script src="/libs/lightGallery/js/lightgallery-all.min.js"></script><script src="/js/matery.js"></script><script>var windowWidth=$(window).width();768<windowWidth&&document.write('<script type="text/javascript" src="/libs/others/sakura.js"><\/script>')</script><script>var windowWidth=$(window).width();768<windowWidth&&document.write('<script type="text/javascript" src="/libs/others/star.js"><\/script>')</script><script src="https://ssl.captcha.qq.com/TCaptcha.js"></script><script src="/libs/others/TencentCaptcha.js"></script><button id="TencentCaptcha" data-appid="xxxxxxxxxx" data-cbfn="callback" type="button" hidden></button><script>!function(){var t=document.createElement("script"),e=window.location.protocol.split(":")[0];t.src="https"===e?"https://zz.bdstatic.com/linksubmit/push.js":"http://push.zhanzhang.baidu.com/push.js";var s=document.getElementsByTagName("script")[0];s.parentNode.insertBefore(t,s)}()</script><script src="/libs/others/clicklove.js" async></script><script async src="/libs/others/busuanzi.pure.mini.js"></script><script src="/libs/instantpage/instantpage.js" type="module"></script></body></html>