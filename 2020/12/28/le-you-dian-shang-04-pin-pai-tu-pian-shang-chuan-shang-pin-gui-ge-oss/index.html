<!DOCTYPE HTML><html lang="zh-CN"><head><meta charset="utf-8"><meta name="keywords" content="乐优电商(04)-品牌图片上传&amp;商品规格【OSS】, 薛定谔的腿毛"><meta name="description" content="01、课程目标
实现OSS文件上传
了解商品规格数据结构设计思路
实现商品规格查询

02、图片上传客户端：上传文件插件说明回顾页面上传图片三要素：
1）必须是post请求
2）必须是多部件类型form表单（type=”multipart/"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width,initial-scale=1,user-scalable=no"><meta name="renderer" content="webkit|ie-stand|ie-comp"><meta name="mobile-web-app-capable" content="yes"><meta name="format-detection" content="telephone=no"><meta name="apple-mobile-web-app-capable" content="yes"><meta name="apple-mobile-web-app-status-bar-style" content="black-translucent"><meta name="referrer" content="no-referrer-when-downgrade"><title>乐优电商(04)-品牌图片上传&amp;商品规格【OSS】 | 薛定谔的腿毛</title><link rel="icon" type="image/png" href="/favicon.png"><link rel="stylesheet" href="/libs/awesome/css/all.min.css"><link rel="stylesheet" href="/libs/materialize/materialize.min.css"><link rel="stylesheet" href="/libs/aos/aos.css"><link rel="stylesheet" href="/libs/animate/animate.min.css"><link rel="stylesheet" href="/libs/lightGallery/css/lightgallery.min.css"><link rel="stylesheet" href="/css/matery.css"><link rel="stylesheet" href="/css/my.css"><script src="/libs/jquery/jquery-3.6.0.min.js"></script><meta name="generator" content="Hexo 5.3.0"><style>.github-emoji{position:relative;display:inline-block;width:1.2em;min-height:1.2em;overflow:hidden;vertical-align:top;color:transparent}.github-emoji>span{position:relative;z-index:10}.github-emoji .fancybox,.github-emoji img{margin:0!important;padding:0!important;border:none!important;outline:0!important;text-decoration:none!important;user-select:none!important;cursor:auto!important}.github-emoji img{height:1.2em!important;width:1.2em!important;position:absolute!important;left:50%!important;top:50%!important;transform:translate(-50%,-50%)!important;user-select:none!important;cursor:auto!important}.github-emoji-fallback{color:inherit}.github-emoji-fallback img{opacity:0!important}</style><link rel="alternate" href="/atom.xml" title="薛定谔的腿毛" type="application/atom+xml"></head><body><header class="navbar-fixed"><nav id="headNav" class="bg-color nav-transparent"><div id="navContainer" class="nav-wrapper container"><div class="brand-logo"><a href="/" class="waves-effect waves-light"><img src="/medias/logo.png" class="logo-img" alt="LOGO"> <span class="logo-span">薛定谔的腿毛</span></a></div><a href="#" data-target="mobile-nav" class="sidenav-trigger button-collapse"><i class="fas fa-bars"></i></a><ul class="right nav-menu"><li class="hide-on-med-and-down nav-item"><a href="/" class="waves-effect waves-light"><i class="fas fa-home" style="zoom:.6"></i> <span>首页</span></a></li><li class="hide-on-med-and-down nav-item"><a href="/tags" class="waves-effect waves-light"><i class="fas fa-tags" style="zoom:.6"></i> <span>标签</span></a></li><li class="hide-on-med-and-down nav-item"><a href="/categories" class="waves-effect waves-light"><i class="fas fa-bookmark" style="zoom:.6"></i> <span>分类</span></a></li><li class="hide-on-med-and-down nav-item"><a href="/archives" class="waves-effect waves-light"><i class="fas fa-archive" style="zoom:.6"></i> <span>归档</span></a></li><li class="hide-on-med-and-down nav-item"><a href="/about" class="waves-effect waves-light"><i class="fas fa-user-circle" style="zoom:.6"></i> <span>关于</span></a></li><li><a href="#searchModal" class="modal-trigger waves-effect waves-light"><i id="searchIcon" class="fas fa-search" title="搜索" style="zoom:.85"></i></a></li></ul><div id="mobile-nav" class="side-nav sidenav"><div class="mobile-head bg-color"><img src="/medias/logo.png" class="logo-img circle responsive-img"><div class="logo-name">薛定谔的腿毛</div><div class="logo-desc">Never really desperate, only the lost of the soul.</div></div><ul class="menu-list mobile-menu-list"><li class="m-nav-item"><a href="/" class="waves-effect waves-light"><i class="fa-fw fas fa-home"></i> 首页</a></li><li class="m-nav-item"><a href="/tags" class="waves-effect waves-light"><i class="fa-fw fas fa-tags"></i> 标签</a></li><li class="m-nav-item"><a href="/categories" class="waves-effect waves-light"><i class="fa-fw fas fa-bookmark"></i> 分类</a></li><li class="m-nav-item"><a href="/archives" class="waves-effect waves-light"><i class="fa-fw fas fa-archive"></i> 归档</a></li><li class="m-nav-item"><a href="/about" class="waves-effect waves-light"><i class="fa-fw fas fa-user-circle"></i> 关于</a></li></ul></div></div></nav></header><script src="/libs/cryptojs/crypto-js.min.js"></script><script>(function() {
        let pwd = '';
        if (pwd && pwd.length > 0) {
            if (pwd !== CryptoJS.SHA256(prompt('请输入访问本文章的密码')).toString(CryptoJS.enc.Hex)) {
                alert('密码错误，将返回主页！');
                location.href = '/';
            }
        }
    })();</script><div class="bg-cover pd-header post-cover" style="background-image:url(/medias/featureimages/157.jpg)"><div class="container" style="right:0;left:0"><div class="row"><div class="col s12 m12 l12"><div class="brand"><h1 class="description center-align post-title">乐优电商(04)-品牌图片上传&amp;商品规格【OSS】</h1></div></div></div></div></div><main class="post-container content"><link rel="stylesheet" href="/libs/tocbot/tocbot.css"><style>#articleContent h1::before,#articleContent h2::before,#articleContent h3::before,#articleContent h4::before,#articleContent h5::before,#articleContent h6::before{display:block;content:" ";height:100px;margin-top:-100px;visibility:hidden}#articleContent :focus{outline:0}.toc-fixed{position:fixed;top:64px}.toc-widget{width:345px;padding-left:20px}.toc-widget .toc-title{padding:35px 0 15px 17px;font-size:1.5rem;font-weight:700;line-height:1.5rem}.toc-widget ol{padding:0;list-style:none}#toc-content{padding-bottom:30px;overflow:auto}#toc-content ol{padding-left:10px}#toc-content ol li{padding-left:10px}#toc-content .toc-link:hover{color:#42b983;font-weight:700;text-decoration:underline}#toc-content .toc-link::before{background-color:transparent;max-height:25px;position:absolute;right:23.5vw;display:block}#toc-content .is-active-link{color:#42b983}#floating-toc-btn{position:fixed;right:15px;bottom:76px;padding-top:15px;margin-bottom:0;z-index:998}#floating-toc-btn .btn-floating{width:48px;height:48px}#floating-toc-btn .btn-floating i{line-height:48px;font-size:1.4rem}</style><div class="row"><div id="main-content" class="col s12 m12 l9"><div id="artDetail"><div class="card"><div class="card-content article-info"><div class="row tag-cate"><div class="col s7"><div class="article-tag"><a href="/tags/%E7%AC%94%E8%AE%B0/"><span class="chip bg-color">笔记</span></a> <a href="/tags/%E9%A1%B9%E7%9B%AE%E5%AE%9E%E6%88%98%E4%BA%8C/"><span class="chip bg-color">项目实战二</span></a> <a href="/tags/springcloud/"><span class="chip bg-color">springcloud</span></a> <a href="/tags/%E5%BE%AE%E6%9C%8D%E5%8A%A1/"><span class="chip bg-color">微服务</span></a> <a href="/tags/%E5%9B%BE%E7%89%87%E4%B8%8A%E4%BC%A0/"><span class="chip bg-color">图片上传</span></a> <a href="/tags/OSS/"><span class="chip bg-color">OSS</span></a> <a href="/tags/%E9%98%BF%E9%87%8C%E4%BA%91/"><span class="chip bg-color">阿里云</span></a></div></div><div class="col s5 right-align"><div class="post-cate"><i class="fas fa-bookmark fa-fw icon-category"></i> <a href="/categories/%E9%A1%B9%E7%9B%AE%E5%AE%9E%E6%88%98%E4%BA%8C/" class="post-category">项目实战二</a></div></div></div><div class="post-info"><div class="post-date info-break-policy"><i class="far fa-calendar-minus fa-fw"></i> 发布日期:&nbsp;&nbsp; 2020-12-28</div><div class="post-date info-break-policy"><i class="far fa-calendar-check fa-fw"></i> 更新日期:&nbsp;&nbsp; 2023-10-15</div><div class="info-break-policy"><i class="far fa-file-word fa-fw"></i> 文章字数:&nbsp;&nbsp; 9.7k</div><div class="info-break-policy"><i class="far fa-clock fa-fw"></i> 阅读时长:&nbsp;&nbsp; 39 分</div><div id="busuanzi_container_page_pv" class="info-break-policy"><i class="far fa-eye fa-fw"></i> 阅读次数:&nbsp;&nbsp;<span id="busuanzi_value_page_pv"></span></div></div></div><hr class="clearfix"><link rel="stylesheet" href="/libs/prism/prism.css"><style>code[class*=language-],pre[class*=language-]{white-space:pre-wrap!important}</style><div class="card-content article-card-content"><div id="articleContent"><h2 id="01、课程目标"><a href="#01、课程目标" class="headerlink" title="01、课程目标"></a>01、课程目标</h2><ul><li>实现OSS文件上传</li><li>了解商品规格数据结构设计思路</li><li>实现商品规格查询</li></ul><h2 id="02、图片上传客户端：上传文件插件说明"><a href="#02、图片上传客户端：上传文件插件说明" class="headerlink" title="02、图片上传客户端：上传文件插件说明"></a>02、图片上传客户端：上传文件插件说明</h2><p><strong>回顾页面上传图片三要素：</strong></p><p>1）必须是post请求</p><p>2）必须是多部件类型form表单（type=”multipart/form-data”）</p><p>3）必须有一个type=“file”文件上传项</p><p>这三要素指的是form表单，我们的vue中没有这个表单，所以我们换一种方式，也就是做一个Vue的文件上传插件来实现文件上传，但是如果我们自己去开发这个插件，那会浪费很多时间，所以我们找一个现成的，直接放到项目中就可以用了，我们只需要看懂即可，关于这个文件上传插件的开发大家可以参考这个文件：</p><p><img src="%E4%B9%90%E4%BC%98%E7%94%B5%E5%95%86-04-%E5%93%81%E7%89%8C%E5%9B%BE%E7%89%87%E4%B8%8A%E4%BC%A0-%E5%95%86%E5%93%81%E8%A7%84%E6%A0%BC%E3%80%90OSS%E3%80%91.assets/1575424402339.png" alt="1575424402339"></p><p>看这个文章的这一项：</p><p><img src="%E4%B9%90%E4%BC%98%E7%94%B5%E5%95%86-04-%E5%93%81%E7%89%8C%E5%9B%BE%E7%89%87%E4%B8%8A%E4%BC%A0-%E5%95%86%E5%93%81%E8%A7%84%E6%A0%BC%E3%80%90OSS%E3%80%91.assets/1575424714898.png" alt="1575424714898"></p><p>有兴趣的同学可以看看，但我们的重点在微服务中。</p><h2 id="03、图片本地上传：搭建本地图片服务器"><a href="#03、图片本地上传：搭建本地图片服务器" class="headerlink" title="03、图片本地上传：搭建本地图片服务器"></a>03、图片本地上传：搭建本地图片服务器</h2><p>图片服务器我们可以选择tomcat，也可以选择nginx，如何选择他们？</p><p>那就看谁处理静态资源更加好了，从这方面来看，nginx肯定是首选了，所以我们去nginx下的html目录下创建一个brand-img的文件夹，然后把图片上传到该目录即可，接下来我们就开始来创建图片上传的微服务。</p><p>在nginx的根目录中找到html文件夹，在里面创建一个放置品牌logo的文件夹。</p><p><img src="%E4%B9%90%E4%BC%98%E7%94%B5%E5%95%86-04-%E5%93%81%E7%89%8C%E5%9B%BE%E7%89%87%E4%B8%8A%E4%BC%A0-%E5%95%86%E5%93%81%E8%A7%84%E6%A0%BC%E3%80%90OSS%E3%80%91.assets/image-20200720144620364.png" alt="image-20200720144620364"></p><p>在brand-logo中手动放一张图片</p><p><img src="%E4%B9%90%E4%BC%98%E7%94%B5%E5%95%86-04-%E5%93%81%E7%89%8C%E5%9B%BE%E7%89%87%E4%B8%8A%E4%BC%A0-%E5%95%86%E5%93%81%E8%A7%84%E6%A0%BC%E3%80%90OSS%E3%80%91.assets/image-20200720144932214.png" alt="image-20200720144932214"></p><p>通过访问地址访问效果如下：</p><p><img src="%E4%B9%90%E4%BC%98%E7%94%B5%E5%95%86-04-%E5%93%81%E7%89%8C%E5%9B%BE%E7%89%87%E4%B8%8A%E4%BC%A0-%E5%95%86%E5%93%81%E8%A7%84%E6%A0%BC%E3%80%90OSS%E3%80%91.assets/image-20200315092558170.png" alt="image-20200315092558170"></p><p>刚才的新增实现中，我们并没有上传图片，接下来我们一起完成图片上传逻辑。</p><p>文件的上传并不只是在品牌管理中有需求，以后的其它服务也可能需要，因此我们创建一个独立的微服务，专门处理各种上传。</p><h2 id="04、图片本地上传：创建图片上传微服务"><a href="#04、图片本地上传：创建图片上传微服务" class="headerlink" title="04、图片本地上传：创建图片上传微服务"></a>04、图片本地上传：创建图片上传微服务</h2><h3 id="1）创建module"><a href="#1）创建module" class="headerlink" title="1）创建module"></a>1）创建module</h3><p><img src="%E4%B9%90%E4%BC%98%E7%94%B5%E5%95%86-04-%E5%93%81%E7%89%8C%E5%9B%BE%E7%89%87%E4%B8%8A%E4%BC%A0-%E5%95%86%E5%93%81%E8%A7%84%E6%A0%BC%E3%80%90OSS%E3%80%91.assets/1605833520130.png" alt="1605833520130"></p><p><img src="%E4%B9%90%E4%BC%98%E7%94%B5%E5%95%86-04-%E5%93%81%E7%89%8C%E5%9B%BE%E7%89%87%E4%B8%8A%E4%BC%A0-%E5%95%86%E5%93%81%E8%A7%84%E6%A0%BC%E3%80%90OSS%E3%80%91.assets/1552144636424.png" alt="1552144636424"></p><h3 id="2）添加依赖"><a href="#2）添加依赖" class="headerlink" title="2）添加依赖"></a>2）添加依赖</h3><p>我们需要EurekaClient和web依赖：</p><pre class="line-numbers language-xml" data-language="xml"><code class="language-xml"><span class="token prolog">&lt;?xml version="1.0" encoding="UTF-8"?&gt;</span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>project</span> <span class="token attr-name">xmlns</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>http://maven.apache.org/POM/4.0.0<span class="token punctuation">"</span></span>
         <span class="token attr-name"><span class="token namespace">xmlns:</span>xsi</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>http://www.w3.org/2001/XMLSchema-instance<span class="token punctuation">"</span></span>
         <span class="token attr-name"><span class="token namespace">xsi:</span>schemaLocation</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>http://maven.apache.org/POM/4.0.0 http://maven.apache.org/xsd/maven-4.0.0.xsd<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>parent</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>leyou<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>com.leyou<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>version</span><span class="token punctuation">&gt;</span></span>1.0-SNAPSHOT<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>version</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>parent</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>modelVersion</span><span class="token punctuation">&gt;</span></span>4.0.0<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>modelVersion</span><span class="token punctuation">&gt;</span></span>

    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>ly-upload<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>

    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependencies</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>com.alibaba.cloud<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>spring-cloud-starter-alibaba-nacos-discovery<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>version</span><span class="token punctuation">&gt;</span></span>2.1.0.RELEASE<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>version</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>org.springframework.boot<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>spring-boot-starter-web<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>com.leyou<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>ly-common<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>version</span><span class="token punctuation">&gt;</span></span>1.0-SNAPSHOT<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>version</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependencies</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>build</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>plugins</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>plugin</span><span class="token punctuation">&gt;</span></span>
                <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>org.springframework.boot<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
                <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>spring-boot-maven-plugin<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>plugin</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>plugins</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>build</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>project</span><span class="token punctuation">&gt;</span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="3）编写配置"><a href="#3）编写配置" class="headerlink" title="3）编写配置"></a>3）编写配置</h3><pre class="line-numbers language-yaml" data-language="yaml"><code class="language-yaml"><span class="token key atrule">server</span><span class="token punctuation">:</span>
  <span class="token key atrule">port</span><span class="token punctuation">:</span> <span class="token number">8082</span>
<span class="token key atrule">spring</span><span class="token punctuation">:</span>
  <span class="token key atrule">application</span><span class="token punctuation">:</span>
    <span class="token key atrule">name</span><span class="token punctuation">:</span> upload<span class="token punctuation">-</span>service
  <span class="token key atrule">servlet</span><span class="token punctuation">:</span>
    <span class="token key atrule">multipart</span><span class="token punctuation">:</span>
      <span class="token key atrule">max-file-size</span><span class="token punctuation">:</span> 5MB <span class="token comment"># 限制文件上传的大小</span>
  <span class="token key atrule">cloud</span><span class="token punctuation">:</span>
    <span class="token key atrule">nacos</span><span class="token punctuation">:</span>
      <span class="token key atrule">discovery</span><span class="token punctuation">:</span>
        <span class="token key atrule">server-addr</span><span class="token punctuation">:</span> 127.0.0.1<span class="token punctuation">:</span><span class="token number">8848</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>需要注意的是，我们添加了限制文件大小的配置</p><h3 id="4）启动类"><a href="#4）启动类" class="headerlink" title="4）启动类"></a>4）启动类</h3><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token annotation punctuation">@SpringBootApplication</span>
<span class="token annotation punctuation">@EnableDiscoveryClient</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">LyUploadApplication</span> <span class="token punctuation">{</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">SpringApplication</span><span class="token punctuation">.</span><span class="token function">run</span><span class="token punctuation">(</span><span class="token class-name">LyUploadApplication</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">,</span> args<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>结构：</p><p><img src="%E4%B9%90%E4%BC%98%E7%94%B5%E5%95%86-04-%E5%93%81%E7%89%8C%E5%9B%BE%E7%89%87%E4%B8%8A%E4%BC%A0-%E5%95%86%E5%93%81%E8%A7%84%E6%A0%BC%E3%80%90OSS%E3%80%91.assets/1552144792255.png" alt="1552144792255"></p><h3 id="5）在ly-gateway中注册网关配置"><a href="#5）在ly-gateway中注册网关配置" class="headerlink" title="5）在ly-gateway中注册网关配置"></a>5）在ly-gateway中注册网关配置</h3><pre class="line-numbers language-yml" data-language="yml"><code class="language-yml"><span class="token punctuation">-</span> <span class="token key atrule">id</span><span class="token punctuation">:</span> upload<span class="token punctuation">-</span>service
  <span class="token key atrule">uri</span><span class="token punctuation">:</span> lb<span class="token punctuation">:</span>//upload<span class="token punctuation">-</span>service
  <span class="token key atrule">predicates</span><span class="token punctuation">:</span>
    <span class="token punctuation">-</span> Path=/api/upload/<span class="token important">**</span>
  <span class="token key atrule">filters</span><span class="token punctuation">:</span>
    <span class="token punctuation">-</span> StripPrefix=2<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h2 id="05、图片本地上传：上传功能初步实现"><a href="#05、图片本地上传：上传功能初步实现" class="headerlink" title="05、图片本地上传：上传功能初步实现"></a>05、图片本地上传：上传功能初步实现</h2><h3 id="1）在application-yml定义变量"><a href="#1）在application-yml定义变量" class="headerlink" title="1）在application.yml定义变量"></a>1）在application.yml定义变量</h3><pre class="line-numbers language-yml" data-language="yml"><code class="language-yml"><span class="token key atrule">ly</span><span class="token punctuation">:</span>
  <span class="token key atrule">upload</span><span class="token punctuation">:</span>
    <span class="token key atrule">imagePath</span><span class="token punctuation">:</span> D<span class="token punctuation">:</span>\leyou_projects\javaee145\software\nginx<span class="token punctuation">-</span>1.16.0\html\brand<span class="token punctuation">-</span>logo
    <span class="token key atrule">imageUrl</span><span class="token punctuation">:</span> http<span class="token punctuation">:</span>//localhost/brand<span class="token punctuation">-</span>logo/     <span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre><h3 id="2）编写Controller"><a href="#2）编写Controller" class="headerlink" title="2）编写Controller"></a>2）编写Controller</h3><p>点击新增品牌页面的上传图片按钮，即可看到上传图片请求：</p><p><img src="%E4%B9%90%E4%BC%98%E7%94%B5%E5%95%86-04-%E5%93%81%E7%89%8C%E5%9B%BE%E7%89%87%E4%B8%8A%E4%BC%A0-%E5%95%86%E5%93%81%E8%A7%84%E6%A0%BC%E3%80%90OSS%E3%80%91.assets/1552144440922.png" alt="1552144440922"></p><p>从图中很容易看出编写controller需要知道4个内容：</p><ul><li>请求方式：上传肯定是POST</li><li>请求路径：/upload/image</li><li>请求参数：文件，参数名是file，SpringMVC会封装为一个接口：MultipleFile</li><li>返回结果：这里上传与表单分离，文件不是跟随表单一起提交，而是单独上传并得到结果，随后把结果跟随表单提交。因此上传成功后需要返回一个可以访问的文件的url路径</li></ul><p>代码如下：</p><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">package</span> <span class="token namespace">com<span class="token punctuation">.</span>leyou<span class="token punctuation">.</span>upload<span class="token punctuation">.</span>controller</span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token namespace">com<span class="token punctuation">.</span>leyou<span class="token punctuation">.</span>upload<span class="token punctuation">.</span>service<span class="token punctuation">.</span></span><span class="token class-name">UploadService</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>beans<span class="token punctuation">.</span>factory<span class="token punctuation">.</span>annotation<span class="token punctuation">.</span></span><span class="token class-name">Autowired</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>http<span class="token punctuation">.</span></span><span class="token class-name">ResponseEntity</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>web<span class="token punctuation">.</span>bind<span class="token punctuation">.</span>annotation<span class="token punctuation">.</span></span><span class="token class-name">PostMapping</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>web<span class="token punctuation">.</span>bind<span class="token punctuation">.</span>annotation<span class="token punctuation">.</span></span><span class="token class-name">RequestParam</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>web<span class="token punctuation">.</span>bind<span class="token punctuation">.</span>annotation<span class="token punctuation">.</span></span><span class="token class-name">RestController</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>web<span class="token punctuation">.</span>multipart<span class="token punctuation">.</span></span><span class="token class-name">MultipartFile</span><span class="token punctuation">;</span>

<span class="token comment">/**
 * 上传
 */</span>
<span class="token annotation punctuation">@RestController</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">UploadController</span> <span class="token punctuation">{</span>
    <span class="token annotation punctuation">@Autowired</span>
    <span class="token keyword">private</span> <span class="token class-name">UploadService</span> uploadService<span class="token punctuation">;</span>

    <span class="token comment">/**
     * 本地图片上传
     */</span>
    <span class="token annotation punctuation">@PostMapping</span><span class="token punctuation">(</span><span class="token string">"/image"</span><span class="token punctuation">)</span>
    <span class="token keyword">public</span> <span class="token class-name">ResponseEntity</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> <span class="token function">uploadImage</span><span class="token punctuation">(</span><span class="token annotation punctuation">@RequestParam</span><span class="token punctuation">(</span><span class="token string">"file"</span><span class="token punctuation">)</span> <span class="token class-name">MultipartFile</span> file<span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token class-name">String</span> imageUrl <span class="token operator">=</span> uploadService<span class="token punctuation">.</span><span class="token function">uploadImage</span><span class="token punctuation">(</span>file<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token class-name">ResponseEntity</span><span class="token punctuation">.</span><span class="token function">ok</span><span class="token punctuation">(</span>imageUrl<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="3）编写Service"><a href="#3）编写Service" class="headerlink" title="3）编写Service"></a>3）编写Service</h3><p>完成文件上传：</p><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">package</span> <span class="token namespace">com<span class="token punctuation">.</span>leyou<span class="token punctuation">.</span>upload<span class="token punctuation">.</span>service</span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token namespace">com<span class="token punctuation">.</span>leyou<span class="token punctuation">.</span>common<span class="token punctuation">.</span>exception<span class="token punctuation">.</span>pojo<span class="token punctuation">.</span></span><span class="token class-name">ExceptionEnum</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">com<span class="token punctuation">.</span>leyou<span class="token punctuation">.</span>common<span class="token punctuation">.</span>exception<span class="token punctuation">.</span>pojo<span class="token punctuation">.</span></span><span class="token class-name">LyException</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>beans<span class="token punctuation">.</span>factory<span class="token punctuation">.</span>annotation<span class="token punctuation">.</span></span><span class="token class-name">Value</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>stereotype<span class="token punctuation">.</span></span><span class="token class-name">Service</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>web<span class="token punctuation">.</span>multipart<span class="token punctuation">.</span></span><span class="token class-name">MultipartFile</span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token namespace">java<span class="token punctuation">.</span>io<span class="token punctuation">.</span></span><span class="token class-name">File</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">java<span class="token punctuation">.</span>io<span class="token punctuation">.</span></span><span class="token class-name">IOException</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span></span>UUID<span class="token punctuation">;</span>

<span class="token comment">/**
 *
 */</span>
<span class="token annotation punctuation">@Service</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">UploadService</span> <span class="token punctuation">{</span>

    <span class="token annotation punctuation">@Value</span><span class="token punctuation">(</span><span class="token string">"${ly.upload.imagePath}"</span><span class="token punctuation">)</span>
    <span class="token keyword">private</span> <span class="token class-name">String</span> imagePath<span class="token punctuation">;</span> <span class="token comment">// 图片保存路径</span>
    <span class="token annotation punctuation">@Value</span><span class="token punctuation">(</span><span class="token string">"${ly.upload.imageUrl}"</span><span class="token punctuation">)</span>
    <span class="token keyword">private</span> <span class="token class-name">String</span> imageUrl<span class="token punctuation">;</span><span class="token comment">// 图片的访问路径</span>

    <span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">uploadImage</span><span class="token punctuation">(</span><span class="token class-name">MultipartFile</span> file<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">//生成随机文件名称</span>
        <span class="token class-name">String</span> uuid <span class="token operator">=</span> UUID<span class="token punctuation">.</span><span class="token function">randomUUID</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//获取文件的后缀名</span>
        <span class="token class-name">String</span> originalFilename <span class="token operator">=</span> file<span class="token punctuation">.</span><span class="token function">getOriginalFilename</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">String</span> extName <span class="token operator">=</span> originalFilename<span class="token punctuation">.</span><span class="token function">substring</span><span class="token punctuation">(</span>originalFilename<span class="token punctuation">.</span><span class="token function">lastIndexOf</span><span class="token punctuation">(</span><span class="token string">"."</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// .jpg</span>
        <span class="token comment">//最终的文件名称</span>
        <span class="token class-name">String</span> fileName <span class="token operator">=</span> uuid<span class="token operator">+</span>extName<span class="token punctuation">;</span>

        <span class="token keyword">try</span> <span class="token punctuation">{</span>
            <span class="token comment">//保存文件到nginx目录</span>
            file<span class="token punctuation">.</span><span class="token function">transferTo</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">File</span><span class="token punctuation">(</span>imagePath<span class="token punctuation">,</span>fileName<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token comment">//访问路径：http://localhost/brand-logo/3.jpg</span>
            <span class="token keyword">return</span> imageUrl<span class="token operator">+</span>fileName<span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">IOException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">LyException</span><span class="token punctuation">(</span><span class="token class-name">ExceptionEnum</span><span class="token punctuation">.</span>FILE_UPLOAD_ERROR<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="4）测试上传"><a href="#4）测试上传" class="headerlink" title="4）测试上传"></a>4）测试上传</h3><p>启动上传文件微服务和网关微服务，然后打开页面测试：</p><p><img src="%E4%B9%90%E4%BC%98%E7%94%B5%E5%95%86-04-%E5%93%81%E7%89%8C%E5%9B%BE%E7%89%87%E4%B8%8A%E4%BC%A0-%E5%95%86%E5%93%81%E8%A7%84%E6%A0%BC%E3%80%90OSS%E3%80%91.assets/image-20200315095935513.png" alt="image-20200315095935513"></p><h2 id="06、图片本地上传：上传文件格式判断"><a href="#06、图片本地上传：上传文件格式判断" class="headerlink" title="06、图片本地上传：上传文件格式判断"></a>06、图片本地上传：上传文件格式判断</h2><p>现在图片已经能够上传了，但是还不够完善，文件的上传类型我们还没有判断，我们不能让用户什么东西都往上面传，所以我们需要判断一下上传图片的格式。</p><p>mime类型，是浏览器识别的文件类型，这些类型我们不用背，随便找个tomcat里面都有：</p><p><img src="%E4%B9%90%E4%BC%98%E7%94%B5%E5%95%86-04-%E5%93%81%E7%89%8C%E5%9B%BE%E7%89%87%E4%B8%8A%E4%BC%A0-%E5%95%86%E5%93%81%E8%A7%84%E6%A0%BC%E3%80%90OSS%E3%80%91.assets/1575429326515.png" alt="1575429326515"></p><p>去web.xml中搜索即可，我们允许那种类型就选择哪个，这里我们用的是多个，所以用一个集合来存比较好，我们把这个集合作为一个全局变量，然后在上传方法中去判断，代码如下</p><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">package</span> <span class="token namespace">com<span class="token punctuation">.</span>leyou<span class="token punctuation">.</span>upload<span class="token punctuation">.</span>service</span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token namespace">com<span class="token punctuation">.</span>leyou<span class="token punctuation">.</span>common<span class="token punctuation">.</span>exception<span class="token punctuation">.</span>pojo<span class="token punctuation">.</span></span><span class="token class-name">ExceptionEnum</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">com<span class="token punctuation">.</span>leyou<span class="token punctuation">.</span>common<span class="token punctuation">.</span>exception<span class="token punctuation">.</span>pojo<span class="token punctuation">.</span></span><span class="token class-name">LyException</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>beans<span class="token punctuation">.</span>factory<span class="token punctuation">.</span>annotation<span class="token punctuation">.</span></span><span class="token class-name">Value</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>stereotype<span class="token punctuation">.</span></span><span class="token class-name">Service</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>web<span class="token punctuation">.</span>multipart<span class="token punctuation">.</span></span><span class="token class-name">MultipartFile</span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token namespace">javax<span class="token punctuation">.</span>imageio<span class="token punctuation">.</span></span><span class="token class-name">ImageIO</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">java<span class="token punctuation">.</span>awt<span class="token punctuation">.</span>image<span class="token punctuation">.</span></span><span class="token class-name">BufferedImage</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">java<span class="token punctuation">.</span>io<span class="token punctuation">.</span></span><span class="token class-name">File</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">java<span class="token punctuation">.</span>io<span class="token punctuation">.</span></span><span class="token class-name">IOException</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span></span>UUID<span class="token punctuation">;</span>

<span class="token comment">/**
 *
 */</span>
<span class="token annotation punctuation">@Service</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">UploadService</span> <span class="token punctuation">{</span>

    <span class="token annotation punctuation">@Value</span><span class="token punctuation">(</span><span class="token string">"${ly.upload.imagePath}"</span><span class="token punctuation">)</span>
    <span class="token keyword">private</span> <span class="token class-name">String</span> imagePath<span class="token punctuation">;</span> <span class="token comment">// 图片保存路径</span>
    <span class="token annotation punctuation">@Value</span><span class="token punctuation">(</span><span class="token string">"${ly.upload.imageUrl}"</span><span class="token punctuation">)</span>
    <span class="token keyword">private</span> <span class="token class-name">String</span> imageUrl<span class="token punctuation">;</span><span class="token comment">// 图片的访问路径</span>

    <span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">uploadImage</span><span class="token punctuation">(</span><span class="token class-name">MultipartFile</span> file<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">//判断该文件是否为图片流</span>
        <span class="token keyword">try</span> <span class="token punctuation">{</span>
            <span class="token class-name">BufferedImage</span> image <span class="token operator">=</span> <span class="token class-name">ImageIO</span><span class="token punctuation">.</span><span class="token function">read</span><span class="token punctuation">(</span>file<span class="token punctuation">.</span><span class="token function">getInputStream</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span><span class="token punctuation">(</span>image<span class="token operator">==</span><span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
                <span class="token comment">//代表该文件不是图片</span>
                <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">LyException</span><span class="token punctuation">(</span><span class="token class-name">ExceptionEnum</span><span class="token punctuation">.</span>INVALID_FILE_TYPE<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">IOException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>


        <span class="token comment">//生成随机文件名称</span>
        <span class="token class-name">String</span> uuid <span class="token operator">=</span> UUID<span class="token punctuation">.</span><span class="token function">randomUUID</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//获取文件的后缀名</span>
        <span class="token class-name">String</span> originalFilename <span class="token operator">=</span> file<span class="token punctuation">.</span><span class="token function">getOriginalFilename</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">String</span> extName <span class="token operator">=</span> originalFilename<span class="token punctuation">.</span><span class="token function">substring</span><span class="token punctuation">(</span>originalFilename<span class="token punctuation">.</span><span class="token function">lastIndexOf</span><span class="token punctuation">(</span><span class="token string">"."</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// .jpg</span>
        <span class="token comment">//最终的文件名称</span>
        <span class="token class-name">String</span> fileName <span class="token operator">=</span> uuid<span class="token operator">+</span>extName<span class="token punctuation">;</span>

        <span class="token keyword">try</span> <span class="token punctuation">{</span>
            <span class="token comment">//保存文件到nginx目录</span>
            file<span class="token punctuation">.</span><span class="token function">transferTo</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">File</span><span class="token punctuation">(</span>imagePath<span class="token punctuation">,</span>fileName<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token comment">//访问路径：http://localhost/brand-logo/3.jpg</span>
            <span class="token keyword">return</span> imageUrl<span class="token operator">+</span>fileName<span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">IOException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">LyException</span><span class="token punctuation">(</span><span class="token class-name">ExceptionEnum</span><span class="token punctuation">.</span>FILE_UPLOAD_ERROR<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>


<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h2 id="07、图片本地上传：修改nginx上传文件大小限制"><a href="#07、图片本地上传：修改nginx上传文件大小限制" class="headerlink" title="07、图片本地上传：修改nginx上传文件大小限制"></a>07、图片本地上传：修改nginx上传文件大小限制</h2><p>我们上传一个超过1M大小的文件</p><p><img src="%E4%B9%90%E4%BC%98%E7%94%B5%E5%95%86-04-%E5%93%81%E7%89%8C%E5%9B%BE%E7%89%87%E4%B8%8A%E4%BC%A0-%E5%95%86%E5%93%81%E8%A7%84%E6%A0%BC%E3%80%90OSS%E3%80%91.assets/1552145659243.png" alt="1552145659243"></p><p>发现收到错误响应：</p><p><img src="%E4%B9%90%E4%BC%98%E7%94%B5%E5%95%86-04-%E5%93%81%E7%89%8C%E5%9B%BE%E7%89%87%E4%B8%8A%E4%BC%A0-%E5%95%86%E5%93%81%E8%A7%84%E6%A0%BC%E3%80%90OSS%E3%80%91.assets/1552145695272.png" alt="1552145695272"></p><p>这是nginx对文件大小的限制（默认为1M），我们<code>leyou.conf</code>中的server的外面，设置大小限制为5M：</p><pre class="line-numbers language-none"><code class="language-none">client_max_body_size 5m;<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>如下图：</p><p><img src="%E4%B9%90%E4%BC%98%E7%94%B5%E5%95%86-04-%E5%93%81%E7%89%8C%E5%9B%BE%E7%89%87%E4%B8%8A%E4%BC%A0-%E5%95%86%E5%93%81%E8%A7%84%E6%A0%BC%E3%80%90OSS%E3%80%91.assets/1575430521729.png" alt="1575430521729"></p><p>重启nginx，再次测试，可以了，完美！</p><pre class="line-numbers language-none"><code class="language-none">nginx.exe -s reload<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><blockquote><p>nginx 下的logs文件夹可以看到相关日志 如果nginx可以在日志中查看</p></blockquote><p>前端的代码已经限制最大上传2m，如果要大于这个值，需要改动代码：</p><p><img src="%E4%B9%90%E4%BC%98%E7%94%B5%E5%95%86-04-%E5%93%81%E7%89%8C%E5%9B%BE%E7%89%87%E4%B8%8A%E4%BC%A0-%E5%95%86%E5%93%81%E8%A7%84%E6%A0%BC%E3%80%90OSS%E3%80%91.assets/1578445546507.png" alt="1578445546507"></p><p><img src="%E4%B9%90%E4%BC%98%E7%94%B5%E5%95%86-04-%E5%93%81%E7%89%8C%E5%9B%BE%E7%89%87%E4%B8%8A%E4%BC%A0-%E5%95%86%E5%93%81%E8%A7%84%E6%A0%BC%E3%80%90OSS%E3%80%91.assets/1603763675075.png" alt="1603763675075"></p><h2 id="08、图片云存储：云存储介绍"><a href="#08、图片云存储：云存储介绍" class="headerlink" title="08、图片云存储：云存储介绍"></a>08、图片云存储：云存储介绍</h2><p>讲课前，我们先思考一下，之前上传的功能，有没有什么问题？</p><p>上传本身没有任何问题，问题出在保存文件的方式，我们是保存在服务器机器，就会有下面的问题：</p><ul><li>单机器存储，存储能力有限</li><li>无法进行水平扩展，因为多台机器的文件无法共享,会出现访问不到的情况</li><li>数据没有备份，有单点故障风险</li><li>并发能力差</li></ul><p>这个时候，最好使用分布式文件存储来代替本地文件存储。</p><h3 id="1）什么是分布式文件系统"><a href="#1）什么是分布式文件系统" class="headerlink" title="1）什么是分布式文件系统"></a>1）什么是分布式文件系统</h3><p>分布式文件系统（Distributed File System）是指文件系统管理的物理存储资源不一定直接连接在本地节点上，而是通过计算机网络与节点相连。</p><p>通俗来讲：</p><ul><li>传统文件系统管理的文件就存储在本机。</li><li>分布式文件系统管理的文件存储在很多机器，这些机器通过网络连接，要被统一管理。无论是上传或者访问文件，都需要通过管理中心来访问</li></ul><p>常见的分布式文件系统有谷歌的GFS、HDFS（Hadoop）、TFS（淘宝）、Fast DFS（淘宝）等。</p><p>不过，企业自己搭建分布式文件系统成本较高，对于一些中小型企业而言，使用云上的文件存储，是性价比更高的选择。</p><h3 id="2）分布式存储方案"><a href="#2）分布式存储方案" class="headerlink" title="2）分布式存储方案"></a>2）分布式存储方案</h3><ul><li>七牛： <a target="_blank" rel="noopener" href="https://www.qiniu.com/">https://www.qiniu.com/</a></li><li>阿里云： <a target="_blank" rel="noopener" href="https://www.aliyun.com/product/oss">https://www.aliyun.com/product/oss</a></li><li>腾讯云： <a target="_blank" rel="noopener" href="https://cloud.tencent.com/product/cos">https://cloud.tencent.com/product/cos</a></li><li>华为云： <a target="_blank" rel="noopener" href="https://www.huaweicloud.com/product/obs.html">https://www.huaweicloud.com/product/obs.html</a></li><li>亚马逊： <a target="_blank" rel="noopener" href="https://aws.amazon.com/cn/s3/">https://aws.amazon.com/cn/s3/</a></li></ul><p>七牛我们用过了，亚马逊国外的 就不用了，华为刚出先不用，那么阿里云和腾讯云两个中我们可以选择阿里云，因为阿里云做云存储比腾讯云早点，我用它。</p><h3 id="3）阿里云对象存储OSS介绍"><a href="#3）阿里云对象存储OSS介绍" class="headerlink" title="3）阿里云对象存储OSS介绍"></a>3）阿里云对象存储OSS介绍</h3><p>从官方进去，找到产品分类，找到对象存储OSS即可：</p><p><img src="%E4%B9%90%E4%BC%98%E7%94%B5%E5%95%86-04-%E5%93%81%E7%89%8C%E5%9B%BE%E7%89%87%E4%B8%8A%E4%BC%A0-%E5%95%86%E5%93%81%E8%A7%84%E6%A0%BC%E3%80%90OSS%E3%80%91.assets/1575439951112.png" alt="1575439951112"></p><p>点击链接，去到对象存储页面：</p><p><img src="%E4%B9%90%E4%BC%98%E7%94%B5%E5%95%86-04-%E5%93%81%E7%89%8C%E5%9B%BE%E7%89%87%E4%B8%8A%E4%BC%A0-%E5%95%86%E5%93%81%E8%A7%84%E6%A0%BC%E3%80%90OSS%E3%80%91.assets/1575440028426.png" alt="1575440028426"></p><p>阿里的OSS就是一个文件云存储方案，简介：</p><blockquote><p>阿里云对象存储服务（Object Storage Service，简称 OSS），是阿里云提供的海量、安全、低成本、高可靠的云存储服务。其数据设计持久性不低于99.999999999%，服务设计可用性不低于99.99%。具有与平台无关的RESTful API接口，您可以在任何应用、任何时间、任何地点存储和访问任意类型的数据。</p><p>您可以使用阿里云提供的API、SDK接口或者OSS迁移工具轻松地将海量数据移入或移出阿里云OSS。数据存储到阿里云OSS以后，您可以选择标准类型（Standard）的阿里云OSS服务作为移动应用、大型网站、图片分享或热点音视频的主要存储方式，也可以选择成本更低、存储期限更长的低频访问类型（Infrequent Access）和归档类型（Archive）的阿里云OSS服务作为不经常访问数据的备份和归档。</p></blockquote><h2 id="09、图片云存储：阿里云对象存储OSS"><a href="#09、图片云存储：阿里云对象存储OSS" class="headerlink" title="09、图片云存储：阿里云对象存储OSS"></a>09、图片云存储：阿里云对象存储OSS</h2><h3 id="1）开通OSS访问"><a href="#1）开通OSS访问" class="headerlink" title="1）开通OSS访问"></a>1）开通OSS访问</h3><p>点击立即开通按钮，就可以开通服务，没有登录会跳转到登录页面：</p><p><img src="%E4%B9%90%E4%BC%98%E7%94%B5%E5%95%86-04-%E5%93%81%E7%89%8C%E5%9B%BE%E7%89%87%E4%B8%8A%E4%BC%A0-%E5%95%86%E5%93%81%E8%A7%84%E6%A0%BC%E3%80%90OSS%E3%80%91.assets/1575440350543.png" alt="1575440350543"></p><p>开通后，即可以进入管理控制台：</p><p><img src="%E4%B9%90%E4%BC%98%E7%94%B5%E5%95%86-04-%E5%93%81%E7%89%8C%E5%9B%BE%E7%89%87%E4%B8%8A%E4%BC%A0-%E5%95%86%E5%93%81%E8%A7%84%E6%A0%BC%E3%80%90OSS%E3%80%91.assets/1575440806451.png" alt="1575440806451"></p><h3 id="2）对象存储OSS的基本概念"><a href="#2）对象存储OSS的基本概念" class="headerlink" title="2）对象存储OSS的基本概念"></a>2）对象存储OSS的基本概念</h3><p>OSS中包含一些概念，我们来认识一下：</p><p>相关概念可以查看官方链接： <a target="_blank" rel="noopener" href="https://help.aliyun.com/document_detail/31817.html">https://help.aliyun.com/document_detail/31817.html</a></p><ul><li><p>存储类型（Storage Class）</p><p>OSS 提供标准、低频访问、归档三种存储类型，全面覆盖从热到冷的各种数据存储场景。其中标准存储类型提供高可靠、高可用、高性能的对象存储服务，能够支持频繁的数据访问；低频访问存储类型适合长期保存不经常访问的数据（平均每月访问频率 1 到 2 次），存储单价低于标准类型；归档存储类型适合需要长期保存（建议半年以上）的归档数据，在三种存储类型中单价最低。详情请参见<a target="_blank" rel="noopener" href="https://help.aliyun.com/document_detail/51374.html#concept-fcn-3xt-tdb">存储类型介绍</a>。</p></li><li><p>==存储空间（Bucket）==</p><p>存储空间是您用于存储对象（Object）的容器，所有的对象都必须隶属于某个存储空间。存储空间具有各种配置属性，包括地域、访问权限、存储类型等。您可以根据实际需求，创建不同类型的存储空间来存储不同的数据。创建存储空间请参见<a target="_blank" rel="noopener" href="https://help.aliyun.com/document_detail/31842.html#concept-ntj-wx1-5db">创建存储空间</a>。</p></li><li><p>对象/文件（Object）</p><p>对象是 OSS 存储数据的基本单元，也被称为 OSS 的文件。对象由元信息（Object Meta）、用户数据（Data）和文件名（Key）组成。对象由存储空间内部唯一的 Key 来标识。对象元信息是一组键值对，表示了对象的一些属性，比如最后修改时间、大小等信息，同时您也可以在元信息中存储一些自定义的信息。</p></li><li><p>地域（Region）</p><p>地域表示 OSS 的数据中心所在物理位置。您可以根据费用、请求来源等选择合适的地域创建 Bucket。详情请参见 <a target="_blank" rel="noopener" href="https://help.aliyun.com/document_detail/31837.html#concept-zt4-cvy-5db">OSS 已开通的Region</a>。</p></li><li><p>==访问域名（Endpoint）==</p><p>Endpoint 表示 OSS 对外服务的访问域名。OSS 以 HTTP RESTful API 的形式对外提供服务，当访问不同地域的时候，需要不同的域名。通过内网和外网访问同一个地域所需要的域名也是不同的。具体的内容请参见<a target="_blank" rel="noopener" href="https://help.aliyun.com/document_detail/31837.html#concept-zt4-cvy-5db">各个 Region 对应的 Endpoint</a>。</p></li><li><p>==访问密钥（AccessKey）==</p><p>AccessKey（简称 AK）指的是访问身份验证中用到的 AccessKeyId 和 AccessKeySecret。OSS 通过使用 AccessKeyId 和 AccessKeySecret 对称加密的方法来验证某个请求的发送者身份。AccessKeyId 用于标识用户；AccessKeySecret 是用户用于加密签名字符串和 OSS 用来验证签名字符串的密钥，必须保密。获取 AccessKey 的方法请参见<a target="_blank" rel="noopener" href="https://help.aliyun.com/document_detail/53045.html#concept-53045-zh">创建 AccessKey</a>。</p></li></ul><h3 id="3）创建一个Bucket（存储桶）"><a href="#3）创建一个Bucket（存储桶）" class="headerlink" title="3）创建一个Bucket（存储桶）"></a>3）创建一个Bucket（存储桶）</h3><p>在控制台的右侧，可以看到一个<code>新建Bucket</code>按钮：</p><p><img src="%E4%B9%90%E4%BC%98%E7%94%B5%E5%95%86-04-%E5%93%81%E7%89%8C%E5%9B%BE%E7%89%87%E4%B8%8A%E4%BC%A0-%E5%95%86%E5%93%81%E8%A7%84%E6%A0%BC%E3%80%90OSS%E3%80%91.assets/1575441974929.png" alt="1575441974929"></p><p>点击后，弹出对话框，填写基本信息：</p><p><img src="%E4%B9%90%E4%BC%98%E7%94%B5%E5%95%86-04-%E5%93%81%E7%89%8C%E5%9B%BE%E7%89%87%E4%B8%8A%E4%BC%A0-%E5%95%86%E5%93%81%E8%A7%84%E6%A0%BC%E3%80%90OSS%E3%80%91.assets/1575442212986.png" alt="1575442212986"></p><p>填写完基本信息后，点击确定按钮就可以完成Bucket的创建</p><p>==<strong>注意点：</strong>==</p><ul><li>bucket：存储空间名称，名字只能是字母、数字、中划线</li><li>区域：即服务器的地址，这里选择了离我们最近的深圳</li><li>Endpoint：选中区域后，会自动生成一个Endpoint地址，这将是我们访问OSS服务的域名的组成部分</li><li>存储类型：默认</li><li>读写权限：这里我们选择公共读，否则每次访问都需要额外生成签名并校验，比较麻烦。敏感数据设置为私有即可！</li><li>日志：不开通</li></ul><h3 id="4）设置跨域访问"><a href="#4）设置跨域访问" class="headerlink" title="4）设置跨域访问(***)"></a>4）设置跨域访问(***)</h3><p>由于我们的域名是leyou.com，而阿里云的域名是aliyuncs.com，所以会产生跨域访问，我们设置下：</p><p><img src="%E4%B9%90%E4%BC%98%E7%94%B5%E5%95%86-04-%E5%93%81%E7%89%8C%E5%9B%BE%E7%89%87%E4%B8%8A%E4%BC%A0-%E5%95%86%E5%93%81%E8%A7%84%E6%A0%BC%E3%80%90OSS%E3%80%91.assets/1575444412056.png" alt="1575444412056"></p><p>点击 <img src="%E4%B9%90%E4%BC%98%E7%94%B5%E5%95%86-04-%E5%93%81%E7%89%8C%E5%9B%BE%E7%89%87%E4%B8%8A%E4%BC%A0-%E5%95%86%E5%93%81%E8%A7%84%E6%A0%BC%E3%80%90OSS%E3%80%91.assets/1575444758298.png" alt="1575444758298"> 设置跨域规则如下：</p><p><img src="%E4%B9%90%E4%BC%98%E7%94%B5%E5%95%86-04-%E5%93%81%E7%89%8C%E5%9B%BE%E7%89%87%E4%B8%8A%E4%BC%A0-%E5%95%86%E5%93%81%E8%A7%84%E6%A0%BC%E3%80%90OSS%E3%80%91.assets/image-20200315104844853.png" alt="image-20200315104844853"></p><h3 id="5）创建AccessKey"><a href="#5）创建AccessKey" class="headerlink" title="5）创建AccessKey"></a>5）创建AccessKey</h3><p>有了bucket就可以进行文件上传或下载了。不过，为了安全考虑，我们给阿里云账户开通一个子账户，并设置对OSS的读写权限。</p><p>点击屏幕右上角的个人图像，然后点击访问控制：</p><p><img src="%E4%B9%90%E4%BC%98%E7%94%B5%E5%95%86-04-%E5%93%81%E7%89%8C%E5%9B%BE%E7%89%87%E4%B8%8A%E4%BC%A0-%E5%95%86%E5%93%81%E8%A7%84%E6%A0%BC%E3%80%90OSS%E3%80%91.assets/1575442872330.png" alt="1575442872330"></p><p>在跳转的页面中，选择用户，并新建一个用户：</p><p><img src="%E4%B9%90%E4%BC%98%E7%94%B5%E5%95%86-04-%E5%93%81%E7%89%8C%E5%9B%BE%E7%89%87%E4%B8%8A%E4%BC%A0-%E5%95%86%E5%93%81%E8%A7%84%E6%A0%BC%E3%80%90OSS%E3%80%91.assets/1575443068711.png" alt="1575443068711"></p><p>然后填写用户信息：</p><p><img src="%E4%B9%90%E4%BC%98%E7%94%B5%E5%95%86-04-%E5%93%81%E7%89%8C%E5%9B%BE%E7%89%87%E4%B8%8A%E4%BC%A0-%E5%95%86%E5%93%81%E8%A7%84%E6%A0%BC%E3%80%90OSS%E3%80%91.assets/1575443013764.png" alt="1575443013764"></p><p>然后会为你生成用户的AccessKeyID和AccessKeySecret，下图马赛克部分：</p><p><img src="%E4%B9%90%E4%BC%98%E7%94%B5%E5%95%86-04-%E5%93%81%E7%89%8C%E5%9B%BE%E7%89%87%E4%B8%8A%E4%BC%A0-%E5%95%86%E5%93%81%E8%A7%84%E6%A0%BC%E3%80%90OSS%E3%80%91.assets/1575443194990.png" alt="1575443194990"></p><pre class="line-numbers language-none"><code class="language-none">LTAI4GE2hZZF1iCZEXagEeHg
PDHcwUktVKqwzYO0x9DEhETrQrQwtW<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre><p>妥善保管，不要告诉任何人！</p><p>接下来，我们需要给这个用户添加对OSS的控制权限。</p><p>进入这个新增的用户详情页面：</p><p><img src="%E4%B9%90%E4%BC%98%E7%94%B5%E5%95%86-04-%E5%93%81%E7%89%8C%E5%9B%BE%E7%89%87%E4%B8%8A%E4%BC%A0-%E5%95%86%E5%93%81%E8%A7%84%E6%A0%BC%E3%80%90OSS%E3%80%91.assets/1575443396855.png" alt="1575443396855"></p><p>点击添加权限，会进入权限选择页面，输入oss进行搜索，然后选择<code>管理对象存储服务（OSS）</code>权限：</p><p><img src="%E4%B9%90%E4%BC%98%E7%94%B5%E5%95%86-04-%E5%93%81%E7%89%8C%E5%9B%BE%E7%89%87%E4%B8%8A%E4%BC%A0-%E5%95%86%E5%93%81%E8%A7%84%E6%A0%BC%E3%80%90OSS%E3%80%91.assets/1575443529053.png" alt="1575443529053"></p><p>到此全部准备工作已经准备好了！</p><h2 id="10、图片云存储：上传方案说明"><a href="#10、图片云存储：上传方案说明" class="headerlink" title="10、图片云存储：上传方案说明"></a>10、图片云存储：上传方案说明</h2><p><a target="_blank" rel="noopener" href="https://www.aliyun.com/product/oss?spm=5176.19720258.J_8058803260.12.e9392c4aM4Jct2">https://www.aliyun.com/product/oss?spm=5176.19720258.J_8058803260.12.e9392c4aM4Jct2</a></p><p><img src="%E4%B9%90%E4%BC%98%E7%94%B5%E5%95%86-04-%E5%93%81%E7%89%8C%E5%9B%BE%E7%89%87%E4%B8%8A%E4%BC%A0-%E5%95%86%E5%93%81%E8%A7%84%E6%A0%BC%E3%80%90OSS%E3%80%91.assets/1603765994241.png" alt="1603765994241"></p><p>在控制台的右侧，点击<code>开发者指南</code>按钮，即可查看帮助文档：</p><p><img src="%E4%B9%90%E4%BC%98%E7%94%B5%E5%95%86-04-%E5%93%81%E7%89%8C%E5%9B%BE%E7%89%87%E4%B8%8A%E4%BC%A0-%E5%95%86%E5%93%81%E8%A7%84%E6%A0%BC%E3%80%90OSS%E3%80%91.assets/1575445994148.png" alt="1575445994148"></p><p>然后在弹出的新页面的左侧菜单中找到开发者指南：</p><p><img src="%E4%B9%90%E4%BC%98%E7%94%B5%E5%95%86-04-%E5%93%81%E7%89%8C%E5%9B%BE%E7%89%87%E4%B8%8A%E4%BC%A0-%E5%95%86%E5%93%81%E8%A7%84%E6%A0%BC%E3%80%90OSS%E3%80%91.assets/1603766049642.png" alt="1603766049642"></p><p>可以看到上传文件中，支持多种上传方式，并且因为提供的Rest风格的API，任何语言都可以访问OSS实现上传。</p><p>我们可以直接使用java代码来实现把图片上传到OSS，不过这样以来文件会先从客户端浏览器上传到我们的服务端tomcat，然后再上传到OSS，效率较低，如图：</p><p><img src="%E4%B9%90%E4%BC%98%E7%94%B5%E5%95%86-04-%E5%93%81%E7%89%8C%E5%9B%BE%E7%89%87%E4%B8%8A%E4%BC%A0-%E5%95%86%E5%93%81%E8%A7%84%E6%A0%BC%E3%80%90OSS%E3%80%91.assets/1575446365802.png" alt="1575446365802"></p><p>以上方法有三个缺点：</p><ul><li>上传慢。先上传到应用服务器，再上传到OSS，网络传送比直传到OSS多了一倍。如果直传到OSS，不通过应用服务器，速度将大大提升，而且OSS采用BGP带宽，能保证各地各运营商的速度。</li><li>扩展性差。如果后续用户多了，应用服务器会成为瓶颈。</li><li>费用高。需要准备多台应用服务器。由于OSS上传流量是免费的，如果数据直传到OSS，不通过应用服务器，那么将能省下几台应用服务器。</li></ul><p>在阿里官方的最佳实践中，推荐了更好的做法：</p><p><img src="%E4%B9%90%E4%BC%98%E7%94%B5%E5%95%86-04-%E5%93%81%E7%89%8C%E5%9B%BE%E7%89%87%E4%B8%8A%E4%BC%A0-%E5%95%86%E5%93%81%E8%A7%84%E6%A0%BC%E3%80%90OSS%E3%80%91.assets/1575448077824.png" alt="1575448077824"></p><p>直接从前端（客户端浏览器）上传文件到OSS。</p><h3 id="1）web前端直传分析"><a href="#1）web前端直传分析" class="headerlink" title="1）web前端直传分析"></a>1）web前端直传分析</h3><p>阿里官方文档中，对于web前端直传又给出了3种不同方案：</p><ul><li><a target="_blank" rel="noopener" href="https://help.aliyun.com/document_detail/31925.html?spm=a2c4g.11186623.2.10.6c5762121wgIAS#concept-frd-4gy-5db">JavaScript客户端签名直传</a>：客户端通过JavaScript代码完成签名，然后通过表单直传数据到OSS。</li><li><a target="_blank" rel="noopener" href="https://help.aliyun.com/document_detail/31926.html?spm=a2c4g.11186623.2.11.6c5762121wgIAS#concept-en4-sjy-5db">服务端签名后直传</a>：客户端上传之前，由服务端完成签名，前端获取签名，然后通过表单直传数据到OSS。</li><li><a target="_blank" rel="noopener" href="https://help.aliyun.com/document_detail/31927.html?spm=a2c4g.11186623.2.12.6c5762121wgIAS#concept-qp2-g4y-5db">服务端签名直传并设置上传回调</a>：服务端完成签名，并且服务端设置了上传后回调，然后通过表单直传数据到OSS。OSS回调完成后，再将应用服务器响应结果返回给客户端。</li></ul><p>各自有一些优缺点：</p><ul><li>JavaScript客户端签名直传：<ul><li>优点：在客户端通过JavaScript代码完成签名，无需过多配置，即可实现直传，非常方便。</li><li>问题：客户端通过JavaScript把AccesssKeyID 和AccessKeySecret写在代码里面有泄露的风险</li></ul></li><li>服务端签名，JavaScript客户端直传：<ul><li>优点：Web端向服务端请求签名，然后直接上传，不会对服务端产生压力，而且安全可靠</li><li>问题：服务端无法实时了解用户上传了多少文件，上传了什么文件</li></ul></li><li>服务端签名直传并设置上传回调：<ul><li>优点：包含服务端签名后客户端直传的所有优点，并且可以设置上传回调接口路径。上传结束后，OSS会主动将上传的结果信息发送给回调接口。</li></ul></li></ul><p>经过一番分析，大家觉得我们会选哪种方案？</p><p>这里我们选择第二种，因为我们并不需要了解用户上传的文件的情况。</p><h3 id="2）服务器端签名后直传流程"><a href="#2）服务器端签名后直传流程" class="headerlink" title="2）服务器端签名后直传流程"></a>2）服务器端签名后直传流程</h3><p>服务端签名后直传的原理如下：</p><ol><li>用户发送上传Policy请求到应用服务器（我们的微服务）。</li><li>应用服务器返回上传Policy和签名给用户。</li><li>用户直接上传数据到OSS。</li></ol><p>流程图：</p><p><img src="%E4%B9%90%E4%BC%98%E7%94%B5%E5%95%86-04-%E5%93%81%E7%89%8C%E5%9B%BE%E7%89%87%E4%B8%8A%E4%BC%A0-%E5%95%86%E5%93%81%E8%A7%84%E6%A0%BC%E3%80%90OSS%E3%80%91.assets/1552311833528.png" alt="1552311833528"></p><p>根据上面的流程，我们需要做的事情包括：</p><ul><li>改造文件上传组件，达成下面的目的：<ul><li>上传文件前，向服务端发起请求，获取签名</li><li>上传时，修改上传目的地到阿里OSS服务，并携带上传的签名</li></ul></li><li>编写服务端接口，接收请求，生成签名后返回</li></ul><p>开发思路：</p><p>1）前端点击上传的时候，请求微服务获取签名（修改url，开启oss签名need-signature）<br>2）ly-upload微服务生成签名，返回给前端（参考阿里的Java API生成并返回签名）<br>3）前端再次发起请求，把图片提交到OSS（已经做好）</p><h2 id="11、图片云存储：改造上传组件"><a href="#11、图片云存储：改造上传组件" class="headerlink" title="11、图片云存储：改造上传组件"></a>11、图片云存储：改造上传组件</h2><p>文件上传组件是我们自定义组件，用法可以参考课前资料的：《自定义组件用法》。</p><p>而且，我们的上传组件内部已经实现了对阿里OSS的支持了：</p><p><img src="%E4%B9%90%E4%BC%98%E7%94%B5%E5%95%86-04-%E5%93%81%E7%89%8C%E5%9B%BE%E7%89%87%E4%B8%8A%E4%BC%A0-%E5%95%86%E5%93%81%E8%A7%84%E6%A0%BC%E3%80%90OSS%E3%80%91.assets/1552314430650.png" alt="1552314430650"></p><p>所以我们只需要在<code>BrandForm</code>页面中，给<code>v-upload</code>组件，加上<code>need-signature</code>属性，并且指定一个获取签名的url地址即可：</p><p><img src="%E4%B9%90%E4%BC%98%E7%94%B5%E5%95%86-04-%E5%93%81%E7%89%8C%E5%9B%BE%E7%89%87%E4%B8%8A%E4%BC%A0-%E5%95%86%E5%93%81%E8%A7%84%E6%A0%BC%E3%80%90OSS%E3%80%91.assets/1605839717704.png" alt="1605839717704"></p><p>自定义的上传组件中的核心代码：Upload.vue</p><p><img src="%E4%B9%90%E4%BC%98%E7%94%B5%E5%95%86-04-%E5%93%81%E7%89%8C%E5%9B%BE%E7%89%87%E4%B8%8A%E4%BC%A0-%E5%95%86%E5%93%81%E8%A7%84%E6%A0%BC%E3%80%90OSS%E3%80%91.assets/1552315238995.png" alt="1552315238995"></p><p>这段代码的核心思路：</p><ul><li>判断needSignature是否为true，true代表需要签名，false代表不需要</li><li>如果false，直接上传文件到url</li><li>如果为true，则把url作为签名接口路径，访问获取签名</li><li>拿到响应结果后，其中可不仅仅包括签名，而是包括：<ul><li>host：上传到阿里的url路径（<strong>bucket + endpoint</strong>）</li><li>policy：上传的策略</li><li>signature：签名</li><li>accessId：就是AccessKeyID</li><li>dir：在oss的bucket中的子文件夹的名称，可以不写。</li></ul></li></ul><p>因此我们需要在签名返回时，携带这些参数。</p><p>刷新页面，可以看到请求已经发出：</p><p><img src="%E4%B9%90%E4%BC%98%E7%94%B5%E5%95%86-04-%E5%93%81%E7%89%8C%E5%9B%BE%E7%89%87%E4%B8%8A%E4%BC%A0-%E5%95%86%E5%93%81%E8%A7%84%E6%A0%BC%E3%80%90OSS%E3%80%91.assets/1552315014021.png" alt="1552315014021"></p><h2 id="12、图片云存储：OSS上传处理器编写"><a href="#12、图片云存储：OSS上传处理器编写" class="headerlink" title="12、图片云存储：OSS上传处理器编写"></a>12、图片云存储：OSS上传处理器编写</h2><p>查看接口文档：</p><p><img src="%E4%B9%90%E4%BC%98%E7%94%B5%E5%95%86-04-%E5%93%81%E7%89%8C%E5%9B%BE%E7%89%87%E4%B8%8A%E4%BC%A0-%E5%95%86%E5%93%81%E8%A7%84%E6%A0%BC%E3%80%90OSS%E3%80%91.assets/1575449278319.png" alt="1575449278319"></p><p>按照接口文档在ly-upload项目的UploadController，添加getOssSignature方法</p><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token comment">/**
     * 生成阿里云的OSS签名
     */</span>
    <span class="token annotation punctuation">@GetMapping</span><span class="token punctuation">(</span><span class="token string">"/signature"</span><span class="token punctuation">)</span>
    <span class="token keyword">public</span> <span class="token class-name">ResponseEntity</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Map</span><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">String</span><span class="token punctuation">&gt;</span><span class="token punctuation">&gt;</span></span> <span class="token function">signature</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> resultMap <span class="token operator">=</span> uploadService<span class="token punctuation">.</span><span class="token function">signature</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token class-name">ResponseEntity</span><span class="token punctuation">.</span><span class="token function">ok</span><span class="token punctuation">(</span>resultMap<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h2 id="13、图片云存储：OSS上传后台业务层代码"><a href="#13、图片云存储：OSS上传后台业务层代码" class="headerlink" title="13、图片云存储：OSS上传后台业务层代码(*)"></a>13、图片云存储：OSS上传后台业务层代码(*)</h2><p>接下来需要写业务层代码，但是这些代码应该是阿里云提供的，它也确实提供了相应的代码：</p><p>下面给出了一段示例代码：</p><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">protected</span> <span class="token keyword">void</span> <span class="token function">doGet</span><span class="token punctuation">(</span><span class="token class-name">HttpServletRequest</span> request<span class="token punctuation">,</span> <span class="token class-name">HttpServletResponse</span> response<span class="token punctuation">)</span>
    <span class="token keyword">throws</span> <span class="token class-name">ServletException</span><span class="token punctuation">,</span> <span class="token class-name">IOException</span> <span class="token punctuation">{</span>

    <span class="token class-name">String</span> accessId <span class="token operator">=</span> <span class="token string">"&lt;yourAccessKeyId&gt;"</span><span class="token punctuation">;</span> <span class="token comment">// 请填写您的AccessKeyId。</span>
    <span class="token class-name">String</span> accessKey <span class="token operator">=</span> <span class="token string">"&lt;yourAccessKeySecret&gt;"</span><span class="token punctuation">;</span> <span class="token comment">// 请填写您的AccessKeySecret。</span>
    <span class="token class-name">String</span> endpoint <span class="token operator">=</span> <span class="token string">"oss-cn-hangzhou.aliyuncs.com"</span><span class="token punctuation">;</span> <span class="token comment">// 请填写您的 endpoint。</span>
    <span class="token class-name">String</span> bucket <span class="token operator">=</span> <span class="token string">"bucket-name"</span><span class="token punctuation">;</span> <span class="token comment">// 请填写您的 bucketname 。</span>
    <span class="token class-name">String</span> host <span class="token operator">=</span> <span class="token string">"http://"</span> <span class="token operator">+</span> bucket <span class="token operator">+</span> <span class="token string">"."</span> <span class="token operator">+</span> endpoint<span class="token punctuation">;</span> <span class="token comment">// host的格式为 bucketname.endpoint</span>
    <span class="token comment">// callbackUrl为 上传回调服务器的URL，请将下面的IP和Port配置为您自己的真实信息。</span>
    <span class="token class-name">String</span> callbackUrl <span class="token operator">=</span> <span class="token string">"http://88.88.88.88:8888"</span><span class="token punctuation">;</span>
    <span class="token class-name">String</span> dir <span class="token operator">=</span> <span class="token string">"user-dir-prefix/"</span><span class="token punctuation">;</span> <span class="token comment">// 用户上传文件时指定的前缀。</span>

    <span class="token class-name">OSSClient</span> client <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">OSSClient</span><span class="token punctuation">(</span>endpoint<span class="token punctuation">,</span> accessId<span class="token punctuation">,</span> accessKey<span class="token punctuation">)</span><span class="token punctuation">;</span>
    
    <span class="token keyword">try</span> <span class="token punctuation">{</span>
        <span class="token keyword">long</span> expireTime <span class="token operator">=</span> <span class="token number">30</span><span class="token punctuation">;</span>
        <span class="token keyword">long</span> expireEndTime <span class="token operator">=</span> <span class="token class-name">System</span><span class="token punctuation">.</span><span class="token function">currentTimeMillis</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> expireTime <span class="token operator">*</span> <span class="token number">1000</span><span class="token punctuation">;</span>
        <span class="token class-name">Date</span> expiration <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Date</span><span class="token punctuation">(</span>expireEndTime<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">PolicyConditions</span> policyConds <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">PolicyConditions</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        policyConds<span class="token punctuation">.</span><span class="token function">addConditionItem</span><span class="token punctuation">(</span><span class="token class-name">PolicyConditions</span><span class="token punctuation">.</span>COND_CONTENT_LENGTH_RANGE<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1048576000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        policyConds<span class="token punctuation">.</span><span class="token function">addConditionItem</span><span class="token punctuation">(</span><span class="token class-name">MatchMode<span class="token punctuation">.</span>StartWith</span><span class="token punctuation">,</span> <span class="token class-name">PolicyConditions</span><span class="token punctuation">.</span>COND_KEY<span class="token punctuation">,</span> dir<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token class-name">String</span> postPolicy <span class="token operator">=</span> client<span class="token punctuation">.</span><span class="token function">generatePostPolicy</span><span class="token punctuation">(</span>expiration<span class="token punctuation">,</span> policyConds<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span> binaryData <span class="token operator">=</span> postPolicy<span class="token punctuation">.</span><span class="token function">getBytes</span><span class="token punctuation">(</span><span class="token string">"utf-8"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">String</span> encodedPolicy <span class="token operator">=</span> <span class="token class-name">BinaryUtil</span><span class="token punctuation">.</span><span class="token function">toBase64String</span><span class="token punctuation">(</span>binaryData<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">String</span> postSignature <span class="token operator">=</span> client<span class="token punctuation">.</span><span class="token function">calculatePostSignature</span><span class="token punctuation">(</span>postPolicy<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> respMap <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">LinkedHashMap</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">String</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        respMap<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">"accessid"</span><span class="token punctuation">,</span> accessId<span class="token punctuation">)</span><span class="token punctuation">;</span>
        respMap<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">"policy"</span><span class="token punctuation">,</span> encodedPolicy<span class="token punctuation">)</span><span class="token punctuation">;</span>
        respMap<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">"signature"</span><span class="token punctuation">,</span> postSignature<span class="token punctuation">)</span><span class="token punctuation">;</span>
        respMap<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">"dir"</span><span class="token punctuation">,</span> dir<span class="token punctuation">)</span><span class="token punctuation">;</span>
        respMap<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">"host"</span><span class="token punctuation">,</span> host<span class="token punctuation">)</span><span class="token punctuation">;</span>
        respMap<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">"expire"</span><span class="token punctuation">,</span> <span class="token class-name">String</span><span class="token punctuation">.</span><span class="token function">valueOf</span><span class="token punctuation">(</span>expireEndTime <span class="token operator">/</span> <span class="token number">1000</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// respMap.put("expire", formatISO8601Date(expiration));</span>

        <span class="token class-name">JSONObject</span> jasonCallback <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">JSONObject</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        jasonCallback<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">"callbackUrl"</span><span class="token punctuation">,</span> callbackUrl<span class="token punctuation">)</span><span class="token punctuation">;</span>
        jasonCallback<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">"callbackBody"</span><span class="token punctuation">,</span>
                          <span class="token string">"filename=${object}&amp;size=${size}&amp;mimeType=${mimeType}&amp;height=${imageInfo.height}&amp;width=${imageInfo.width}"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        jasonCallback<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">"callbackBodyType"</span><span class="token punctuation">,</span> <span class="token string">"application/x-www-form-urlencoded"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">String</span> base64CallbackBody <span class="token operator">=</span> <span class="token class-name">BinaryUtil</span><span class="token punctuation">.</span><span class="token function">toBase64String</span><span class="token punctuation">(</span>jasonCallback<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getBytes</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        respMap<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">"callback"</span><span class="token punctuation">,</span> base64CallbackBody<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token class-name">JSONObject</span> ja1 <span class="token operator">=</span> <span class="token class-name">JSONObject</span><span class="token punctuation">.</span><span class="token function">fromObject</span><span class="token punctuation">(</span>respMap<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// System.out.println(ja1.toString());</span>
        response<span class="token punctuation">.</span><span class="token function">setHeader</span><span class="token punctuation">(</span><span class="token string">"Access-Control-Allow-Origin"</span><span class="token punctuation">,</span> <span class="token string">"*"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        response<span class="token punctuation">.</span><span class="token function">setHeader</span><span class="token punctuation">(</span><span class="token string">"Access-Control-Allow-Methods"</span><span class="token punctuation">,</span> <span class="token string">"GET, POST"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">response</span><span class="token punctuation">(</span>request<span class="token punctuation">,</span> response<span class="token punctuation">,</span> ja1<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// Assert.fail(e.getMessage());</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>e<span class="token punctuation">.</span><span class="token function">getMessage</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>可以看到代码分4部分：</p><ul><li>初始化OSSClient，这是阿里SDK提供的工具</li><li>生成文件上传策略policy（文件大小、文件存储目录等）</li><li>生成许可签名</li><li>封装结果并返回</li></ul><p>接下来，我们逐个完成。</p><h3 id="1）引入阿里sdk的依赖"><a href="#1）引入阿里sdk的依赖" class="headerlink" title="1）引入阿里sdk的依赖"></a>1）引入阿里sdk的依赖</h3><pre class="line-numbers language-xml" data-language="xml"><code class="language-xml"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>com.aliyun.oss<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>aliyun-sdk-oss<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>version</span><span class="token punctuation">&gt;</span></span>3.4.2<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>version</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>scope</span><span class="token punctuation">&gt;</span></span>compile<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>scope</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="2）抽取签名配置"><a href="#2）抽取签名配置" class="headerlink" title="2）抽取签名配置"></a>2）抽取签名配置</h3><p>上面的示例代码中，把很多的配置硬编码到代码中，我们统一抽取放到application.yml中</p><pre class="line-numbers language-yaml" data-language="yaml"><code class="language-yaml"><span class="token key atrule">ly</span><span class="token punctuation">:</span>
  <span class="token key atrule">oss</span><span class="token punctuation">:</span>
    <span class="token key atrule">accessKeyId</span><span class="token punctuation">:</span> LTAID13FA8uCV
    <span class="token key atrule">accessKeySecret</span><span class="token punctuation">:</span> CgWgVzbulWQ2fagXvScAmYBniQL
    <span class="token key atrule">host</span><span class="token punctuation">:</span> http<span class="token punctuation">:</span>//ly<span class="token punctuation">-</span>upload<span class="token punctuation">-</span>server.oss<span class="token punctuation">-</span>cn<span class="token punctuation">-</span>shenzhen.aliyuncs.com <span class="token comment"># 访问oss的域名，很重要bucket + endpoint</span>
    <span class="token key atrule">endpoint</span><span class="token punctuation">:</span> oss<span class="token punctuation">-</span>cn<span class="token punctuation">-</span>shenzhen.aliyuncs.com <span class="token comment"># 你的服务的端点，不一定跟我一样</span>
    <span class="token key atrule">dir</span><span class="token punctuation">:</span> <span class="token string">""</span> <span class="token comment"># 保存到bucket的某个子目录</span>
    <span class="token key atrule">expireTime</span><span class="token punctuation">:</span> <span class="token number">20</span> <span class="token comment"># 过期时间，单位是S</span>
    <span class="token key atrule">maxFileSize</span><span class="token punctuation">:</span> <span class="token number">5242880</span> <span class="token comment">#文件大小限制，这里是5M</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="3）编写配置类加载配置"><a href="#3）编写配置类加载配置" class="headerlink" title="3）编写配置类加载配置"></a>3）编写配置类加载配置</h3><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">package</span> <span class="token namespace">com<span class="token punctuation">.</span>leyou<span class="token punctuation">.</span>upload<span class="token punctuation">.</span>config</span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token namespace">lombok<span class="token punctuation">.</span></span><span class="token class-name">Data</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>boot<span class="token punctuation">.</span>context<span class="token punctuation">.</span>properties<span class="token punctuation">.</span></span><span class="token class-name">ConfigurationProperties</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>stereotype<span class="token punctuation">.</span></span><span class="token class-name">Component</span><span class="token punctuation">;</span>

<span class="token comment">/**
 * 读取Oss相关配置
 *  让@ConfigurationProperties注解生效两种方法：
 *     1）在启动类使用@EnableConfigurationProperties(OssProperties.class)开启配置读取
 *     2）在当前类上直接使用@Component注解
 */</span>
<span class="token annotation punctuation">@Data</span>
<span class="token annotation punctuation">@Component</span>
<span class="token annotation punctuation">@ConfigurationProperties</span><span class="token punctuation">(</span>prefix <span class="token operator">=</span> <span class="token string">"ly.oss"</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">OssProperties</span> <span class="token punctuation">{</span>
    <span class="token keyword">private</span> <span class="token class-name">String</span> accessKeyId<span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token class-name">String</span> accessKeySecret<span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token class-name">String</span> host<span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token class-name">String</span> endpoint<span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token class-name">String</span> dir<span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token class-name">Long</span> expireTime<span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token class-name">Long</span> maxFileSize<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="4）生成签名客户端"><a href="#4）生成签名客户端" class="headerlink" title="4）生成签名客户端"></a>4）生成签名客户端</h3><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">package</span> <span class="token namespace">com<span class="token punctuation">.</span>leyou<span class="token punctuation">.</span>upload<span class="token punctuation">.</span>config</span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token namespace">com<span class="token punctuation">.</span>aliyun<span class="token punctuation">.</span>oss<span class="token punctuation">.</span></span>OSS<span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">com<span class="token punctuation">.</span>aliyun<span class="token punctuation">.</span>oss<span class="token punctuation">.</span></span><span class="token class-name">OSSClientBuilder</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>beans<span class="token punctuation">.</span>factory<span class="token punctuation">.</span>annotation<span class="token punctuation">.</span></span><span class="token class-name">Autowired</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>beans<span class="token punctuation">.</span>factory<span class="token punctuation">.</span>annotation<span class="token punctuation">.</span></span><span class="token class-name">Qualifier</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>context<span class="token punctuation">.</span>annotation<span class="token punctuation">.</span></span><span class="token class-name">Bean</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>context<span class="token punctuation">.</span>annotation<span class="token punctuation">.</span></span><span class="token class-name">Configuration</span><span class="token punctuation">;</span>

<span class="token comment">/**
 * Oss初始化工具类对象配置
 */</span>
<span class="token annotation punctuation">@Configuration</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">OssConfig</span> <span class="token punctuation">{</span>
    <span class="token comment">/*
    @Autowired
    private OssProperties ossProps*/</span><span class="token punctuation">;</span>

    <span class="token comment">/**
     * 注意：在@Bean的方法的参数上面可以直接注入IOC容器的对象，不需要任何注解
     * @param ossProps
     * @return
     */</span>
    <span class="token annotation punctuation">@Bean</span>
    <span class="token keyword">public</span> <span class="token class-name">OSS</span> <span class="token function">createOss</span><span class="token punctuation">(</span><span class="token class-name">OssProperties</span> ossProps<span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">OSSClientBuilder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span>
                ossProps<span class="token punctuation">.</span><span class="token function">getEndpoint</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> 
                ossProps<span class="token punctuation">.</span><span class="token function">getAccessKeyId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> 
                ossProps<span class="token punctuation">.</span><span class="token function">getAccessKeySecret</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

<span class="token punctuation">}</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="5）业务层代码添加如下内容"><a href="#5）业务层代码添加如下内容" class="headerlink" title="5）业务层代码添加如下内容"></a>5）业务层代码添加如下内容</h3><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">public</span> <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> <span class="token function">signature</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">try</span> <span class="token punctuation">{</span>
            <span class="token keyword">long</span> expireTime <span class="token operator">=</span> ossProps<span class="token punctuation">.</span><span class="token function">getExpireTime</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">long</span> expireEndTime <span class="token operator">=</span> <span class="token class-name">System</span><span class="token punctuation">.</span><span class="token function">currentTimeMillis</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> expireTime <span class="token operator">*</span> <span class="token number">1000</span><span class="token punctuation">;</span>
            <span class="token class-name">Date</span> expiration <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Date</span><span class="token punctuation">(</span>expireEndTime<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">// PostObject请求最大可支持的文件大小为5 GB，即CONTENT_LENGTH_RANGE为5*1024*1024*1024。</span>
            <span class="token class-name">PolicyConditions</span> policyConds <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">PolicyConditions</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            policyConds<span class="token punctuation">.</span><span class="token function">addConditionItem</span><span class="token punctuation">(</span><span class="token class-name">PolicyConditions</span><span class="token punctuation">.</span>COND_CONTENT_LENGTH_RANGE<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> ossProps<span class="token punctuation">.</span><span class="token function">getMaxFileSize</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            policyConds<span class="token punctuation">.</span><span class="token function">addConditionItem</span><span class="token punctuation">(</span><span class="token class-name">MatchMode<span class="token punctuation">.</span>StartWith</span><span class="token punctuation">,</span> <span class="token class-name">PolicyConditions</span><span class="token punctuation">.</span>COND_KEY<span class="token punctuation">,</span> ossProps<span class="token punctuation">.</span><span class="token function">getDir</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token class-name">String</span> postPolicy <span class="token operator">=</span> ossClient<span class="token punctuation">.</span><span class="token function">generatePostPolicy</span><span class="token punctuation">(</span>expiration<span class="token punctuation">,</span> policyConds<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span> binaryData <span class="token operator">=</span> postPolicy<span class="token punctuation">.</span><span class="token function">getBytes</span><span class="token punctuation">(</span><span class="token string">"utf-8"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token class-name">String</span> encodedPolicy <span class="token operator">=</span> <span class="token class-name">BinaryUtil</span><span class="token punctuation">.</span><span class="token function">toBase64String</span><span class="token punctuation">(</span>binaryData<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token class-name">String</span> postSignature <span class="token operator">=</span> ossClient<span class="token punctuation">.</span><span class="token function">calculatePostSignature</span><span class="token punctuation">(</span>postPolicy<span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> respMap <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">LinkedHashMap</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">String</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            respMap<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">"accessId"</span><span class="token punctuation">,</span> ossProps<span class="token punctuation">.</span><span class="token function">getAccessKeyId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//注意：这个accessId必须和Upload.vue页面的key一致</span>
            respMap<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">"policy"</span><span class="token punctuation">,</span> encodedPolicy<span class="token punctuation">)</span><span class="token punctuation">;</span>
            respMap<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">"signature"</span><span class="token punctuation">,</span> postSignature<span class="token punctuation">)</span><span class="token punctuation">;</span>
            respMap<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">"dir"</span><span class="token punctuation">,</span> ossProps<span class="token punctuation">.</span><span class="token function">getDir</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            respMap<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">"host"</span><span class="token punctuation">,</span> ossProps<span class="token punctuation">.</span><span class="token function">getHost</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            respMap<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">"expire"</span><span class="token punctuation">,</span> <span class="token class-name">String</span><span class="token punctuation">.</span><span class="token function">valueOf</span><span class="token punctuation">(</span>expireEndTime<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//注意：因为Upload.vue页面使用毫秒单位来判断超时时间</span>

            <span class="token keyword">return</span> respMap<span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>e<span class="token punctuation">.</span><span class="token function">getMessage</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">LyException</span><span class="token punctuation">(</span><span class="token class-name">ExceptionEnum</span><span class="token punctuation">.</span>INVALID_NOTIFY_SIGN<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{</span>
            ossClient<span class="token punctuation">.</span><span class="token function">shutdown</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="6）重启微服务测试"><a href="#6）重启微服务测试" class="headerlink" title="6）重启微服务测试"></a>6）重启微服务测试</h3><p><img src="%E4%B9%90%E4%BC%98%E7%94%B5%E5%95%86-04-%E5%93%81%E7%89%8C%E5%9B%BE%E7%89%87%E4%B8%8A%E4%BC%A0-%E5%95%86%E5%93%81%E8%A7%84%E6%A0%BC%E3%80%90OSS%E3%80%91.assets/1575454168088.png" alt="1575454168088"></p><h2 id="14、图片云存储：隐藏阿里云的url地址"><a href="#14、图片云存储：隐藏阿里云的url地址" class="headerlink" title="14、图片云存储：隐藏阿里云的url地址"></a>14、图片云存储：隐藏阿里云的url地址</h2><p>在刚才的业务中，我们直接把我们在阿里的域名对外暴露了，如果要隐藏域名信息，我们可以使用一个自定义域名。</p><p>另外，最好保持与我们自己的域名一致，我们可以使用：<code>http://image.leyou.com</code>，然后使用nginx反向代理，最终再指向阿里服务器域名。</p><p>首先，修改服务器端返回的请求域名，修改ly-upload项目中的application.yml文件：</p><pre class="line-numbers language-yaml" data-language="yaml"><code class="language-yaml"><span class="token key atrule">ly</span><span class="token punctuation">:</span>
  <span class="token key atrule">oss</span><span class="token punctuation">:</span>
    <span class="token key atrule">host</span><span class="token punctuation">:</span> http<span class="token punctuation">:</span>//image.leyou.com<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre><p>然后在nginx中设置反向代理leyou.conf：</p><pre class="line-numbers language-nginx" data-language="nginx"><code class="language-nginx"><span class="token keyword">server</span> <span class="token punctuation">{</span>
	<span class="token keyword">listen</span>       <span class="token number">80</span><span class="token punctuation">;</span>
	<span class="token keyword">server_name</span>  image<span class="token punctuation">.</span>leyou<span class="token punctuation">.</span>com<span class="token punctuation">;</span>
	<span class="token keyword">location</span> <span class="token operator">/</span> <span class="token punctuation">{</span>
		<span class="token keyword">proxy_pass</span>   <span class="token keyword">http</span><span class="token punctuation">:</span><span class="token operator">/</span><span class="token operator">/</span>ly<span class="token operator">-</span>upload<span class="token operator">-</span><span class="token keyword">server</span><span class="token punctuation">.</span>oss<span class="token operator">-</span>cn<span class="token operator">-</span>shenzhen<span class="token punctuation">.</span>aliyuncs<span class="token punctuation">.</span>com<span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>重启后测试，一切OK</p><p><img src="%E4%B9%90%E4%BC%98%E7%94%B5%E5%95%86-04-%E5%93%81%E7%89%8C%E5%9B%BE%E7%89%87%E4%B8%8A%E4%BC%A0-%E5%95%86%E5%93%81%E8%A7%84%E6%A0%BC%E3%80%90OSS%E3%80%91.assets/1575454842821.png" alt="1575454842821"></p><h2 id="15、商品规格：规格组和规格参数表结构说明"><a href="#15、商品规格：规格组和规格参数表结构说明" class="headerlink" title="15、商品规格：规格组和规格参数表结构说明"></a>15、商品规格：规格组和规格参数表结构说明</h2><h3 id="1）规格属性内容"><a href="#1）规格属性内容" class="headerlink" title="1）规格属性内容"></a>1）规格属性内容</h3><p>商品中都有属性，不同商品，属性往往不同，这一部分数据很重要，我们一起来看看：</p><p>我们看下京东中商品的规格属性：</p><p>一款华为手机的属性：</p><p><img src="%E4%B9%90%E4%BC%98%E7%94%B5%E5%95%86-04-%E5%93%81%E7%89%8C%E5%9B%BE%E7%89%87%E4%B8%8A%E4%BC%A0-%E5%95%86%E5%93%81%E8%A7%84%E6%A0%BC%E3%80%90OSS%E3%80%91.assets/1575455655488.png" alt="1575455655488"></p><p>一款空调的属性：</p><p><img src="%E4%B9%90%E4%BC%98%E7%94%B5%E5%95%86-04-%E5%93%81%E7%89%8C%E5%9B%BE%E7%89%87%E4%B8%8A%E4%BC%A0-%E5%95%86%E5%93%81%E8%A7%84%E6%A0%BC%E3%80%90OSS%E3%80%91.assets/1575455706369.png" alt="1575455706369"></p><p>我们发现，不同商品的属性名称竟然不同，假如我们要把属性放入一张表去保存，表字段该如何设计？</p><p>别着急，我们再看另一个手机的属性：</p><p>三星手机的规格属性：</p><p><img src="%E4%B9%90%E4%BC%98%E7%94%B5%E5%95%86-04-%E5%93%81%E7%89%8C%E5%9B%BE%E7%89%87%E4%B8%8A%E4%BC%A0-%E5%95%86%E5%93%81%E8%A7%84%E6%A0%BC%E3%80%90OSS%E3%80%91.assets/1526087142454.png" alt="1526087142454"></p><p>我们发现，虽然不同商品，规格不同。但是同一分类的商品，比如都是手机，其规格参数名称是一致的，但是值不一样。</p><p>也就是说，商品的规格参数应该是与分类绑定的。<strong>每一个分类都有统一的规格参数模板，但不同商品其参数值可能不同</strong>。</p><p>因此：</p><ul><li>规格参数的名称（key）与值（value）应该分开来保存</li><li>一个分类，对应一套规格参数模板，只有规格参数key，没有值</li><li>一个分类对应多个商品，每个商品的规格值不同，每个商品对应一套规格的值</li></ul><h3 id="2）规格与规格组"><a href="#2）规格与规格组" class="headerlink" title="2）规格与规格组"></a>2）规格与规格组</h3><p>值我们暂且不管，新增商品时，再来填写规格参数值即可，我们先思考<strong>规格参数模板</strong>（key）该如何设计。</p><p>来看下规格参数的结构：</p><p><img src="%E4%B9%90%E4%BC%98%E7%94%B5%E5%95%86-04-%E5%93%81%E7%89%8C%E5%9B%BE%E7%89%87%E4%B8%8A%E4%BC%A0-%E5%95%86%E5%93%81%E8%A7%84%E6%A0%BC%E3%80%90OSS%E3%80%91.assets/1534634716761.png" alt="1534634716761"></p><ul><li>规格数据首先要分组，组内再有不同的规格参数</li><li>一个分类规格模板中，有多个规格组</li><li>每个规格组中，包含多个规格参数</li></ul><p>从面向对象的思想来看，我们规格参数和规格组分别是两类事务，并且组与组内参数成<strong>一对多关系</strong>，因此可以有两个类分别描述他们，那么从数据库设计来看，也就对应两张不同的表：</p><ul><li>规格组：tb_spec_group<ul><li>一个商品分类下有多个规格组</li></ul></li><li>规格参数：tb_spec_param<ul><li>一个规格组下，有多个规格参数</li></ul></li></ul><p>如图：</p><p><img src="%E4%B9%90%E4%BC%98%E7%94%B5%E5%95%86-04-%E5%93%81%E7%89%8C%E5%9B%BE%E7%89%87%E4%B8%8A%E4%BC%A0-%E5%95%86%E5%93%81%E8%A7%84%E6%A0%BC%E3%80%90OSS%E3%80%91.assets/1534636185452.png" alt="1534636185452"></p><p>大家接下来要思考的就是：</p><ul><li>描述规格组需要哪些属性？</li><li>描述规格参数需要哪些属性？</li></ul><p>想清楚上面的问题，就知道表该怎么设计了。</p><h3 id="3）规格组表结构"><a href="#3）规格组表结构" class="headerlink" title="3）规格组表结构"></a>3）规格组表结构</h3><p>规格参数分组表：tb_spec_group</p><pre class="line-numbers language-mysql" data-language="mysql"><code class="language-mysql">CREATE TABLE `tb_spec_group` (
  `id` bigint(20) NOT NULL AUTO_INCREMENT COMMENT '主键',
  `cid` bigint(20) NOT NULL COMMENT '商品分类id，一个分类下有多个规格组',
  `name` varchar(32) NOT NULL COMMENT '规格组的名称',
  `create_time` timestamp NULL DEFAULT CURRENT_TIMESTAMP,
  `update_time` timestamp NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
  PRIMARY KEY (`id`),
  KEY `key_category` (`cid`)
) ENGINE=InnoDB AUTO_INCREMENT=15 DEFAULT CHARSET=utf8 COMMENT='规格参数的分组表，每个商品分类下有多个规格参数组';<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>规格组有3个字段：</p><ul><li>id：主键</li><li>cid：商品分类id，一个分类下有多个模板</li><li>name：该规格组的名称。</li></ul><h3 id="4）规格参数表结构"><a href="#4）规格参数表结构" class="headerlink" title="4）规格参数表结构"></a>4）规格参数表结构</h3><p>规格参数表：tb_spec_param</p><pre class="line-numbers language-mysql" data-language="mysql"><code class="language-mysql">CREATE TABLE `tb_spec_param` (
  `id` bigint(20) NOT NULL AUTO_INCREMENT COMMENT '主键',
  `cid` bigint(20) NOT NULL COMMENT '商品分类id',
  `group_id` bigint(20) NOT NULL,
  `name` varchar(128) NOT NULL COMMENT '参数名',
  `numeric` tinyint(1) NOT NULL COMMENT '是否是数字类型参数，true或false',
  `unit` varchar(128) DEFAULT '' COMMENT '数字类型参数的单位，非数字类型可以为空',
  `generic` tinyint(1) NOT NULL COMMENT '是否是sku通用属性，true或false',
  `searching` tinyint(1) NOT NULL COMMENT '是否用于搜索过滤，true或false',
  `segments` varchar(1024) DEFAULT '' COMMENT '数值类型参数，如果需要搜索，则添加分段间隔值，如CPU频率间隔：0.5-1.0',
  `create_time` timestamp NULL DEFAULT CURRENT_TIMESTAMP,
  `update_time` timestamp NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
  PRIMARY KEY (`id`),
  KEY `key_group` (`group_id`),
  KEY `key_category` (`cid`)
) ENGINE=InnoDB AUTO_INCREMENT=24 DEFAULT CHARSET=utf8 COMMENT='规格参数组下的参数名';<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>按道理来说，我们的规格参数就只需要记录参数名、组id、商品分类id即可。但是这里却多出了很多字段，为什么？</p><h4 id="数值类型"><a href="#数值类型" class="headerlink" title="数值类型"></a>数值类型</h4><p>某些规格参数可能为数值类型，我们需要标记出来，并且记录单位：</p><p>​ <img src="%E4%B9%90%E4%BC%98%E7%94%B5%E5%95%86-04-%E5%93%81%E7%89%8C%E5%9B%BE%E7%89%87%E4%B8%8A%E4%BC%A0-%E5%95%86%E5%93%81%E8%A7%84%E6%A0%BC%E3%80%90OSS%E3%80%91.assets/1534636623281.png" alt="1534636623281"></p><p>我们有两个字段来描述：</p><ul><li>numberic：是否为数值类型<ul><li>true：数值类型</li><li>false：不是数值类型</li></ul></li><li>unit：参数的单位</li></ul><h4 id="搜索过滤"><a href="#搜索过滤" class="headerlink" title="搜索过滤"></a>搜索过滤</h4><p>打开一个搜索页，我们来看看过滤的条件：</p><p><img src="%E4%B9%90%E4%BC%98%E7%94%B5%E5%95%86-04-%E5%93%81%E7%89%8C%E5%9B%BE%E7%89%87%E4%B8%8A%E4%BC%A0-%E5%95%86%E5%93%81%E8%A7%84%E6%A0%BC%E3%80%90OSS%E3%80%91.assets/1526090072535.png" alt="1526090072535"></p><p>你会发现，过滤条件中的屏幕尺寸、运行内存、网路、机身内存、电池容量、CPU核数等，在规格参数中都能找到：</p><p><img src="%E4%B9%90%E4%BC%98%E7%94%B5%E5%95%86-04-%E5%93%81%E7%89%8C%E5%9B%BE%E7%89%87%E4%B8%8A%E4%BC%A0-%E5%95%86%E5%93%81%E8%A7%84%E6%A0%BC%E3%80%90OSS%E3%80%91.assets/1526090228171.png" alt="1526090228171"></p><p>也就是说，规格参数中的数据，将来会有一部分作为搜索条件来使用。我们可以在设计时，将这部分属性标记出来，将来做搜索的时候，作为过滤条件。</p><p>与搜索相关的有两个字段：</p><ul><li>searching：标记是否用作过滤<ul><li>true：用于过滤搜索</li><li>false：不用于过滤</li></ul></li><li>segments：某些数值类型的参数，在搜索时需要按区间划分，这里提前确定好划分区间<ul><li>比如电池容量，0<del>2000mAh，2000mAh</del>3000mAh，3000mAh~4000mAh</li></ul></li></ul><p>乐优商城是一个全品类的电商网站，因此商品的种类繁多，每一件商品，其属性又有差别。为了更准确描述商品及细分差别，抽象出两个概念：SPU和SKU，了解一下。</p><h4 id="通用属性"><a href="#通用属性" class="headerlink" title="通用属性"></a>通用属性</h4><p>有一个generic属性，代表通用属性，我们在商品数据结构时再聊。</p><h2 id="16、商品规格：商品规格模块准备工作"><a href="#16、商品规格：商品规格模块准备工作" class="headerlink" title="16、商品规格：商品规格模块准备工作"></a>16、商品规格：商品规格模块准备工作</h2><h3 id="1）页面请求"><a href="#1）页面请求" class="headerlink" title="1）页面请求"></a>1）页面请求</h3><p>首先是规格组管理，我们点击菜单中的<code>规格参数</code>：</p><p><img src="%E4%B9%90%E4%BC%98%E7%94%B5%E5%95%86-04-%E5%93%81%E7%89%8C%E5%9B%BE%E7%89%87%E4%B8%8A%E4%BC%A0-%E5%95%86%E5%93%81%E8%A7%84%E6%A0%BC%E3%80%90OSS%E3%80%91.assets/1575532225534.png" alt="1575532225534"></p><p>打开规格参数页面，可以看到页面发生了变化，看到如下内容：</p><p><img src="%E4%B9%90%E4%BC%98%E7%94%B5%E5%95%86-04-%E5%93%81%E7%89%8C%E5%9B%BE%E7%89%87%E4%B8%8A%E4%BC%A0-%E5%95%86%E5%93%81%E8%A7%84%E6%A0%BC%E3%80%90OSS%E3%80%91.assets/1552659142800.png" alt="1552659142800"></p><p>可以看到规格参数页面的左侧是一个商品分类的树，右侧暂时是空白。那么问题来了：</p><p>我们这里是规格管理，为什么会显示商品分类信息呢？</p><p>因为规格是跟商品分类绑定的，我们在看到规格参数时，肯定希望知道接下来要管理的是哪个分类下的规格参数。</p><p>所以首先会展现商品分类树，并且提示你要选择商品分类，才能看到规格参数的模板。</p><p>此时，我们点击分类，当点击到某个3级分类时，页面发生了变化：</p><p>页面右侧出现了数据表格，不过还没有数据。同时，我们查看页面控制台，可以看到请求已经发出：</p><p><img src="%E4%B9%90%E4%BC%98%E7%94%B5%E5%95%86-04-%E5%93%81%E7%89%8C%E5%9B%BE%E7%89%87%E4%B8%8A%E4%BC%A0-%E5%95%86%E5%93%81%E8%A7%84%E6%A0%BC%E3%80%90OSS%E3%80%91.assets/1552488184332.png" alt="1552488184332"></p><p>这个请求查询的应该就是当前分类下的规格参数组信息了。</p><p>规格组的数据有了，但是我们点击的菜单是==规格参数==，那规格参数在哪里显示呢？</p><p>当我们选中<code>主体</code>这个规格组时，其它规格组信息都隐藏了，表格变成了一个空白表格。</p><p>通过表头可以看出，这个表格显示的应该是<code>主体</code>这个规格组内的规格参数信息。</p><p>此时查看控制台，发现页面发起了新的请求：</p><p><img src="%E4%B9%90%E4%BC%98%E7%94%B5%E5%95%86-04-%E5%93%81%E7%89%8C%E5%9B%BE%E7%89%87%E4%B8%8A%E4%BC%A0-%E5%95%86%E5%93%81%E8%A7%84%E6%A0%BC%E3%80%90OSS%E3%80%91.assets/1552661146177.png" alt="1552661146177"></p><p>可以看出，这个是根据规格组的id，查询规格参数的请求</p><p><font size="5"><b>页面显示说明：</b></font></p><p>==<strong>所以第一步我们要先展示规格组，第二步点击了具体的规格组后，再根据规格组id去查询规格参数</strong>==</p><p><img src="%E4%B9%90%E4%BC%98%E7%94%B5%E5%95%86-04-%E5%93%81%E7%89%8C%E5%9B%BE%E7%89%87%E4%B8%8A%E4%BC%A0-%E5%95%86%E5%93%81%E8%A7%84%E6%A0%BC%E3%80%90OSS%E3%80%91.assets/1575536583343.png" alt="1575536583343"></p><h3 id="2）规格组entity对象"><a href="#2）规格组entity对象" class="headerlink" title="2）规格组entity对象"></a>2）规格组entity对象</h3><p>中添加实体类：</p><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">package</span> <span class="token namespace">com<span class="token punctuation">.</span>leyou<span class="token punctuation">.</span>item<span class="token punctuation">.</span>entity</span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token namespace">com<span class="token punctuation">.</span>baomidou<span class="token punctuation">.</span>mybatisplus<span class="token punctuation">.</span>annotation<span class="token punctuation">.</span></span><span class="token class-name">IdType</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">com<span class="token punctuation">.</span>baomidou<span class="token punctuation">.</span>mybatisplus<span class="token punctuation">.</span>annotation<span class="token punctuation">.</span></span><span class="token class-name">TableId</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">com<span class="token punctuation">.</span>baomidou<span class="token punctuation">.</span>mybatisplus<span class="token punctuation">.</span>annotation<span class="token punctuation">.</span></span><span class="token class-name">TableName</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">lombok<span class="token punctuation">.</span></span><span class="token class-name">Data</span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span></span><span class="token class-name">Date</span><span class="token punctuation">;</span>

<span class="token annotation punctuation">@Data</span>
<span class="token annotation punctuation">@TableName</span><span class="token punctuation">(</span><span class="token string">"tb_spec_group"</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">SpecGroup</span> <span class="token punctuation">{</span>

    <span class="token annotation punctuation">@TableId</span><span class="token punctuation">(</span>type <span class="token operator">=</span> <span class="token class-name">IdType</span><span class="token punctuation">.</span>AUTO<span class="token punctuation">)</span>
    <span class="token keyword">private</span> <span class="token class-name">Long</span> id<span class="token punctuation">;</span>

    <span class="token keyword">private</span> <span class="token class-name">Long</span> cid<span class="token punctuation">;</span>

    <span class="token keyword">private</span> <span class="token class-name">String</span> name<span class="token punctuation">;</span>

    <span class="token keyword">private</span> <span class="token class-name">Date</span> createTime<span class="token punctuation">;</span>

    <span class="token keyword">private</span> <span class="token class-name">Date</span> updateTime<span class="token punctuation">;</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="3）规格参数entity对象"><a href="#3）规格参数entity对象" class="headerlink" title="3）规格参数entity对象"></a>3）规格参数entity对象</h3><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">package</span> <span class="token namespace">com<span class="token punctuation">.</span>leyou<span class="token punctuation">.</span>item<span class="token punctuation">.</span>entity</span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token namespace">com<span class="token punctuation">.</span>baomidou<span class="token punctuation">.</span>mybatisplus<span class="token punctuation">.</span>annotation<span class="token punctuation">.</span></span><span class="token class-name">IdType</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">com<span class="token punctuation">.</span>baomidou<span class="token punctuation">.</span>mybatisplus<span class="token punctuation">.</span>annotation<span class="token punctuation">.</span></span><span class="token class-name">TableId</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">com<span class="token punctuation">.</span>baomidou<span class="token punctuation">.</span>mybatisplus<span class="token punctuation">.</span>annotation<span class="token punctuation">.</span></span><span class="token class-name">TableName</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">lombok<span class="token punctuation">.</span></span><span class="token class-name">Data</span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span></span><span class="token class-name">Date</span><span class="token punctuation">;</span>

<span class="token annotation punctuation">@Data</span>
<span class="token annotation punctuation">@TableName</span><span class="token punctuation">(</span><span class="token string">"tb_spec_param"</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">SpecParam</span> <span class="token punctuation">{</span>
    <span class="token annotation punctuation">@TableId</span><span class="token punctuation">(</span>type <span class="token operator">=</span> <span class="token class-name">IdType</span><span class="token punctuation">.</span>AUTO<span class="token punctuation">)</span>
    <span class="token keyword">private</span> <span class="token class-name">Long</span> id<span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token class-name">Long</span> cid<span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token class-name">Long</span> groupId<span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token class-name">String</span> name<span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token class-name">Boolean</span> numeric<span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token class-name">String</span> unit<span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token class-name">Boolean</span> generic<span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token class-name">Boolean</span> searching<span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token class-name">String</span> segments<span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token class-name">Date</span> createTime<span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token class-name">Date</span> updateTime<span class="token punctuation">;</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="4）规格组的Mapper"><a href="#4）规格组的Mapper" class="headerlink" title="4）规格组的Mapper"></a>4）规格组的Mapper</h3><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">package</span> <span class="token namespace">com<span class="token punctuation">.</span>leyou<span class="token punctuation">.</span>item<span class="token punctuation">.</span>mapper</span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token namespace">com<span class="token punctuation">.</span>baomidou<span class="token punctuation">.</span>mybatisplus<span class="token punctuation">.</span>core<span class="token punctuation">.</span>mapper<span class="token punctuation">.</span></span><span class="token class-name">BaseMapper</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">com<span class="token punctuation">.</span>leyou<span class="token punctuation">.</span>item<span class="token punctuation">.</span>entity<span class="token punctuation">.</span></span><span class="token class-name">SpecGroup</span><span class="token punctuation">;</span>

<span class="token keyword">public</span> <span class="token keyword">interface</span> <span class="token class-name">SpecGroupMapper</span> <span class="token keyword">extends</span> <span class="token class-name">BaseMapper</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">SpecGroup</span><span class="token punctuation">&gt;</span></span> <span class="token punctuation">{</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="5）规格参数的Mapper"><a href="#5）规格参数的Mapper" class="headerlink" title="5）规格参数的Mapper"></a>5）规格参数的Mapper</h3><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">package</span> <span class="token namespace">com<span class="token punctuation">.</span>leyou<span class="token punctuation">.</span>item<span class="token punctuation">.</span>mapper</span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token namespace">com<span class="token punctuation">.</span>baomidou<span class="token punctuation">.</span>mybatisplus<span class="token punctuation">.</span>core<span class="token punctuation">.</span>mapper<span class="token punctuation">.</span></span><span class="token class-name">BaseMapper</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">com<span class="token punctuation">.</span>leyou<span class="token punctuation">.</span>item<span class="token punctuation">.</span>entity<span class="token punctuation">.</span></span><span class="token class-name">SpecParam</span><span class="token punctuation">;</span>

<span class="token keyword">public</span> <span class="token keyword">interface</span> <span class="token class-name">SpecParamMapper</span> <span class="token keyword">extends</span> <span class="token class-name">BaseMapper</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">SpecParam</span><span class="token punctuation">&gt;</span></span> <span class="token punctuation">{</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="6）商品规格的Service"><a href="#6）商品规格的Service" class="headerlink" title="6）商品规格的Service"></a>6）商品规格的Service</h3><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">package</span> <span class="token namespace">com<span class="token punctuation">.</span>leyou<span class="token punctuation">.</span>item<span class="token punctuation">.</span>service</span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token namespace">com<span class="token punctuation">.</span>leyou<span class="token punctuation">.</span>item<span class="token punctuation">.</span>mapper<span class="token punctuation">.</span></span><span class="token class-name">SpecGroupMapper</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">com<span class="token punctuation">.</span>leyou<span class="token punctuation">.</span>item<span class="token punctuation">.</span>mapper<span class="token punctuation">.</span></span><span class="token class-name">SpecParamMapper</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>beans<span class="token punctuation">.</span>factory<span class="token punctuation">.</span>annotation<span class="token punctuation">.</span></span><span class="token class-name">Autowired</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>stereotype<span class="token punctuation">.</span></span><span class="token class-name">Service</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>transaction<span class="token punctuation">.</span>annotation<span class="token punctuation">.</span></span><span class="token class-name">Transactional</span><span class="token punctuation">;</span>

<span class="token annotation punctuation">@Service</span>
<span class="token annotation punctuation">@Transactional</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">SpecService</span> <span class="token punctuation">{</span>

    <span class="token annotation punctuation">@Autowired</span>
    <span class="token keyword">private</span> <span class="token class-name">SpecGroupMapper</span> groupMapper<span class="token punctuation">;</span>

    <span class="token annotation punctuation">@Autowired</span>
    <span class="token keyword">private</span> <span class="token class-name">SpecParamMapper</span> paramMapper<span class="token punctuation">;</span>

<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>我们现在是准备工作，先把大体代码结构写好，再写具体业务。</p><h3 id="7）商品规格的Controller"><a href="#7）商品规格的Controller" class="headerlink" title="7）商品规格的Controller"></a>7）商品规格的Controller</h3><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">package</span> <span class="token namespace">com<span class="token punctuation">.</span>leyou<span class="token punctuation">.</span>item<span class="token punctuation">.</span>controller</span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token namespace">com<span class="token punctuation">.</span>leyou<span class="token punctuation">.</span>item<span class="token punctuation">.</span>service<span class="token punctuation">.</span></span><span class="token class-name">SpecService</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>beans<span class="token punctuation">.</span>factory<span class="token punctuation">.</span>annotation<span class="token punctuation">.</span></span><span class="token class-name">Autowired</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>web<span class="token punctuation">.</span>bind<span class="token punctuation">.</span>annotation<span class="token punctuation">.</span></span><span class="token class-name">RestController</span><span class="token punctuation">;</span>

<span class="token annotation punctuation">@RestController</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">SpecController</span> <span class="token punctuation">{</span>

    <span class="token annotation punctuation">@Autowired</span>
    <span class="token keyword">private</span> <span class="token class-name">SpecService</span> specService<span class="token punctuation">;</span>

<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>好了，准备工作我们做完了，接下来编写具体的接口代码了！</p><h2 id="17、商品规格：根据分类查询规格组"><a href="#17、商品规格：根据分类查询规格组" class="headerlink" title="17、商品规格：根据分类查询规格组"></a>17、商品规格：根据分类查询规格组</h2><h3 id="1）编写处理器"><a href="#1）编写处理器" class="headerlink" title="1）编写处理器"></a>1）编写处理器</h3><p>在SpecController中添加如下方法</p><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">package</span> <span class="token namespace">com<span class="token punctuation">.</span>leyou<span class="token punctuation">.</span>item<span class="token punctuation">.</span>controller</span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token namespace">com<span class="token punctuation">.</span>leyou<span class="token punctuation">.</span>item<span class="token punctuation">.</span>pojo<span class="token punctuation">.</span></span><span class="token class-name">SpecGroup</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">com<span class="token punctuation">.</span>leyou<span class="token punctuation">.</span>item<span class="token punctuation">.</span>service<span class="token punctuation">.</span></span><span class="token class-name">SpecService</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>beans<span class="token punctuation">.</span>factory<span class="token punctuation">.</span>annotation<span class="token punctuation">.</span></span><span class="token class-name">Autowired</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>http<span class="token punctuation">.</span></span><span class="token class-name">ResponseEntity</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>web<span class="token punctuation">.</span>bind<span class="token punctuation">.</span>annotation<span class="token punctuation">.</span></span><span class="token class-name">GetMapping</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>web<span class="token punctuation">.</span>bind<span class="token punctuation">.</span>annotation<span class="token punctuation">.</span></span><span class="token class-name">RequestParam</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>web<span class="token punctuation">.</span>bind<span class="token punctuation">.</span>annotation<span class="token punctuation">.</span></span><span class="token class-name">RestController</span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span></span><span class="token class-name">List</span><span class="token punctuation">;</span>

<span class="token comment">/**
 * 规格
 */</span>
<span class="token annotation punctuation">@RestController</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">SpecController</span> <span class="token punctuation">{</span>
    <span class="token annotation punctuation">@Autowired</span>
    <span class="token keyword">private</span> <span class="token class-name">SpecService</span> specService<span class="token punctuation">;</span>

    <span class="token comment">/**
     * 根据分类ID查询规格组
     */</span>
    <span class="token annotation punctuation">@GetMapping</span><span class="token punctuation">(</span><span class="token string">"/spec/groups/of/category"</span><span class="token punctuation">)</span>
    <span class="token keyword">public</span> <span class="token class-name">ResponseEntity</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">List</span><span class="token punctuation">&lt;</span><span class="token class-name">SpecGroup</span><span class="token punctuation">&gt;</span><span class="token punctuation">&gt;</span></span> <span class="token function">findSpecGroupsByCid</span><span class="token punctuation">(</span><span class="token annotation punctuation">@RequestParam</span><span class="token punctuation">(</span><span class="token string">"id"</span><span class="token punctuation">)</span> <span class="token class-name">Long</span> id<span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">SpecGroup</span><span class="token punctuation">&gt;</span></span> specGroups <span class="token operator">=</span> specService<span class="token punctuation">.</span><span class="token function">findSpecGroupsByCid</span><span class="token punctuation">(</span>id<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token class-name">ResponseEntity</span><span class="token punctuation">.</span><span class="token function">ok</span><span class="token punctuation">(</span>specGroups<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="2）编写Service"><a href="#2）编写Service" class="headerlink" title="2）编写Service"></a>2）编写Service</h3><p>在SpecService添加如下方法</p><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">package</span> <span class="token namespace">com<span class="token punctuation">.</span>leyou<span class="token punctuation">.</span>item<span class="token punctuation">.</span>service</span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token namespace">com<span class="token punctuation">.</span>baomidou<span class="token punctuation">.</span>mybatisplus<span class="token punctuation">.</span>core<span class="token punctuation">.</span>conditions<span class="token punctuation">.</span>query<span class="token punctuation">.</span></span><span class="token class-name">QueryWrapper</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">com<span class="token punctuation">.</span>baomidou<span class="token punctuation">.</span>mybatisplus<span class="token punctuation">.</span>core<span class="token punctuation">.</span>toolkit<span class="token punctuation">.</span></span><span class="token class-name">CollectionUtils</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">com<span class="token punctuation">.</span>baomidou<span class="token punctuation">.</span>mybatisplus<span class="token punctuation">.</span>core<span class="token punctuation">.</span>toolkit<span class="token punctuation">.</span></span><span class="token class-name">Wrappers</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">com<span class="token punctuation">.</span>leyou<span class="token punctuation">.</span>common<span class="token punctuation">.</span>exception<span class="token punctuation">.</span>pojo<span class="token punctuation">.</span></span><span class="token class-name">ExceptionEnum</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">com<span class="token punctuation">.</span>leyou<span class="token punctuation">.</span>common<span class="token punctuation">.</span>exception<span class="token punctuation">.</span>pojo<span class="token punctuation">.</span></span><span class="token class-name">LyException</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">com<span class="token punctuation">.</span>leyou<span class="token punctuation">.</span>item<span class="token punctuation">.</span>mapper<span class="token punctuation">.</span></span><span class="token class-name">SpecGroupMapper</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">com<span class="token punctuation">.</span>leyou<span class="token punctuation">.</span>item<span class="token punctuation">.</span>mapper<span class="token punctuation">.</span></span><span class="token class-name">SpecParamMapper</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">com<span class="token punctuation">.</span>leyou<span class="token punctuation">.</span>item<span class="token punctuation">.</span>pojo<span class="token punctuation">.</span></span><span class="token class-name">SpecGroup</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>beans<span class="token punctuation">.</span>factory<span class="token punctuation">.</span>annotation<span class="token punctuation">.</span></span><span class="token class-name">Autowired</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>stereotype<span class="token punctuation">.</span></span><span class="token class-name">Service</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>transaction<span class="token punctuation">.</span>annotation<span class="token punctuation">.</span></span><span class="token class-name">Transactional</span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span></span><span class="token class-name">List</span><span class="token punctuation">;</span>

<span class="token comment">/**
 * 规格业务
 */</span>
<span class="token annotation punctuation">@Service</span>
<span class="token annotation punctuation">@Transactional</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">SpecService</span> <span class="token punctuation">{</span>
    <span class="token annotation punctuation">@Autowired</span>
    <span class="token keyword">private</span> <span class="token class-name">SpecGroupMapper</span> specGroupMapper<span class="token punctuation">;</span>
    <span class="token annotation punctuation">@Autowired</span>
    <span class="token keyword">private</span> <span class="token class-name">SpecParamMapper</span> specParamMapper<span class="token punctuation">;</span>

    <span class="token keyword">public</span> <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">SpecGroup</span><span class="token punctuation">&gt;</span></span> <span class="token function">findSpecGroupsByCid</span><span class="token punctuation">(</span><span class="token class-name">Long</span> id<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">//1.封装条件</span>
        <span class="token class-name">SpecGroup</span> specGroup <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">SpecGroup</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        specGroup<span class="token punctuation">.</span><span class="token function">setCid</span><span class="token punctuation">(</span>id<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">QueryWrapper</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">SpecGroup</span><span class="token punctuation">&gt;</span></span> queryWrapper <span class="token operator">=</span> <span class="token class-name">Wrappers</span><span class="token punctuation">.</span><span class="token function">query</span><span class="token punctuation">(</span>specGroup<span class="token punctuation">)</span><span class="token punctuation">;</span>
        
        <span class="token comment">//2.执行查询，获取结果</span>
        <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">SpecGroup</span><span class="token punctuation">&gt;</span></span> specGroups <span class="token operator">=</span> specGroupMapper<span class="token punctuation">.</span><span class="token function">selectList</span><span class="token punctuation">(</span>queryWrapper<span class="token punctuation">)</span><span class="token punctuation">;</span>
        
        <span class="token comment">//3.处理和返回结果</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token class-name">CollectionUtils</span><span class="token punctuation">.</span><span class="token function">isEmpty</span><span class="token punctuation">(</span>specGroups<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">LyException</span><span class="token punctuation">(</span><span class="token class-name">ExceptionEnum</span><span class="token punctuation">.</span>SPEC_NOT_FOUND<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">return</span> specGroups<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>重启微服务，测试，页面规格组数据加载了！</p><h2 id="18、商品规格：根据规格组查询规格参数"><a href="#18、商品规格：根据规格组查询规格参数" class="headerlink" title="18、商品规格：根据规格组查询规格参数"></a>18、商品规格：根据规格组查询规格参数</h2><p>查看文档：</p><p><img src="%E4%B9%90%E4%BC%98%E7%94%B5%E5%95%86-04-%E5%93%81%E7%89%8C%E5%9B%BE%E7%89%87%E4%B8%8A%E4%BC%A0-%E5%95%86%E5%93%81%E8%A7%84%E6%A0%BC%E3%80%90OSS%E3%80%91.assets/1578395494883.png" alt="1578395494883"></p><h3 id="1）编写处理器-1"><a href="#1）编写处理器-1" class="headerlink" title="1）编写处理器"></a>1）编写处理器</h3><p>在SpecController中添加如下方法</p><pre class="line-numbers language-java" data-language="java"><code class="language-java">  <span class="token comment">/**
 * 根据条件查询规格参数（gid,cid,searching）
 */</span>
<span class="token annotation punctuation">@GetMapping</span><span class="token punctuation">(</span><span class="token string">"/spec/params"</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token class-name">ResponseEntity</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">List</span><span class="token punctuation">&lt;</span><span class="token class-name">SpecParam</span><span class="token punctuation">&gt;</span><span class="token punctuation">&gt;</span></span> <span class="token function">findSpecParams</span><span class="token punctuation">(</span>
        <span class="token annotation punctuation">@RequestParam</span><span class="token punctuation">(</span>value <span class="token operator">=</span> <span class="token string">"gid"</span><span class="token punctuation">,</span>required <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">)</span> <span class="token class-name">Long</span> gid<span class="token punctuation">,</span>
        <span class="token annotation punctuation">@RequestParam</span><span class="token punctuation">(</span>value <span class="token operator">=</span> <span class="token string">"cid"</span><span class="token punctuation">,</span>required <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">)</span> <span class="token class-name">Long</span> cid<span class="token punctuation">,</span>
        <span class="token annotation punctuation">@RequestParam</span><span class="token punctuation">(</span>value <span class="token operator">=</span> <span class="token string">"searching"</span><span class="token punctuation">,</span>required <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">)</span> <span class="token class-name">Boolean</span> searching
<span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">SpecParam</span><span class="token punctuation">&gt;</span></span> specParams <span class="token operator">=</span> specService<span class="token punctuation">.</span><span class="token function">findSpecParams</span><span class="token punctuation">(</span>gid<span class="token punctuation">,</span>cid<span class="token punctuation">,</span>searching<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token class-name">ResponseEntity</span><span class="token punctuation">.</span><span class="token function">ok</span><span class="token punctuation">(</span>specParams<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="2）编写Service-1"><a href="#2）编写Service-1" class="headerlink" title="2）编写Service"></a>2）编写Service</h3><p>在SpecService添加如下方法</p><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">public</span> <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">SpecParam</span><span class="token punctuation">&gt;</span></span> <span class="token function">findSpecParams</span><span class="token punctuation">(</span><span class="token class-name">Long</span> gid<span class="token punctuation">,</span> <span class="token class-name">Long</span> cid<span class="token punctuation">,</span> <span class="token class-name">Boolean</span> searching<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">//判断gid和cid不能同时存在</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span>gid<span class="token operator">!=</span><span class="token keyword">null</span> <span class="token operator">&amp;&amp;</span> cid<span class="token operator">!=</span><span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">LyException</span><span class="token punctuation">(</span><span class="token class-name">ExceptionEnum</span><span class="token punctuation">.</span>INVALID_PARAM_ERROR<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token comment">//1.封装条件  注意：MyBatis-Plus底层自动判断NULL值，则不作为查询条件</span>
        <span class="token class-name">SpecParam</span> specParam <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">SpecParam</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        specParam<span class="token punctuation">.</span><span class="token function">setGroupId</span><span class="token punctuation">(</span>gid<span class="token punctuation">)</span><span class="token punctuation">;</span>
        specParam<span class="token punctuation">.</span><span class="token function">setCid</span><span class="token punctuation">(</span>cid<span class="token punctuation">)</span><span class="token punctuation">;</span>
        specParam<span class="token punctuation">.</span><span class="token function">setSearching</span><span class="token punctuation">(</span>searching<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token class-name">QueryWrapper</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">SpecParam</span><span class="token punctuation">&gt;</span></span> queryWrapper <span class="token operator">=</span> <span class="token class-name">Wrappers</span><span class="token punctuation">.</span><span class="token function">query</span><span class="token punctuation">(</span>specParam<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">//2.执行查询，获取结果</span>
        <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">SpecParam</span><span class="token punctuation">&gt;</span></span> specParams <span class="token operator">=</span> specParamMapper<span class="token punctuation">.</span><span class="token function">selectList</span><span class="token punctuation">(</span>queryWrapper<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">//3.处理和返回结果</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token class-name">CollectionUtils</span><span class="token punctuation">.</span><span class="token function">isEmpty</span><span class="token punctuation">(</span>specParams<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">LyException</span><span class="token punctuation">(</span><span class="token class-name">ExceptionEnum</span><span class="token punctuation">.</span>SPEC_NOT_FOUND<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">return</span> specParams<span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>重启微服务，查询页面规格参数数据时出现了异常！</p><p><img src="%E4%B9%90%E4%BC%98%E7%94%B5%E5%95%86-04-%E5%93%81%E7%89%8C%E5%9B%BE%E7%89%87%E4%B8%8A%E4%BC%A0-%E5%95%86%E5%93%81%E8%A7%84%E6%A0%BC%E3%80%90OSS%E3%80%91.assets/1575541404707.png" alt="1575541404707"></p><p>这是什么导致的呢？</p><p>仔细阅读错误说明，说sql语句有误，仔细观察发现Sql语句中有一个字段，名为<code>numeric</code>，这个字段名称与数据库名称冲突，这种情况下我们都需要对字段进行转义，变为普通字符串。</p><h2 id="19、商品规格：sql语句中出现mysql关键字处理"><a href="#19、商品规格：sql语句中出现mysql关键字处理" class="headerlink" title="19、商品规格：sql语句中出现mysql关键字处理"></a>19、商品规格：sql语句中出现mysql关键字处理</h2><p>sql是由mybatis-plus生成的，我们该如何修改Sql语句中的字段呢？</p><p>通过mybatis-plus的@TableField注解，来声明这个字段对应的列名：</p><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token annotation punctuation">@Data</span>
<span class="token annotation punctuation">@TableName</span><span class="token punctuation">(</span><span class="token string">"tb_spec_param"</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">SpecParam</span> <span class="token punctuation">{</span>
    <span class="token annotation punctuation">@TableId</span><span class="token punctuation">(</span>type <span class="token operator">=</span> <span class="token class-name">IdType</span><span class="token punctuation">.</span>AUTO<span class="token punctuation">)</span>
    <span class="token keyword">private</span> <span class="token class-name">Long</span> id<span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token class-name">Long</span> cid<span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token class-name">Long</span> groupId<span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token class-name">String</span> name<span class="token punctuation">;</span>
    <span class="token annotation punctuation">@TableField</span><span class="token punctuation">(</span><span class="token string">"`numeric`"</span><span class="token punctuation">)</span>
    <span class="token keyword">private</span> <span class="token class-name">Boolean</span> numeric<span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token class-name">String</span> unit<span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token class-name">Boolean</span> generic<span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token class-name">Boolean</span> searching<span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token class-name">String</span> segments<span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token class-name">Date</span> createTime<span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token class-name">Date</span> updateTime<span class="token punctuation">;</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>重启后 打开页面</p><p><img src="%E4%B9%90%E4%BC%98%E7%94%B5%E5%95%86-04-%E5%93%81%E7%89%8C%E5%9B%BE%E7%89%87%E4%B8%8A%E4%BC%A0-%E5%95%86%E5%93%81%E8%A7%84%E6%A0%BC%E3%80%90OSS%E3%80%91.assets/1575541714644.png" alt="1575541714644"></p><p>在页面刷新：</p><p><img src="%E4%B9%90%E4%BC%98%E7%94%B5%E5%95%86-04-%E5%93%81%E7%89%8C%E5%9B%BE%E7%89%87%E4%B8%8A%E4%BC%A0-%E5%95%86%E5%93%81%E8%A7%84%E6%A0%BC%E3%80%90OSS%E3%80%91.assets/1575541783067.png" alt="1575541783067"></p><p>控制台输出的sql：</p><p>发现已经加入了反引号处理：</p><p><img src="%E4%B9%90%E4%BC%98%E7%94%B5%E5%95%86-04-%E5%93%81%E7%89%8C%E5%9B%BE%E7%89%87%E4%B8%8A%E4%BC%A0-%E5%95%86%E5%93%81%E8%A7%84%E6%A0%BC%E3%80%90OSS%E3%80%91.assets/1575542458197.png" alt="1575542458197"></p><h2 id="20、课程总结"><a href="#20、课程总结" class="headerlink" title="20、课程总结"></a>20、课程总结</h2><p>1）图片上传</p><p>​ 1.1 本地上传：把图片上传都nginx服务器 复习后台如何接收文件</p><p>1.2 阿里云OSS上传： 服务端签名后上传</p><p>​ 1）前端：v-upload文件上传插件</p><pre class="line-numbers language-html" data-language="html"><code class="language-html"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>v-upload</span> <span class="token attr-name">v-model</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>brand.image<span class="token punctuation">"</span></span> <span class="token attr-name">:multiple</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>false<span class="token punctuation">"</span></span> <span class="token attr-name">:pic-width</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>250<span class="token punctuation">"</span></span> <span class="token attr-name">:pic-height</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>90<span class="token punctuation">"</span></span>
                        <span class="token attr-name">url</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>/upload/signature<span class="token punctuation">"</span></span> <span class="token attr-name">need-signature</span><span class="token punctuation">/&gt;</span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre><p>​ 2）生成签名给前端（重点）</p><p>​ 学会如何在SpringBoot项目中抽取配置（application.yml） 使用@Value或@ConfigurationProperties读取</p><p>​ 查看阿里云的OSS API抽取</p><p>2）商品规格（重点）</p><p>​ 2.1 学习商品分类-规格组-规格参数之间的关系</p><p>​ 2.2 规格组和规格参数表结构</p><p>​ 2.3 写出根据分类查询规格组 和 通用的查询规格参数的方法（根据规格组）</p><p>乐优商城的模块</p><p>1）后台商品管理（* - **）</p><p>2）商品搜索（***）</p><p>3）商品详情（**）</p><p>4）用户模块（用户注册，用户登录，鉴权）（**）</p><p>5）购物车（*）</p><p>6）订单管理（*）</p><p>7）微信支付（*）</p></div><hr><div class="reprint" id="reprint-statement"><div class="reprint__author"><span class="reprint-meta" style="font-weight:700"><i class="fas fa-user">文章作者:</i></span> <span class="reprint-info"><a href="/about" rel="external nofollow noreferrer">durex</a></span></div><div class="reprint__type"><span class="reprint-meta" style="font-weight:700"><i class="fas fa-link">文章链接:</i></span> <span class="reprint-info"><a href="https://chenliren9527.github.io/2020/12/28/le-you-dian-shang-04-pin-pai-tu-pian-shang-chuan-shang-pin-gui-ge-oss/">https://chenliren9527.github.io/2020/12/28/le-you-dian-shang-04-pin-pai-tu-pian-shang-chuan-shang-pin-gui-ge-oss/</a></span></div><div class="reprint__notice"><span class="reprint-meta" style="font-weight:700"><i class="fas fa-copyright">版权声明:</i></span> <span class="reprint-info">本博客所有文章除特別声明外，均采用 <a href="https://creativecommons.org/licenses/by/4.0/deed.zh" rel="external nofollow noreferrer" target="_blank">CC BY 4.0</a> 许可协议。转载请注明来源 <a href="/about" target="_blank">durex</a> !</span></div></div><script async defer>document.addEventListener("copy", function (e) {
        let toastHTML = '<span>复制成功，请遵循本文的转载规则</span><button class="btn-flat toast-action" onclick="navToReprintStatement()" style="font-size: smaller">查看</a>';
        M.toast({html: toastHTML})
      });

      function navToReprintStatement() {
        $("html, body").animate({scrollTop: $("#reprint-statement").offset().top - 80}, 800);
      }</script><div class="tag_share" style="display:block"><div class="post-meta__tag-list" style="display:inline-block"><div class="article-tag"><a href="/tags/%E7%AC%94%E8%AE%B0/"><span class="chip bg-color">笔记</span></a> <a href="/tags/%E9%A1%B9%E7%9B%AE%E5%AE%9E%E6%88%98%E4%BA%8C/"><span class="chip bg-color">项目实战二</span></a> <a href="/tags/springcloud/"><span class="chip bg-color">springcloud</span></a> <a href="/tags/%E5%BE%AE%E6%9C%8D%E5%8A%A1/"><span class="chip bg-color">微服务</span></a> <a href="/tags/%E5%9B%BE%E7%89%87%E4%B8%8A%E4%BC%A0/"><span class="chip bg-color">图片上传</span></a> <a href="/tags/OSS/"><span class="chip bg-color">OSS</span></a> <a href="/tags/%E9%98%BF%E9%87%8C%E4%BA%91/"><span class="chip bg-color">阿里云</span></a></div></div><div class="post_share" style="zoom:80%;width:fit-content;display:inline-block;float:right;margin:-.15rem 0"><link rel="stylesheet" href="/libs/share/css/share.min.css"><div id="article-share"><div class="social-share" data-sites="twitter,facebook,google,qq,qzone,wechat,weibo,douban,linkedin" data-wechat-qrcode-helper="<p>微信扫一扫即可分享！</p>"></div><script src="/libs/share/js/social-share.min.js"></script></div></div></div><style>#reward{margin:40px 0;text-align:center}#reward .reward-link{font-size:1.4rem;line-height:38px}#reward .btn-floating:hover{box-shadow:0 6px 12px rgba(0,0,0,.2),0 5px 15px rgba(0,0,0,.2)}#rewardModal{width:320px;height:350px}#rewardModal .reward-title{margin:15px auto;padding-bottom:5px}#rewardModal .modal-content{padding:10px}#rewardModal .close{position:absolute;right:15px;top:15px;color:rgba(0,0,0,.5);font-size:1.3rem;line-height:20px;cursor:pointer}#rewardModal .close:hover{color:#ef5350;transform:scale(1.3);-moz-transform:scale(1.3);-webkit-transform:scale(1.3);-o-transform:scale(1.3)}#rewardModal .reward-tabs{margin:0 auto;width:210px}.reward-tabs .tabs{height:38px;margin:10px auto;padding-left:0}.reward-content ul{padding-left:0!important}.reward-tabs .tabs .tab{height:38px;line-height:38px}.reward-tabs .tab a{color:#fff;background-color:#ccc}.reward-tabs .tab a:hover{background-color:#ccc;color:#fff}.reward-tabs .wechat-tab .active{color:#fff!important;background-color:#22ab38!important}.reward-tabs .alipay-tab .active{color:#fff!important;background-color:#019fe8!important}.reward-tabs .reward-img{width:210px;height:210px}</style><div id="reward"><a href="#rewardModal" class="reward-link modal-trigger btn-floating btn-medium waves-effect waves-light red">赏</a><div id="rewardModal" class="modal"><div class="modal-content"><a class="close modal-close"><i class="fas fa-times"></i></a><h4 class="reward-title">你的赏识是我前进的动力</h4><div class="reward-content"><div class="reward-tabs"><ul class="tabs row"><li class="tab col s6 alipay-tab waves-effect waves-light"><a href="#alipay">支付宝</a></li><li class="tab col s6 wechat-tab waves-effect waves-light"><a href="#wechat">微 信</a></li></ul><div id="alipay"><img src="/medias/reward/alipay.png" class="reward-img" alt="支付宝打赏二维码"></div><div id="wechat"><img src="/medias/reward/wechat.png" class="reward-img" alt="微信打赏二维码"></div></div></div></div></div></div><script>$(function(){$(".tabs").tabs()})</script></div></div><article id="prenext-posts" class="prev-next articles"><div class="row article-row"><div class="article col s12 m6" data-aos="fade-up"><div class="article-badge left-badge text-color"><i class="fas fa-chevron-left"></i> &nbsp;上一篇</div><div class="card"><a href="/2020/12/30/le-you-dian-shang-05-shang-pin-guan-li/"><div class="card-image"><img src="/medias/featureimages/39.jpg" class="responsive-img" alt="乐优电商(05)-商品管理"> <span class="card-title">乐优电商(05)-商品管理</span></div></a><div class="card-content article-content"><div class="summary block-with-text"></div><div class="publish-info"><span class="publish-date"><i class="far fa-clock fa-fw icon-date"></i> 2020-12-30</span><span class="publish-author"><i class="fas fa-bookmark fa-fw icon-category"></i> <a href="/categories/%E9%A1%B9%E7%9B%AE%E5%AE%9E%E6%88%98%E4%BA%8C/" class="post-category">项目实战二</a></span></div></div><div class="card-action article-tags"><a href="/tags/%E7%AC%94%E8%AE%B0/"><span class="chip bg-color">笔记</span></a> <a href="/tags/%E9%A1%B9%E7%9B%AE%E5%AE%9E%E6%88%98%E4%BA%8C/"><span class="chip bg-color">项目实战二</span></a> <a href="/tags/springcloud/"><span class="chip bg-color">springcloud</span></a> <a href="/tags/%E5%BE%AE%E6%9C%8D%E5%8A%A1/"><span class="chip bg-color">微服务</span></a> <a href="/tags/SPU/"><span class="chip bg-color">SPU</span></a> <a href="/tags/SKU/"><span class="chip bg-color">SKU</span></a></div></div></div><div class="article col s12 m6" data-aos="fade-up"><div class="article-badge right-badge text-color">下一篇&nbsp;<i class="fas fa-chevron-right"></i></div><div class="card"><a href="/2020/12/27/le-you-dian-shang-03-pin-pai-guan-li/"><div class="card-image"><img src="/medias/featureimages/195.jpg" class="responsive-img" alt="乐优电商(03)-品牌管理"> <span class="card-title">乐优电商(03)-品牌管理</span></div></a><div class="card-content article-content"><div class="summary block-with-text"></div><div class="publish-info"><span class="publish-date"><i class="far fa-clock fa-fw icon-date"></i> 2020-12-27</span><span class="publish-author"><i class="fas fa-bookmark fa-fw icon-category"></i> <a href="/categories/%E9%A1%B9%E7%9B%AE%E5%AE%9E%E6%88%98%E4%BA%8C/" class="post-category">项目实战二</a></span></div></div><div class="card-action article-tags"><a href="/tags/%E7%AC%94%E8%AE%B0/"><span class="chip bg-color">笔记</span></a> <a href="/tags/%E5%89%8D%E7%AB%AF/"><span class="chip bg-color">前端</span></a> <a href="/tags/%E9%A1%B9%E7%9B%AE%E5%AE%9E%E6%88%98%E4%BA%8C/"><span class="chip bg-color">项目实战二</span></a> <a href="/tags/springcloud/"><span class="chip bg-color">springcloud</span></a> <a href="/tags/%E5%BE%AE%E6%9C%8D%E5%8A%A1/"><span class="chip bg-color">微服务</span></a> <a href="/tags/%E5%88%86%E9%A1%B5/"><span class="chip bg-color">分页</span></a> <a href="/tags/Vuejs/"><span class="chip bg-color">Vuejs</span></a> <a href="/tags/vuetifyjs/"><span class="chip bg-color">vuetifyjs</span></a></div></div></div></div></article></div><script src="/libs/codeBlock/codeBlockFuction.js"></script><script src="/libs/codeBlock/codeLang.js"></script><script src="/libs/codeBlock/codeCopy.js"></script><script src="/libs/codeBlock/codeShrink.js"></script></div><div id="toc-aside" class="expanded col l3 hide-on-med-and-down"><div class="toc-widget card" style="background-color:#fff"><div class="toc-title"><i class="far fa-list-alt"></i>&nbsp;&nbsp;目录</div><div id="toc-content"></div></div></div></div><div id="floating-toc-btn" class="hide-on-med-and-down"><a class="btn-floating btn-large bg-color"><i class="fas fa-list-ul"></i></a></div><script src="/libs/tocbot/tocbot.min.js"></script><script>$(function () {
        tocbot.init({
            tocSelector: '#toc-content',
            contentSelector: '#articleContent',
            headingsOffset: -($(window).height() * 0.4 - 45),
            collapseDepth: Number('0'),
            headingSelector: 'h2, h3, h4'
        });

        // Set scroll toc fixed.
        let tocHeight = parseInt($(window).height() * 0.4 - 64);
        let $tocWidget = $('.toc-widget');
        $(window).scroll(function () {
            let scroll = $(window).scrollTop();
            /* add post toc fixed. */
            if (scroll > tocHeight) {
                $tocWidget.addClass('toc-fixed');
            } else {
                $tocWidget.removeClass('toc-fixed');
            }
        });

        
        /* 修复文章卡片 div 的宽度. */
        let fixPostCardWidth = function (srcId, targetId) {
            let srcDiv = $('#' + srcId);
            if (srcDiv.length === 0) {
                return;
            }

            let w = srcDiv.width();
            if (w >= 450) {
                w = w + 21;
            } else if (w >= 350 && w < 450) {
                w = w + 18;
            } else if (w >= 300 && w < 350) {
                w = w + 16;
            } else {
                w = w + 14;
            }
            $('#' + targetId).width(w);
        };

        // 切换TOC目录展开收缩的相关操作.
        const expandedClass = 'expanded';
        let $tocAside = $('#toc-aside');
        let $mainContent = $('#main-content');
        $('#floating-toc-btn .btn-floating').click(function () {
            if ($tocAside.hasClass(expandedClass)) {
                $tocAside.removeClass(expandedClass).hide();
                $mainContent.removeClass('l9');
            } else {
                $tocAside.addClass(expandedClass).show();
                $mainContent.addClass('l9');
            }
            fixPostCardWidth('artDetail', 'prenext-posts');
        });
        
    });</script></main><footer class="page-footer bg-color"><div class="container row center-align" style="margin-bottom:15px!important"><div class="col s12 m8 l8 copy-right">Copyright&nbsp;&copy; <span id="year">2021-2023</span> <a href="/about" target="_blank">durex</a> |&nbsp;Powered by&nbsp;<a href="https://hexo.io/" target="_blank">Hexo</a> |&nbsp;Theme&nbsp;<a href="https://github.com/blinkfox/hexo-theme-matery" target="_blank">Matery</a><br>&nbsp;<i class="fas fa-chart-area"></i>&nbsp;站点总字数:&nbsp;<span class="white-color">932k</span> <span id="busuanzi_container_site_pv">&nbsp;|&nbsp;<i class="far fa-eye"></i>&nbsp;总访问量:&nbsp;<span id="busuanzi_value_site_pv" class="white-color"></span></span> <span id="busuanzi_container_site_uv">&nbsp;|&nbsp;<i class="fas fa-users"></i>&nbsp;总访问人数:&nbsp;<span id="busuanzi_value_site_uv" class="white-color"></span></span><br><span id="sitetime">Loading ...</span><script>var calcSiteTime=function(){var e=new Date,t="2021",n=e.getFullYear(),i=e.getMonth()+1,a=e.getDate(),r=e.getHours(),s=e.getMinutes(),o=e.getSeconds(),g=Date.UTC(t,"1","08","0","0","0"),d=Date.UTC(n,i,a,r,s,o)-g,m=Math.floor(d/31536e6),l=Math.floor(d/864e5-365*m);if(t===String(n)){document.getElementById("year").innerHTML=n;var c="This site has been running for "+l+" days";c="本站已运行 "+l+" 天",document.getElementById("sitetime").innerHTML=c}else{document.getElementById("year").innerHTML=t+" - "+n;var u="This site has been running for "+m+" years and "+l+" days";u="本站已运行 "+m+" 年 "+l+" 天",document.getElementById("sitetime").innerHTML=u}};calcSiteTime()</script><br></div><div class="col s12 m4 l4 social-link social-statis"><a href="/atom.xml" class="tooltipped" target="_blank" data-tooltip="RSS 订阅" data-position="top" data-delay="50"><i class="fas fa-rss"></i></a></div></div></footer><div class="progress-bar"></div><div id="searchModal" class="modal"><div class="modal-content"><div class="search-header"><span class="title"><i class="fas fa-search"></i> &nbsp;&nbsp;搜索</span> <input type="search" id="searchInput" name="s" placeholder="请输入搜索的关键字" class="search-input"></div><div id="searchResult"></div></div></div><script>$(function(){!function(t,a,s){"use strict";$.ajax({url:t,dataType:"xml",success:function(t){var e=$("entry",t).map(function(){return{title:$("title",this).text(),content:$("content",this).text(),url:$("url",this).text()}}).get(),r=document.getElementById(a),n=document.getElementById(s);r.addEventListener("input",function(){var f='<ul class="search-result-list">',m=this.value.trim().toLowerCase().split(/[\s\-]+/);n.innerHTML="",this.value.trim().length<=0||(e.forEach(function(t){var r=!0,n=t.title.trim().toLowerCase(),a=t.content.trim().replace(/<[^>]+>/g,"").toLowerCase(),e=t.url;e=0===e.indexOf("/")?t.url:"/"+e;var s=-1,i=-1,l=-1;if(""!==n&&""!==a&&m.forEach(function(t,e){s=n.indexOf(t),i=a.indexOf(t),s<0&&i<0?r=!1:(i<0&&(i=0),0===e&&(l=i))}),r){f+="<li><a href='"+e+"' class='search-result-title'>"+n+"</a>";var c=t.content.trim().replace(/<[^>]+>/g,"");if(0<=l){var u=l-20,o=l+80;u<0&&(u=0),0===u&&(o=100),o>c.length&&(o=c.length);var h=c.substr(u,o);m.forEach(function(t){var e=new RegExp(t,"gi");h=h.replace(e,'<em class="search-keyword">'+t+"</em>")}),f+='<p class="search-result">'+h+"...</p>"}f+="</li>"}}),f+="</ul>",n.innerHTML=f)})}})}("/search.xml","searchInput","searchResult")})</script><div id="backTop" class="top-scroll"><a class="btn-floating btn-large waves-effect waves-light" href="#!"><i class="fas fa-arrow-up"></i></a></div><script src="/libs/materialize/materialize.min.js"></script><script src="/libs/masonry/masonry.pkgd.min.js"></script><script src="/libs/aos/aos.js"></script><script src="/libs/scrollprogress/scrollProgress.min.js"></script><script src="/libs/lightGallery/js/lightgallery-all.min.js"></script><script src="/js/matery.js"></script><script>var windowWidth=$(window).width();768<windowWidth&&document.write('<script type="text/javascript" src="/libs/others/sakura.js"><\/script>')</script><script>var windowWidth=$(window).width();768<windowWidth&&document.write('<script type="text/javascript" src="/libs/others/star.js"><\/script>')</script><script src="https://ssl.captcha.qq.com/TCaptcha.js"></script><script src="/libs/others/TencentCaptcha.js"></script><button id="TencentCaptcha" data-appid="xxxxxxxxxx" data-cbfn="callback" type="button" hidden></button><script>!function(){var t=document.createElement("script"),e=window.location.protocol.split(":")[0];t.src="https"===e?"https://zz.bdstatic.com/linksubmit/push.js":"http://push.zhanzhang.baidu.com/push.js";var s=document.getElementsByTagName("script")[0];s.parentNode.insertBefore(t,s)}()</script><script src="/libs/others/clicklove.js" async></script><script async src="/libs/others/busuanzi.pure.mini.js"></script><script src="/libs/instantpage/instantpage.js" type="module"></script></body></html>