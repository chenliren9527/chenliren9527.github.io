---
title: 就业技术加强(08)-可持续化集成部署
tags:
  - 笔记
  - 就业技术加强
  - Jenkins
  - Docker
  - Docker部署微服务
  - GitLab
  - 持续集成Jenkins
  - 容器管理Rancher
categories:
  - 就业技术加强
date: 2021-02-01 17:43:37
---

## 0、学习目标

目标1：掌握Docker部署微服务

目标2：熟悉GitLab搭建git仓库

目标3：熟悉持续集成Jenkins

目标4：熟悉容器管理Rancher



## 1、构建服务镜像

### 1.1、DockerFile

Dockerfile可以基于已有镜像构建镜像

- Dockerfile其实就是一个文本文件，由一系列命令和参数构成，Docker可以读取Dockerfile文件并根据Dockerfile文件的描述来构建镜像。

- Dockerfile文件内容一般分为4部分

  - 基础镜像信息
  - 维护者信息
  - 镜像操作指令
  - 容器启动时执行的指令

| **命令**                           | **作用**                                                     |
| ---------------------------------- | ------------------------------------------------------------ |
| FROM image_name:tag                | 定义了使用哪个基础镜像启动构建流程                           |
| MAINTAINER user_name               | 声明镜像的创建者                                             |
| ENV key value                      | 设置环境变量 (可以写多条)                                    |
| RUN command                        | 是Dockerfile的核心部分(可以写多条)                           |
| ADD source_dir/file dest_dir/file  | 将宿主机的文件复制到容器内，如果是一个压缩文件，将会在复制后自动解压 |
| COPY source_dir/file dest_dir/file | 和ADD相似，但是如果有压缩文件并不能解压                      |
| WORKDIR path_dir                   | 设置容器工作目录                                             |

### 1.2、制作JDK镜像

```shell
# 1、创建目录
mkdir –p /usr/local/dockerjdk8
cd /usr/local/dockerjdk8
      
# 2、下载jdk-8u202-linux-x64.tar.gz并上传到服务器（虚拟机）中的/usr/local/dockerjdk8目录 

# 3、在/usr/local/dockerjdk8目录下创建Dockerfile文件，文件内容如下：
vi Dockerfile

FROM centos:7
MAINTAINER ITCAST
WORKDIR /usr
RUN mkdir  /usr/local/java
ADD jdk-8u202-linux-x64.tar.gz /usr/local/java/
ENV JAVA_HOME /usr/local/java/jdk1.8.0_202
ENV JRE_HOME $JAVA_HOME/jre
ENV CLASSPATH $JAVA_HOME/lib/dt.jar:$JAVA_HOME/lib/tools.jar:$JRE_HOME/lib:$CLASSPATH
ENV PATH $JAVA_HOME/bin:$PATH

# 4、执行命令构建镜像；不要忘了后面的那个 .
docker build -t='jdk1.8' .

# 5、查看镜像是否建立完成
docker images
```

![1556181978321](就业技术加强-08-可持续化集成部署-1.assets/1556181978321-1612172677915.png)

![1556182052304](就业技术加强-08-可持续化集成部署-1.assets/1556182052304-1612172677916.png)

### 1.3、开启Docker远程访问

1）开启端口2375

```shell
vi /lib/systemd/system/docker.service

# 注释第14行；在第14行加入下面内容
ExecStart=/usr/bin/dockerd -H tcp://0.0.0.0:2375 -H unix:///var/run/docker.sock
```

![image-20201229180824490](就业技术加强-08-可持续化集成部署-1.assets/image-20201229180824490-1612172677916.png)

2）保存后，重启Docker

```shell
# 重新加载服务的配置文件
systemctl daemon-reload 
systemctl restart docker
```

3）检查docker是否监听了2375端口，有监听结果代表启动成功

```shell
netstat -ano | grep 2375
```

![image-20201229180948239](就业技术加强-08-可持续化集成部署-1.assets/image-20201229180948239-1612172677916.png)

4）本地浏览器访问(有结果代表能够远程访问docker): http://192.168.12.135:2375/version

![image-20201229181233561](就业技术加强-08-可持续化集成部署-1.assets/image-20201229181233561-1612172677916.png)

> 如果访问不了，可能是防火墙问题，可以关闭防火墙
>
> systemctl stop firewalld.service
> systemctl disable firewalld.service

### 1.4、构建服务镜像

1）导入 `资料\示例工程\spring-boot-docker` 到IDEA中；

![image-20201229191627317](就业技术加强-08-可持续化集成部署-1.assets/image-20201229191627317-1612172677916.png)

![image-20201229191651111](就业技术加强-08-可持续化集成部署-1.assets/image-20201229191651111-1612172677916.png)



2）配置 `pom.xml`文件中 maven插件；（导入的工程中已经配置，不需要再执行这步）

![image-20201229191825195](就业技术加强-08-可持续化集成部署-1.assets/image-20201229191825195-1612172677916.png)

```xml
<build>
        <finalName>${project.artifactId}</finalName>
        <plugins>
            <!-- spring-boot-maven-plugin -->
            <plugin>
                <groupId>org.springframework.boot</groupId>
                <artifactId>spring-boot-maven-plugin</artifactId>
            </plugin>
            <!-- docker-maven-plugin -->
            <plugin>
                <groupId>com.spotify</groupId>
                <artifactId>docker-maven-plugin</artifactId>
                <version>1.2.2</version>
                <configuration>
                    <!-- 镜像的名称 -->
                    <imageName>${project.artifactId}:${project.version}</imageName>
                    <!-- 基础镜像 -->
                    <baseImage>jdk1.8</baseImage>
                    <entryPoint>["java","-jar","/${project.build.finalName}.jar"]</entryPoint>
                    <resources>
                        <resource>
                            <targetPath>/</targetPath>
                            <directory>${project.build.directory}</directory>
                            <include>${project.build.finalName}.jar</include>
                        </resource>
                    </resources>
                    <dockerHost>http://10.10.10.10:2375</dockerHost>
                </configuration>
            </plugin>
        </plugins>
    </build>
```





3）构建服务的Docker镜像

![image-20201229191927991](就业技术加强-08-可持续化集成部署-1.assets/image-20201229191927991-1612172677916.png)

![image-20201229192133222](就业技术加强-08-可持续化集成部署-1.assets/image-20201229192133222-1612172677916.png)

![image-20201229192140962](就业技术加强-08-可持续化集成部署-1.assets/image-20201229192140962-1612172677917.png)

上图的命令为： `clean package docker:removeImage docker:build` 表示对项目进行清除原有编译打包的内容，然后进行编译打包，删除docker中同名镜像，构建镜像。

![image-20201229213241317](就业技术加强-08-可持续化集成部署-1.assets/image-20201229213241317-1612172677916.png)

![image-20201229213326166](就业技术加强-08-可持续化集成部署-1.assets/image-20201229213326166-1612172677917.png)

4）查看镜像

可以到模拟终端使用 `docker images` 查看刚刚构建的镜像：

![image-20201229213451694](就业技术加强-08-可持续化集成部署-1.assets/image-20201229213451694-1612172677917.png)

5）创建容器

```shell
docker run -di --name=web1 -p 9090:9090 spring-boot-docker:1.0-SNAPSHOT
```

![image-20201229214352765](就业技术加强-08-可持续化集成部署-1.assets/image-20201229214352765-1612172677917.png)

![image-20201229214418191](就业技术加强-08-可持续化集成部署-1.assets/image-20201229214418191-1612172677917.png)

### 1.5、IDEA中操作 Docker

在IDEA中可以通过配置Docker服务地址然后对Docker中的镜像、容器进行操作管理。具体如下：

![image-20201229213744167](就业技术加强-08-可持续化集成部署-1.assets/image-20201229213744167-1612172677917.png)

![image-20201229214637902](就业技术加强-08-可持续化集成部署-1.assets/image-20201229214637902-1612172677917.png)

![image-20201229214724560](就业技术加强-08-可持续化集成部署-1.assets/image-20201229214724560-1612172677917.png)



也可以在界面上直接删除镜像，容器，或者基于镜像创建容器：



删除容器：

![image-20201229215542793](就业技术加强-08-可持续化集成部署-1.assets/image-20201229215542793-1612172677917.png)

创建容器：

![image-20201229215023684](就业技术加强-08-可持续化集成部署-1.assets/image-20201229215023684-1612172677917.png)

![image-20201229220114438](就业技术加强-08-可持续化集成部署-1.assets/image-20201229220114438-1612172677917.png)

## 2、GitLab

### 2.1、简介

基于git实现的代码仓库有很多，像我们熟知的 Gitee、GitHub、GitLab、Gogs等等，都是支持持续集成的，我们把代码推送到git时，git仓库会触发一个webhooks事件通知对应配置的持续集成软件，触发持续集成软件的对应操作。

GitLab是一个利用 Ruby on Rails开发的开源应用程序，实现一个自托管的Git项目仓库，可通过Web界面进行访问公开的或者私人项目。

它拥有与Github、码云类似的功能，能够浏览源代码，管理缺陷和注释。可以管理团队对仓库的访问，它非常易于浏览提交过的版本并提供一个文件历史库。它还提供一个代码片段收集功能可以轻松实现代码复用，便于日后有需要的时候进行查找。

![image-20201230111224421](就业技术加强-08-可持续化集成部署-1.assets/image-20201230111224421-1612172677917.png)

### 2.2、安装

1） 拉取镜像

  ```shell
docker pull gitlab/gitlab-ce
  ```

2） 创建gitlab工作目录

  ```shell
# 创建config目录
mkdir -p /usr/local/gitlab/config
# 创建logs目录
mkdir -p /usr/local/gitlab/logs
# 创建data目录
mkdir -p /usr/local/gitlab/data
  ```

3） 创建运行Gitlab容器

  ```shell
docker run -d --name=gitlab \
-p 443:443 -p 80:80 -p 222:22 \
--restart=always \
-v /usr/local/gitlab/config:/etc/gitlab \
-v /usr/local/gitlab/logs:/var/log/gitlab \
-v /usr/local/gitlab/data:/var/opt/gitlab \
gitlab/gitlab-ce
  ```

  ![image-20201230114542328](就业技术加强-08-可持续化集成部署-1.assets/image-20201230114542328-1612172677917.png)

>启动的时候；如果内存占用 2G多的时候差不多就启动完了

4） 修改gitlab.rb配置文件

  gitlab容器运行没问题，但在gitlab上创建项目的时候，生成项目的URL访问地址是按容器的hostname来生成的，也就是容器的id。作为gitlab服务器，我们需要一个固定的URL访问地址，于是需要配置gitlab.rb（宿主机路径:/usr/local/gitlab/config/gitlab.rb）配置三个参数:

  ```shell
vi /usr/local/gitlab/config/gitlab.rb

# 在第33行 添中以下内容
external_url 'http://192.168.12.135'
gitlab_rails['gitlab_ssh_host'] = '192.168.12.135'
gitlab_rails['gitlab_shell_ssh_port'] = 222
  ```

![image-20201230114700451](就业技术加强-08-可持续化集成部署-1.assets/image-20201230114700451-1612172677917.png)

5） 重启gitlab容器

  ```shell
docker restart gitlab
  ```

6） 浏览器访问: http://192.168.12.135/  ；刚进入需要修改root用户的密码；

![image-20201230115709369](就业技术加强-08-可持续化集成部署-1.assets/image-20201230115709369-1612172677917.png)



 比如：我修改的 用户名及密码为: root / root123456 ；修改之后使用新密码登录：

![image-20201230115916987](就业技术加强-08-可持续化集成部署-1.assets/image-20201230115916987-1612172677917.png)

1. 密码重置无法生效时

   ```bash
   # 进入gitlab容器
   root@server:/# docker exec -it gitlab /bin/bash
   
   # 登录容器里面的gitlab,开启 Rails console.
   root@1fab12c6d626:/# gitlab-rails console
   # 执行 u = User.find_by_username('root') 查找root用户
   irb(main):002:0> u = User.find_by_username('root')
   irb(main):003:0> u.skip_reconfirmation!
   ```

   然后重新尝试登陆

   

2. 重置密码

   ```bash
   # 进入gitlab容器
   root@server:/# docker exec -it gitlab /bin/bash
   
   # 登录容器里面的gitlab,开启 Rails console.
   root@1fab12c6d626:/# gitlab-rails console
   # 执行 u = User.find_by_username('root') 查找root用户
   irb(main):002:0> user = User.find_by_username('root')
   irb(main):003:0> user.password = 'secret_pass'
   irb(main):004:0> user.password_confirmation  = 'secret_pass'
   # When using this method instead of the Users API, GitLab sends an email to the user stating that the user changed their password.
   # If the password was changed by an administrator, execute the following command to notify the user by email: 
   irb(main):005:0> user.send_only_admin_changed_your_password_notification!
   irb(main):005:0> user.save!
   ```

登录之后：

![image-20201230115929790](就业技术加强-08-可持续化集成部署-1.assets/image-20201230115929790-1612172677917.png)



### 2.3、创建项目

![image-20201230163053509](就业技术加强-08-可持续化集成部署-1.assets/image-20201230163053509-1612172677917.png)

![image-20201230163102687](就业技术加强-08-可持续化集成部署-1.assets/image-20201230163102687-1612172677917.png)

![image-20201230163110022](就业技术加强-08-可持续化集成部署-1.assets/image-20201230163110022-1612172677917.png)

![image-20201230163116600](就业技术加强-08-可持续化集成部署-1.assets/image-20201230163116600-1612172677917.png)



### 2.4、上传项目

![image-20201230163229879](就业技术加强-08-可持续化集成部署-1.assets/image-20201230163229879-1612172677918.png)

![image-20201230165352730](就业技术加强-08-可持续化集成部署-1.assets/image-20201230165352730-1612172677918.png)

![image-20201230170222226](就业技术加强-08-可持续化集成部署-1.assets/image-20201230170222226-1612172677918.png)

可以把 target/*.iml等文件也添加到忽略文件中。

![image-20201230170341676](就业技术加强-08-可持续化集成部署-1.assets/image-20201230170341676-1612172677918.png)



![image-20201230170325796](就业技术加强-08-可持续化集成部署-1.assets/image-20201230170325796-1612172677918.png)

推送到远程仓库：

![image-20201230170449172](就业技术加强-08-可持续化集成部署-1.assets/image-20201230170449172-1612172677918.png)

![image-20201230170504423](就业技术加强-08-可持续化集成部署-1.assets/image-20201230170504423-1612172677918.png)

![image-20201230170535508](就业技术加强-08-可持续化集成部署-1.assets/image-20201230170535508-1612172677918.png)

上图中输入 gitlab 中的用户名/密码。再到gitlab查看如下：

![image-20201230170645415](就业技术加强-08-可持续化集成部署-1.assets/image-20201230170645415-1612172677918.png)

## 3、持续集成

### 3.1、简介

持续集成Continuous integration，简称CI 随着软件开发复杂度的不断提高，团队开发成员间如何更好地协同工作以确保软件开发的质量已经慢慢成为开发过程中不可回避的问题。尤其是近些年来，敏捷Agile在软件工程领域越来越红火，如何能在不断变化的需求中快速适应和保证软件的质量也显得尤其的重要。持续集成正是针对这一类问题的一种软件开发实践。它倡导团队开发成员必须**经常集成**他们的工作，甚至每天都可能发生多次集成。而每次的集成都是**通过自动化的构建来验证，包括自动编译、发布和测试，从而尽快地发现集成错误，让团队能够更快的开发内聚的软件**。

![image-20201230172232893](就业技术加强-08-可持续化集成部署-1.assets/image-20201230172232893-1612172677918.png)

![image-20201230173409927](就业技术加强-08-可持续化集成部署-1.assets/image-20201230173409927-1612172677918.png)

1.统一的代码库

2.自动构建

3.自动测试

4.每个人每天都要向代码库主干提交代码

5.每次代码递交后都会在持续集成服务器上触发一次构建

6.保证快速构建

7.模拟生产环境的自动测试

8.每个人都可以很容易的获取最新可执行的应用程序

9.每个人都清楚正在发生的状况

10.自动化的部署

### 3.2、特点

它是一个自动化的周期性的集成测试过程，**从检出代码、编译构建、运行测试、结果记录、测试统计等都是自动完成的，无需过多人工干预**；需要有专门的集成服务器来执行集成构建；需要有代码托管工具支持。

### 3.3、作用

保证团队开发人员提交代码的质量，**减轻了软件发布时的压力**；持续集成中的任何一个环节都是自动完成的，无需太多的人工干预，有利于减少重复过程以节省时间、费用和工作量。

![1594018223501](就业技术加强-08-可持续化集成部署-1.assets/1594018223501-1612172677918.png)

## 4、Jenkins

### 4.1、简介

官方网站: <https://www.jenkins.io/zh/> 

![image-20201230174428489](就业技术加强-08-可持续化集成部署-1.assets/image-20201230174428489-1612172677918.png)

+ Jenkins原名Hudson，2011年改为现在的名字，它是一个开源的实现持续集成的软件工具。
+ Jenkins是一款开源 CI&CD 软件领导者，提供超过1000个插件来支持: **自动化构建、部署**、满足任何项目的需要。
+ Jenkins能实施监控集成中存在的错误，提供详细的日志文件和提醒功能，还能用图表的形式形象地展示项目构建的趋势和稳定性。 

 **特点:** 

+ 易配置：提供友好的GUI配置界面。
+ 变更支持：Jenkins能从代码仓库（CVS/SVN/Git）中获取代码更新列表并输出到编译输出信息中。
+ 支持永久链接：用户是通过web来访问Jenkins的，而这些web页面的链接地址都是永久链接地址，因此，你可以在各种文档中直接使用该链接。
+ 集成E-Mail/RSS/IM: 当完成一次集成时，可通过这些工具实时告诉你集成结果（一般情况下，构建一次集成需要花费一定时间，有了这个功能，你就可以在等待结果过程中，干别的事情）。
+ JUnit/TestNG测试报告: 也就是用以图表等形式提供详细的测试报表功能。
+ 支持分布式构建: Jenkins可以把集成构建等工作分发到多台计算机中完成。
+ 支持第三方插件: 使得Jenkins变得越来越强大。

### 4.2、安装

1）拉取jenkins镜像

```shell
docker pull jenkins/jenkins:lts-centos7
```

2）创建jenkins容器

```shell
docker run -d --name=jenkins -p 8888:8080 jenkins/jenkins:lts-centos7
```

### 4.3、配置

#### 4.3.1、配置插件镜像地址

配置插件镜像加速： jenkins官方地址下载速度比较慢，需要配置国内镜像。{% asset_link default.txt   default.txt  %}(自行修改后缀为json)

```shell
cd /usr/local
  
# 1. 上传 资料/jenkins/default.json 文件到 /usr/local 目录下
  
# 2. 将当前文件夹下的default.json文件复制到容器中
docker cp default.json jenkins:/var/jenkins_home/updates/default.json
  
# 3. 重启jenkins
docker restart jenkins
```

#### 4.3.2、解锁

访问配置: http://192.168.12.135:8888 访问jenkins，提示需要解锁

![image-20201230180026407](就业技术加强-08-可持续化集成部署-1.assets/image-20201230180026407-1612172677918.png)

```shell
# 进入容器
docker exec -it -u root jenkins bash
 
# 查看密钥
cat /var/jenkins_home/secrets/initialAdminPassword
```

![image-20201230180247096](就业技术加强-08-可持续化集成部署-1.assets/image-20201230180247096-1612172677918.png)

 

 复制密钥 到浏览器 并点击 `继续`

![image-20201230180504301](就业技术加强-08-可持续化集成部署-1.assets/image-20201230180504301-1612172677918.png)

![image-20201230180619752](就业技术加强-08-可持续化集成部署-1.assets/image-20201230180619752-1612172677918.png)

  进入jenkins欢迎页面：

![image-20201230180626922](就业技术加强-08-可持续化集成部署-1.assets/image-20201230180626922-1612172677918.png)

#### 4.3.3、修改admin密码

刚刚设置的密码太长；太难记住；可以修改admin密码；如修改为：123456

![image-20201230180809150](就业技术加强-08-可持续化集成部署-1.assets/image-20201230180809150-1612172677918.png)

![image-20201230180905979](就业技术加强-08-可持续化集成部署-1.assets/image-20201230180905979-1612172677918.png)

![image-20201230180954662](就业技术加强-08-可持续化集成部署-1.assets/image-20201230180954662-1612172677918.png)

#### 4.3.4、创建用户

可以创建除了admin外用户；如创建一个用户为 `itheima`步骤如下：

![image-20201230181133965](就业技术加强-08-可持续化集成部署-1.assets/image-20201230181133965-1612172677919.png)

![image-20201230181205236](就业技术加强-08-可持续化集成部署-1.assets/image-20201230181205236-1612172677919.png)

![image-20201230181241731](就业技术加强-08-可持续化集成部署-1.assets/image-20201230181241731-1612172677919.png)



### 4.4、使用

#### 4.4.1、安装maven插件

![image-20201230182141874](就业技术加强-08-可持续化集成部署-1.assets/image-20201230182141874-1612172677919.png)

![image-20201230182256451](就业技术加强-08-可持续化集成部署-1.assets/image-20201230182256451-1612172677919.png)

![image-20201230182447972](就业技术加强-08-可持续化集成部署-1.assets/image-20201230182447972-1612172677919.png)

![image-20201230182723305](就业技术加强-08-可持续化集成部署-1.assets/image-20201230182723305-1612172677919.png)

#### 4.4.2、安装git插件

![image-20201230182851956](就业技术加强-08-可持续化集成部署-1.assets/image-20201230182851956-1612172677919.png)

![image-20201230202342066](就业技术加强-08-可持续化集成部署-1.assets/image-20201230202342066-1612172677919.png)



#### 4.4.3、全局工具配置

因为Jenkins构建的时候需要使用到JDK以及Maven；所以将两个工具配置到安装了Jenkins的容器中。

1）**上传资料**

```shell
cd /usr/local
# 1. 上传 资料/jdk-8u202-linux-x64.rpm 、资料/apache-maven-3.6.3-bin.tar.gz  到 /usr/local

# 2. 将 /usr/local下的两个资源拷贝到Jenkins容器中
docker cp jdk-8u202-linux-x64.rpm jenkins:/usr/local/
docker cp apache-maven-3.6.3-bin.tar.gz jenkins:/usr/local/

```

2）**安装JDK**

```shell
# 进入容器
docker exec -it -u root jenkins bash

# 安装jdk 会被安装到这个目录: /usr/java/jdk1.8.0_202
cd /usr/local

rpm -ivh jdk-8u202-linux-x64.rpm

# 配置环境变量
vi /etc/profile

# 在文件最后面追加如下内容
export PATH USER LOGNAME MAIL HOSTNAME HISTSIZE HISTCONTROL
export JAVA_HOME=/usr/java/jdk1.8.0_202-amd64
export CLASSPATH=.:$JAVA_HOME/lib/dt.jar:$JAVA_HOME/lib/tools.jar
export PATH=$JAVA_HOME/bin:$PATH

# 使配置生效
source /etc/profile
```

![image-20201230191112497](就业技术加强-08-可持续化集成部署-1.assets/image-20201230191112497-1612172677919.png)

![image-20201230191203627](就业技术加强-08-可持续化集成部署-1.assets/image-20201230191203627-1612172677919.png)

3）**安装Maven**

```shell
cd /usr/local
# 解压maven
tar -zxvf apache-maven-3.6.3-bin.tar.gz

# 配置maven的下载镜像为阿里云镜像
vi /usr/local/apache-maven-3.6.3/conf/settings.xml


# 大概在第 159 行；添加如下镜像配置
<mirror>
	<id>alimaven</id>
	<mirrorOf>central</mirrorOf>
	<name>aliyun maven</name>
    <url>http://maven.aliyun.com/nexus/content/repositories/central/</url>
</mirror>
```

![image-20201230191605279](就业技术加强-08-可持续化集成部署-1.assets/image-20201230191605279-1612172677919.png)

4）**配置Jenkins中的Jdk和Maven**

![image-20201230191743307](就业技术加强-08-可持续化集成部署-1.assets/image-20201230191743307-1612172677919.png)

![image-20201230191812111](就业技术加强-08-可持续化集成部署-1.assets/image-20201230191812111-1612172677919.png)



jdk 路径在Jenkins容器中的路径为：`/usr/java/jdk1.8.0_202-amd64`

maven路径在Jenkins容器中的路径为：`/usr/local/apache-maven-3.6.3`

![image-20201230192332541](就业技术加强-08-可持续化集成部署-1.assets/image-20201230192332541-1612172677919.png)

#### 4.4.4、创建Maven任务

![image-20201230201235335](就业技术加强-08-可持续化集成部署-1.assets/image-20201230201235335-1612172677919.png)

![image-20201230202737739](就业技术加强-08-可持续化集成部署-1.assets/image-20201230202737739-1612172677919.png)

设置Git仓库路径：

![image-20201230203221883](就业技术加强-08-可持续化集成部署-1.assets/image-20201230203221883-1612172677919.png)

![image-20201230210031042](就业技术加强-08-可持续化集成部署-1.assets/image-20201230210031042-1612172677919.png)

![image-20201230210204568](就业技术加强-08-可持续化集成部署-1.assets/image-20201230210204568-1612172677919.png)

设置在构建时要执行的命令： `clean package docker:removeImage docker:build`

![image-20201230210226781](就业技术加强-08-可持续化集成部署-1.assets/image-20201230210226781-1612172677919.png)

![image-20201230210238373](就业技术加强-08-可持续化集成部署-1.assets/image-20201230210238373-1612172677920.png)



构建完成后可以到docker服务器上查看最新构建的镜像；然后也可以通过修改代码，每3分钟如果有变化就会触发构建。

>Jenkins 更加完整的参考视频：https://www.bilibili.com/video/BV1kJ411p7mV

## 5、Rancher

### 5.1、简介

Rancher是一套容器管理平台,它可以帮助组织在生产环境中轻松快捷的部署和管理容器。

Rancher为采用容器的团队提供了完整的软件堆栈，解决了跨任何基础设施架构管理多个Kubernetes集群的运维和安全挑战，同时为DevOps团队提供了用于运行容器化工作负载的集成工具。

官网地址: <https://www.rancher.cn/> 

![1595075181534](就业技术加强-08-可持续化集成部署-1.assets/1595075181534-1612172677920.png)

![1595075199813](就业技术加强-08-可持续化集成部署-1.assets/1595075199813-1612172677920.png)



### 5.2、安装

1）根据docker版本拉去 Rancher镜像  [Supported Docker Versions](https://rancher.com/docs/rancher/v1.6/en/hosts/#supported-docker-versionstrueSupportedDockerVersions)， Docker版本是20+的考虑 Rancher 2.x。 以下步骤以Rancher 1.x为例。

  ```shell
docker pull rancher/server  #for Rancher 1.x
docker pull rancher/rancher #for Rancher 2.x
  ```

2）创建Rancher容器

  ```shell
#for Rancher 1.x
docker run -d --name=rancher -p 9191:8080 rancher/server

#for Rancher 2.x ，启动rancher的时候需要权限
docker run -d --privileged --restart=unless-stopped -p 80:80 -p 443:443 rancher/rancher



# 批量删除 rancher 相关的容器
docker rm $(docker ps -a | awk '/rancher/ {print $1}')
  ```

  3）浏览器访问: http://192.168.12.135:9191

  ![image-20201230212027579](就业技术加强-08-可持续化集成部署-1.assets/image-20201230212027579-1612172677920.png)

![image-20201230212041555](就业技术加强-08-可持续化集成部署-1.assets/image-20201230212041555-1612172677920.png)

4）切换至中文界面

![image-20201230212149494](就业技术加强-08-可持续化集成部署-1.assets/image-20201230212149494-1612172677920.png)



### 5.3、使用

1）**添加环境**

Rancher 支持将资源分组归属到多个环境。 每个环境具有自己独立的基础架构资源及服务，并由一个或多个用户、团队或组织所管理。
例如；您可以创建独立的“开发”、“测试”及“生产”环境以确保环境之间的安全隔离，将“开发”环境的访问权限赋予全部人员，但限制“生产”环境的访问权限给一个小的团队。

![image-20201230212430332](就业技术加强-08-可持续化集成部署-1.assets/image-20201230212430332-1612172677920.png)

![image-20201230212410588](就业技术加强-08-可持续化集成部署-1.assets/image-20201230212410588-1612172677920.png)

![image-20201230212554407](就业技术加强-08-可持续化集成部署-1.assets/image-20201230212554407-1612172677920.png)

![image-20201230212538348](就业技术加强-08-可持续化集成部署-1.assets/image-20201230212538348-1612172677920.png)

2）**配置主机**

以dev开发环境为例，选择dev，配置该环境所对应的主机。

![image-20201230212635681](就业技术加强-08-可持续化集成部署-1.assets/image-20201230212635681-1612172677920.png)

![image-20201230213254874](就业技术加强-08-可持续化集成部署-1.assets/image-20201230213254874-1612172677920.png)

![image-20201230213306770](就业技术加强-08-可持续化集成部署-1.assets/image-20201230213306770-1612172677920.png)

![image-20201230213320092](就业技术加强-08-可持续化集成部署-1.assets/image-20201230213320092-1612172677920.png)

![image-20201230213335705](就业技术加强-08-可持续化集成部署-1.assets/image-20201230213335705-1612172677920.png)

将上面复制的内容拷贝到我们的虚拟机中执行：

![image-20201230213416714](就业技术加强-08-可持续化集成部署-1.assets/image-20201230213416714-1612172677920.png)

执行完后，回到主机页面，稍等一会刷新页面可以看到主机信息，代表rancher已经连接到配置的主机服务器:

![image-20201230213518346](就业技术加强-08-可持续化集成部署-1.assets/image-20201230213518346-1612172677920.png)

![image-20201230213532437](就业技术加强-08-可持续化集成部署-1.assets/image-20201230213532437-1612172677920.png)

3）**创建容器**

1）点击【基础架构】菜单中的【容器】，进入到容器管理页面，可以看到当前服务器的容器列表。

![image-20201230213747636](就业技术加强-08-可持续化集成部署-1.assets/image-20201230213747636-1612172677920.png)

![image-20201230213820090](就业技术加强-08-可持续化集成部署-1.assets/image-20201230213820090-1612172677920.png)

2）点击【添加容器】按钮，创建容器:

填写名称、描述、端口映射等容器信息，点击下面的创建，即可创建容器。

![image-20201230213844440](就业技术加强-08-可持续化集成部署-1.assets/image-20201230213844440-1612172677920.png)

![image-20201230214111006](就业技术加强-08-可持续化集成部署-1.assets/image-20201230214111006-1612172677920.png) 

![image-20201230214151784](就业技术加强-08-可持续化集成部署-1.assets/image-20201230214151784-1612172677920.png)

  

3）浏览器访问: <http://192.168.12.135:9091/hello/itcast> 

![image-20201230214358405](assets/image-20201230214358405.png)