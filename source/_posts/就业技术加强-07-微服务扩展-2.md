---
title: 就业技术加强(07)-微服务扩展课堂笔记
tags:
  - 笔记
  - 微服务
  - Spring Cloud
  - Zuul
  - 限流
  - Nginx限流
  - Gateway限流
  - 分布式日志系统
  - GrayLog
  - 分布式链路追踪
  - Zipkin
  - skywalking 
categories:
  - 就业技术加强
date: 2021-01-31 22:54:24
---

### 01-微服务回顾

**目标**：能够说出Spring Cloud常用组件作用

**小结**：

- Eureka 注册中心；注册服务
- ribbon 负载均衡
- Hystrix 熔断器
- Feign 服务调用
- Config 配置中心
- Gateway 网关

### 02-微服务网关Gateway回顾

**目标**：能够说出网关的主要作用

**小结**：

网关：过滤、路由；那么可以在网关服务器中进行鉴定权限、限流



### 03-微服务网关Zuul

**目标**：能够根据配置使用Zuul路由到其它微服务

**小结**：

zuul与gateway网关是同类产品，都是可以进行过滤、路由；如果要使用zuul的话；那么如下：

1、添加启动器依赖；

```xml
        <dependency>
            <groupId>org.springframework.cloud</groupId>
            <artifactId>spring-cloud-starter-netflix-zuul</artifactId>
        </dependency>

```

2、在启动引导类配置注解；

![image-20210131092759558](就业技术加强-07-微服务扩展-2.assets/image-20210131092759558.png)

3、配置zuul路由信息

![image-20210131092821499](就业技术加强-07-微服务扩展-2.assets/image-20210131092821499.png)

### 04-限流-算法简介

**目标**：漏桶算法与令牌算法的区别

**小结**：

**为什么要限流**：在遇到并发量大的时候，为了系统的平稳运行正常处理请求；为了防止网络攻击

**限流算法**：

- 漏桶：按照一定的速率处理请求，如果超过桶大小（burst)会溢出也就是拒绝请求；不利于应对突发流量
- 令牌桶：按照一定的速率产生令牌，并可以动态设置产生速率和拿出令牌速率，比较适合应对突发流量

### 05-Nginx限流-速率

**目标**：通过配置Nginx配置项限制单个Ip的速率处理

**小结**：

![image-20210131103203439](就业技术加强-07-微服务扩展-2.assets/image-20210131103203439.png)

### 06-Nginx限流-并发量

**目标**：通过配置Nginx配置项限制单个Ip的最大连接数及服务器的总连接数

**小结**：

![image-20210131110130355](就业技术加强-07-微服务扩展-2.assets/image-20210131110130355.png)

### 07-Gateway限流

**目标**：了解Gateay限流的配置步骤

**小结**：

- 添加依赖

```xml
        <dependency>
            <groupId>org.springframework.boot</groupId>
            <artifactId>spring-boot-starter-data-redis-reactive</artifactId>
        </dependency>

```



- 注册关于限流key的解析器

![image-20210131111322295](就业技术加强-07-微服务扩展-2.assets/image-20210131111322295.png)

- 配置限流策略

![image-20210131111341301](就业技术加强-07-微服务扩展-2.assets/image-20210131111341301.png)

- 启动redis



### 08-分布式日志GrayLog

**目标**：能够说出分布式日志系统的应用场景

**小结**：

为什么**GrayLog**：在微服务中有很多子系统，这些系统都会产生日志；一旦遇到问题，那么需要逐个服务去收集查看这些日志信息，比较繁琐；使用分布式日志服务组件则可以集中的收集信息统一的在一个图形化界面中查看日志信息；方便高效。

业界：常用的是ELK、GrayLog

因为GrayLog可以解决如下问题：

+ 不能处理多行日志，比如mysql慢查询，Tomcat、Jetty应用的Java异常打印

+ 不能保留原始日志，只能把原始日志分字段保存，这样搜索日志结果是一堆Json格式文本，无法阅读。

+ 不符合正则表达式匹配的日志行，被全部丢弃。



### 09-安装GrayLog

**目标**：安装配置ElasticSearch、MongoDB、GrayLog

**小结**：

根据文档安装 ElasticSearch、MongoDB、GrayLog；安装之后对graylog设置了日志输入的格式 `GELF UDP`

### 10-项目中集成GrayLog

**目标**：通过配置将不同的分布式系统中的微服务系统日志统一被GrayLog采集查看

**小结**：

- 添加logstash-gelf依赖；

  ```xml
          <dependency>
              <groupId>biz.paluch.logging</groupId>
              <artifactId>logstash-gelf</artifactId>
              <version>1.13.0</version>
          </dependency>
  
  ```

  

- 添加日志配置文件

  ```xml
  <?xml version="1.0" encoding="UTF-8"?>
  <configuration>
      <!-- 控制台日志输出器 -->
      <appender name="STDOUT" class="ch.qos.logback.core.ConsoleAppender">
          <!-- 对日志进行格式化 -->
          <!--格式化输出：%d表示日期，%thread线程名，%-5level：级别 %msg：日志消息，%n是换行符-->
          <encoder>
              <pattern>%d{HH:mm:ss.SSS} [%thread] %-5level %logger{50} - %msg%n</pattern>
          </encoder>
      </appender>
  
      <!-- GrayLog日志输出器 -->
      <appender name="GELF" class="biz.paluch.logging.gelf.logback.GelfLogbackAppender">
          <!-- GrayLog服务端连接主机 【重要】-->
          <host>udp:192.168.12.135</host>
          <!-- GrayLog服务端连接端口 【重要】-->
          <port>12201</port>
          <!-- GrayLog服务端版本号 -->
          <version>1.1</version>
          <!-- 当前服务名称(服务id) 【重要】-->
          <facility>heima-user</facility>
          <!-- 附加字段 -->
          <additionalFields>version=4.1.0,module=heima-user</additionalFields>
          <!-- 记录异常跟踪栈日志 -->
          <extractStackTrace>true</extractStackTrace>
          <!-- 过滤异常跟踪栈日志 -->
          <filterStackTrace>true</filterStackTrace>
          <!-- 映射分析搜集的日志 -->
          <mdcProfiling>true</mdcProfiling>
          <!-- 时间戳格式化 -->
          <timestampPattern>yyyy-MM-dd HH:mm:ss,SSS</timestampPattern>
          <!-- 最大消息大小 -->
          <maximumMessageSize>8192</maximumMessageSize>
      </appender>
  
      <!-- 记录日志 additivity: false(只能在当前logger中使用) -->
      <logger name="com.bhd" level="DEBUG" additivity="false">
          <appender-ref ref="STDOUT"/>
          <appender-ref ref="GELF"/>
      </logger>
  
      <!-- 根记录日志 -->
      <root level="INFO">
          <appender-ref ref="STDOUT"/>
          <appender-ref ref="GELF"/>
      </root>
  </configuration>
  ```

  

### 11-分布式链路追踪

**目标**：能够说出分布式链路追踪意义

**小结**：

分布式链路追踪：可以在分布式、微服务架构中可以记录各个微服务之间的调用关系，形成调用链路、服务调用图；可以快速定位问题。

在业界中；对于这种追踪服务之间调用关系的系统称为APM。常见的产品有：

- spring cloud sleuth
- zipkin
- skywalking

### 12-Spring Cloud Sleuth简介

**目标**：Spring Cloud Sleuth特点及关键信息

**小结**：

sleuth：可以记录服务调用、统计分析、链路优化

术语：

- traceId 一次完整的业务请求只有唯一的一个traceId；
- spanId、parentId；记录一次请求中的某一段服务调用的id；如果存在有多次服务之间的调用的话，那么parentId则以上一个spanId为其值。
- 注解：可以记录客户端发起、接收、服务端接收、发起等这些时间戳。简称：cs/sr/ss/cr

### 13-Spring Cloud Sleuth应用

**目标**：查看IDEA控制台对应项目的链路追踪信息

**小结**：

如果要单独使用sleuth的话；那么直接添加如下依赖即可：

```xml
        <dependency>
            <groupId>org.springframework.cloud</groupId>
            <artifactId>spring-cloud-starter-sleuth</artifactId>
        </dependency>

```

![image-20210131151803013](就业技术加强-07-微服务扩展-2.assets/image-20210131151803013.png)

### 14-Zipkin应用

**目标**：应用Zipkin追踪微服务系统调用关系

**小结**：

1、搭建server服务器端；

2、配置client客户端，也就是我们自己开发的系统

- 添加依赖；
- 设置zipkin服务器地址和采样率

![image-20210131153639256](就业技术加强-07-微服务扩展-2.assets/image-20210131153639256.png)

![image-20210131153650154](就业技术加强-07-微服务扩展-2.assets/image-20210131153650154.png)

### 15-Skywalking应用

**目标**：应用Skywalking追踪微服务系统调用关系

**小结**：

- 启动skywalking服务器，可以修改存储媒介（es/mysql)

- 应用的话需要使用到skywalking 的探针；解压对应的包并找到 agent 路径的 `skywalking-agent.jar`

- 项目启动的过程中设置jvm启动项：

  ```
  -javaagent:F:/tmp/workspaces/apache-skywalking-apm-bin/agent/skywalking-agent.jar
  -Dskywalking.agent.service_name=heima-eureka
  -Dskywalking.collector.backend_service=192.168.12.135:11800
  ```

  