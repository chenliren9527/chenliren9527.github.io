---
title: 就业技术加强(05)-DUBBO&Zookeeper(1)
tags:
  - 笔记
  - 就业技术加强
  - DUBBO
  - Zookeeper
  - 集群
categories:
  - 就业技术加强
abbrlink: 48314
date: 2021-01-28 17:31:56
---

### 01-DUBBO架构回顾

**目标**：能够说出DUBBO架构各个组件应用流程

**小结**：

- 服务提供者：实例化服务，注册服务到注册中心
- 服务消费者：订阅服务，远程调用服务
- 注册中心：注册记录服务并通知消费者服务地址列表
- 监控中心：接受提供者、消费者的数据

### 02-导入案例工程

**目标**：导入 `dubbo-spring` 工程到IDEA空工程中

**小结**：

1、创建一个空工程；

2、复制 `资料\案例工程\dubbo-springboot`

3、导入工程到IDEA

### 03-案例工程说明

**目标**：能够说出 `goods` 及 `order` 分别在DUBBO架构下的角色

**小结**：

两个工程既是服务提供者又是消费者

![image-20210128090206623](就业技术加强-05-DUBBO-Zookeeper.assets/image-20210128090206623.png)

如果是使用了基于springboot的dubbo工程的话：那么只需要添加如下依赖和配置即可：

```xml
<dependency>
            <groupId>org.apache.dubbo</groupId>
            <artifactId>dubbo-spring-boot-starter</artifactId>
            <version>${dubbo.version}</version>
        </dependency>
```

![image-20210128090615483](就业技术加强-05-DUBBO-Zookeeper.assets/image-20210128090615483.png)

### 04-Zookeeper注册中心

**目标**：能够搭建并启动 zookeeper 服务器

**小结**：

解压 `资料\zookeeper-3.4.14.zip` 并执行 `zkServer.cmd`

> DUBBO可以使用的注册中心有：
>
> - zookeeper（推荐）
> - redis
> - nacos

### 05-DUBBO监控中心

**目标**：能够在IDEA中导入并启动监控中心

**小结**：

- 解压并导入工程到IDEA
- 启动 `DubboAdminApplication`

### 06-启动时检查

**目标**：应用启动时检查配置实现服务消费者与提供者之间的启动弱依赖

**小结**：

如果在开发过程中或者与其他服务联调的时候；出现需要调用的服务不可用时候那么可以使用DUBBO的启动时检查：可以有如下的方式设置：

1、在注解 `DubboReference` 设置 `check=false`

2、在配置文件中单独对某个服务接口设置或者全局设置

```yml
dubbo:
  consumer:
    check: false

```

- 是否使用？ 建议不要设置 `check=false`；尤其是生产环境尽量不要设置为false，这样可以尽早发现对应的服务是否有问题
- 如果要用；那么使用哪种方式？建议使用配置文件的方式

### 07-结果缓存

**目标**：配置 `cache` 实现在消费者端缓存远程服务结果缓存

**小结**：

可以通过如下的配置：

![image-20210128102129273](就业技术加强-05-DUBBO-Zookeeper.assets/image-20210128102129273.png)



> 结果缓存是DUBBO不再对远程服务发起调用，适应于查询的方法，其它的更新方法是不应该设置的

整个DUBBO的 `结果缓存` 也不应该使用；因为我们如果要做缓存是有缓存的特定业务逻辑的，我们应该自行实现，可以使用redis。



### 08-集群容错-案例1

**目标**：访问订单系统（order-service） http://localhost:9200/order/1 ，在商品系统存在异常时，订单系统尝试获取3台商品系统（goods-service）中订单对应的商品列表

**分析**：

商品系统存在异常 --》 可以在对应的商品服务方法中设置沉睡超过1秒，如果服务调用超时（默认1秒）的话则会产生异常报错。

商品系统（goods-service）这个系统需要提供商品服务，所以要暴露服务（20880），需要在应用服务器中提供服务（9100）；所以如果需要3台服务器的话为了避免端口冲突，需要修改端口号

- 第1台：9100,20880
- 第2台：9101,20881
- 第3台：9102,20882



**小结**：

在配置了3台服务之后；如果有一台服务调用失败则会去调用其它两台服务。因为DUBBO有一个默认的集群容错策略 `failover` 可以在服务有集群的情况下，一旦有一台服务调用失败会尝试其他所有的服务，如果尝试过程中有成功的话则不会再尝试剩下的那些服务器。

![image-20210128104029710](就业技术加强-05-DUBBO-Zookeeper.assets/image-20210128104029710.png)

### 09-集群容错-案例2

**目标**：访问订单系统（order-service） http://localhost:9200/order/add 生成订单；同时对商品系统（goods-service）中商品库存进行扣减；扣减若有异常不再向其它商品系统发起请求

**分析**：

生成订单：保存订单信息，扣减这笔订单对应买了多少个商品需要在商品系统中扣减商品数量

扣减若有异常不再向其它商品系统发起请求

- 如果扣减失败再发起其它请求：会产生多扣商品库存，引起商品没有完全卖完的情况
- 不发起其它请求：则不清楚商品是否已经被扣减了，需要再次确认处理

商品系统扣减异常 --》 可以在对应的商品服务方法中设置沉睡超过1秒，如果服务调用超时（默认1秒）的话则会产生异常报错。



**解决方法**：可以使用DUBBO的集群容错策略 `failfast` 在调用服务的时候如果有异常或者报错了，那么不再尝试访问其它的集群服务节点。



**小结**：

配置具体如下：

![image-20210128111325704](就业技术加强-05-DUBBO-Zookeeper.assets/image-20210128111325704.png)



### 10-集群容错分析说明

**目标**：能够区别出 `failover` 与 `failfast`并说出对应的使用场景。

**小结**：

![image-20210128112109844](就业技术加强-05-DUBBO-Zookeeper.assets/image-20210128112109844.png)

> 常用的集群容错策略：
>
> 1、failover 默认策略，失败自动切换；常用于查询方法
>
> 2、failfast 快速失败，常用于新增、修改、删除



### 11-服务降级-Mock本地伪装

**目标**：在服务提供者goods-service有问题时，服务消费者order-service可以快速响应，进行服务熔断、降级

**小结**：

在DUBBO中，如果服务提供方出现问题或者在开发的时候对方没有开发好功能的话；那么可以使用服务屏蔽、容错。方式有如下两种：

1、可以在代码中设置：

![image-20210128113507491](就业技术加强-05-DUBBO-Zookeeper.assets/image-20210128113507491.png)

2、可以在监控中心设置：

![image-20210128113526734](就业技术加强-05-DUBBO-Zookeeper.assets/image-20210128113526734.png)



### 12-服务降级-Hystrix

**目标**：应用Hystrix解决服务提供者goods-service有问题时，服务消费者order-service可以快速响应，进行服务降级

**小结**：

如果在使用了DUBBO的架构中要使用hystrix熔断器的话：

- 添加依赖

```xml
<dependency>
            <groupId>org.springframework.cloud</groupId>
            <artifactId>spring-cloud-starter-netflix-hystrix</artifactId>
            <version>2.2.6.RELEASE</version>
        </dependency>
```



- 设置启动引导类添加注解 `@EnableCircuitBreaker`
- 在有需要进行服务降级的方法上面添加 `@HystrixCommand(fallbackMethod = "fallback")`

### 13-负载均衡策略

**目标**：能够说出 `随机` `轮询` `最少活跃调用数` `一致性Hash`的特点

**小结**：

- 随机：无概率随机访问，但是可以设置权重，权重越大访问的机率越高
- 轮询：逐个服务器轮着访问；如果有设置权重的话，那么也会根据权重使用概率轮着访问服务器
- 最少活跃数：服务提供方会被记录访问的时间和次数，如果活跃低的话那么被访问的机率就低
- 一致性Hash：根据请求的地址指向某个服务器，一旦这个服务器宕机也会去访问其他的服务器

### 14-负载均衡策略案例应用

**目标**：商品服务系统goods-service中有3台服务提供者，这3台服务机器配置性能都相当。在订单服务系统order-service调用的时候希望可以轮流调用 `findGoodsByOrderId`

**分析**：

因为要轮流调用服务器，所以可以dubbo的负载均衡策略——轮询



**小结**：

可以通过如下方式：

1、代码中设置负载均衡策略；

![image-20210128121528580](就业技术加强-05-DUBBO-Zookeeper.assets/image-20210128121528580.png)

2、在监控中心设置设置负载均衡策略；

![image-20210128121546376](就业技术加强-05-DUBBO-Zookeeper.assets/image-20210128121546376.png)

3、还可以在监控中心设置各个服务的权重：

![image-20210128121633248](就业技术加强-05-DUBBO-Zookeeper.assets/image-20210128121633248.png)



### 15-灰度发布

**目标**：DUBBO中的灰度发布的使用场景

**小结**：

**使用场景**：在系统更新的时候，为了保证系统稳定、长期有效运行；可以将一部分服务器先升级，保留一部分旧系统提供服务的话。在DUBBO通过设置版本号实现服务消费者对应调用不同版本的服务提供者，而不混乱；具体的实现方式：

1、在 `@DubboService(version=xxx)`设置服务版本；

2、在服务提供者配置文件中设置版本号；

3、在消费者的配置文件中指定需要使用的服务版本号即可



### 16-Zookeeper集群

**目标**：搭建Zookeeper集群，在DUBBO中的服务提供者、消费者中应用zookeeper集群

**小结**：

- 搭建单机版zookeeper
  - 上传并解压文件
  - 创建存放数据的目录；
  - 并在数据目录中创建 `myid` 里面设置zk的集群节点id
  - 复制 `zoo.cfg`修改数据目录，客户端连接端口号，监听和选举端口
- 复制并修改配置信息
- 应用zookeeper集群；在使用到了的地方修改为： `zookeeper://ip:zk端口?ip:zk集群节点端口号,ip:zk集群节点端口号`

### 17-常见面试题

**目标**：能够说出DUBBO常见面试题对应的答案

**小结**：

详见《讲义》