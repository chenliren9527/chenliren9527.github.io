---
title: 乐优电商(03)-品牌管理
tags:
  - 笔记
  - 项目实战二
  - springcloud
  - 微服务
  - 前端
  - Vuejs
  - vuetifyjs
  - 分页
categories:
  - 项目实战二
abbrlink: 8839
date: 2020-12-27 12:59:41
---

## 01、学习目标

- 实现品牌查询功能
- 独立实现品牌新增





## 02、从零开始制作页面：添加品牌菜单

https://v15.vuetifyjs.com/zh-Hans/getting-started/quick-start



商品分类完成以后，自然轮到了品牌功能了。

分析左侧菜单的数据：

<img src="乐优电商-03-品牌管理.assets/1600821923201.png" alt="1600821923201" style="zoom:67%;" />![1600821956296](乐优电商-03-品牌管理.assets/1600821956296.png)



<img src="乐优电商-03-品牌管理.assets/1600821923201.png" alt="1600821923201" style="zoom:67%;" />![1600821956296](乐优电商-03-品牌管理.assets/1600821956296.png)

<img src="乐优电商-03-品牌管理.assets/1600821979712.png" alt="1600821979712" style="zoom:67%;" />

先看看我们要实现的效果：

![image-20200417095828922](乐优电商-03-品牌管理.assets/image-20200417095828922.png) 

接下来，我们从0开始，实现下从前端到后端的完整开发。

提供自定义品牌菜单项

在menu.js中添加菜单名称

![image-20200314092117866](乐优电商-03-品牌管理.assets/image-20200314092117866.png)

在路由router.js指定菜单path所跳转的页面

![image-20200314092203699](乐优电商-03-品牌管理.assets/image-20200314092203699.png)

在对应跳转路径下新建一个MyBrand.vue空文件

![1575269627152](乐优电商-03-品牌管理.assets/1575269627152-1578195702430.png) 



MyBrand.vue的内容：

```xml
<template>
    <div>我的品牌页面</div>
</template>
```





## 03、从零开始制作页面：品牌列表展示

参考文档： https://v15.vuetifyjs.com/en/getting-started/quick-start

### 1）找到一个服务端分页组件

![image-20200314092907926](乐优电商-03-品牌管理.assets/image-20200314092907926.png)



点进去源码

![image-20200314092955711](乐优电商-03-品牌管理.assets/image-20200314092955711.png)

分别复制template和script到MyBrand.vue页面中，稍微改动了一点点。

```vue
<template>
    <div>
        <v-data-table
                :headers="headers"
                :items="desserts"
                :pagination.sync="pagination"
                :total-items="totalDesserts"
                :loading="loading"
                class="elevation-1"
        >
            <!--
            slot="items" 指定要遍历的数据
            slot-scope="props" 把当前遍历的数据起个别名
            -->
            <template slot="items" slot-scope="props">
                <td>{{ props.item.name }}</td>
                <td class="text-xs-right">{{ props.item.calories }}</td>
                <td class="text-xs-right">{{ props.item.fat }}</td>
                <td class="text-xs-right">{{ props.item.carbs }}</td>
                <td class="text-xs-right">{{ props.item.protein }}</td>
                <td class="text-xs-right">{{ props.item.iron }}</td>
            </template>
        </v-data-table>
    </div>
</template>
<script>
    export default {
        data () {
            return {
                totalDesserts: 0,
                desserts: [],
                loading: true,
                pagination: {},
                headers: [
                    {
                        text: 'Dessert (100g serving)',
                        align: 'left',
                        sortable: false,
                        value: 'name'
                    },
                    { text: 'Calories', value: 'calories' },
                    { text: 'Fat (g)', value: 'fat' },
                    { text: 'Carbs (g)', value: 'carbs' },
                    { text: 'Protein (g)', value: 'protein' },
                    { text: 'Iron (%)', value: 'iron' }
                ]
            }
        },
        watch: {
            pagination: {
                handler () {
                    this.getDataFromApi()
                        .then(data => {
                            this.desserts = data.items
                            this.totalDesserts = data.total
                        })
                },
                deep: true
            }
        },
        mounted () {
            this.getDataFromApi()
                .then(data => {
                    this.desserts = data.items
                    this.totalDesserts = data.total
                })
        },
        methods: {
            getDataFromApi () {
                this.loading = true
                return new Promise((resolve, reject) => {
                    const { sortBy, descending, page, rowsPerPage } = this.pagination

                    let items = this.getDesserts()
                    const total = items.length

                    if (this.pagination.sortBy) {
                        items = items.sort((a, b) => {
                            const sortA = a[sortBy]
                            const sortB = b[sortBy]

                            if (descending) {
                                if (sortA < sortB) return 1
                                if (sortA > sortB) return -1
                                return 0
                            } else {
                                if (sortA < sortB) return -1
                                if (sortA > sortB) return 1
                                return 0
                            }
                        })
                    }

                    if (rowsPerPage > 0) {
                        items = items.slice((page - 1) * rowsPerPage, page * rowsPerPage)
                    }

                    setTimeout(() => {
                        this.loading = false
                        resolve({
                            items,
                            total
                        })
                    }, 1000)
                })
            },
            getDesserts () {
                return [
                    {
                        name: 'Frozen Yogurt',
                        calories: 159,
                        fat: 6.0,
                        carbs: 24,
                        protein: 4.0,
                        iron: '1%'
                    },
                    {
                        name: 'Ice cream sandwich',
                        calories: 237,
                        fat: 9.0,
                        carbs: 37,
                        protein: 4.3,
                        iron: '1%'
                    },
                    {
                        name: 'Eclair',
                        calories: 262,
                        fat: 16.0,
                        carbs: 23,
                        protein: 6.0,
                        iron: '7%'
                    },
                    {
                        name: 'Cupcake',
                        calories: 305,
                        fat: 3.7,
                        carbs: 67,
                        protein: 4.3,
                        iron: '8%'
                    },
                    {
                        name: 'Gingerbread',
                        calories: 356,
                        fat: 16.0,
                        carbs: 49,
                        protein: 3.9,
                        iron: '16%'
                    },
                    {
                        name: 'Jelly bean',
                        calories: 375,
                        fat: 0.0,
                        carbs: 94,
                        protein: 0.0,
                        iron: '0%'
                    },
                    {
                        name: 'Lollipop',
                        calories: 392,
                        fat: 0.2,
                        carbs: 98,
                        protein: 0,
                        iron: '2%'
                    },
                    {
                        name: 'Honeycomb',
                        calories: 408,
                        fat: 3.2,
                        carbs: 87,
                        protein: 6.5,
                        iron: '45%'
                    },
                    {
                        name: 'Donut',
                        calories: 452,
                        fat: 25.0,
                        carbs: 51,
                        protein: 4.9,
                        iron: '22%'
                    },
                    {
                        name: 'KitKat',
                        calories: 518,
                        fat: 26.0,
                        carbs: 65,
                        protein: 7,
                        iron: '6%'
                    }
                ]
            }
        }
    }
</script>
```

### 2）页面数据分析【data】

> 大家注意：
>
> 我们看一个vue页面，一定是从script的data中开始。
>
> 整个页面要用到的所有数据，都必须在data中定义。
>
> 其中data定义的变量的值的来源又分几类：
>
> 收集template页面数据到data中
>
> 接收后台响应的数据到data中
>
> 纯定义数据在页面使用的



查看data中的数据

![image-20200314094318516](乐优电商-03-品牌管理.assets/image-20200314094318516.png)

把表头信息改成我们自己的品牌表的字段

```js
data () {
    return {
        totalDesserts: 0,//总记录数
        desserts: [],//当前页的数据列表
        loading: true,//加载进度条的特效
        pagination: {},//分页插件
        headers: [//表头信息
            { text: '品牌编号', align: 'center', value: 'id'},
            { text: '品牌名称', align: 'center', value: 'name' },
            { text: '品牌图片', align: 'center', sortable: false, value: 'image' },
            { text: '品牌字母', align: 'center', value: 'letter' }
        ]
    }
},
```

修改后页面的效果为：

![image-20200314094928933](乐优电商-03-品牌管理.assets/image-20200314094928933.png)

### 3）渲染列表数据【通过钩子函数获取到要渲染的数据】

上面，我们已经在data中定义好页面使用的数据了。

接下来，我们要在钩子函数中，向服务器发起请求，并获取数据列表和分页信息。

首先，模拟服务器返回的数据

```json
 [
     {id: 2032, name: "OPPO", image: "1.jpg", letter: "O"},
     {id: 2033, name: "飞利浦", image: "2.jpg", letter: "F"},
     {id: 2034, name: "华为", image: "3.jpg", letter: "H"},
     {id: 2036, name: "酷派", image: "4.jpg", letter: "K"},
     {id: 2037, name: "魅族", image: "5.jpg", letter: "M"}
 ]
```

品牌中有id,name,image,letter字段。把这些数据放入页面中。

![image-20200314100033759](乐优电商-03-品牌管理.assets/image-20200314100033759.png)

再次查看页面效果：

![image-20200314100052347](乐优电商-03-品牌管理.assets/image-20200314100052347.png)

在template中找到哪个地方使用了数据列表的变量

![image-20200314100251243](乐优电商-03-品牌管理.assets/image-20200314100251243.png)

我们已经知道凡是":"号开头的属性，都是可以识别vue数据的属性。这里这个:item就是分页列表插件接收列表数据的属性，具体遍历在下面这段代码中：

![image-20200314100733771](乐优电商-03-品牌管理.assets/image-20200314100733771.png)

此刻页面效果为：

![image-20200314100754290](乐优电商-03-品牌管理.assets/image-20200314100754290.png)



### 4）总结vue页面渲染数据的流程

第一步：在data中定义数据

第二步：在钩子函数中发起请求

第三步：如果请求需要参数，在data中直接拿，不需要参数则忽略步骤

第四步：发起服务器请求，在回调函数中，把服务器返回的数据，赋值给data中定义的变量

第五步：直接在template中渲染数据



## 04、从零开始制作页面：添加按钮和搜索框

在table上面加入如下代码：

```html
		<v-layout row wrap>
            <v-flex xs6>
                <v-btn round color="primary" dark>品牌添加</v-btn>
            </v-flex>
            <v-flex xs6>
            <v-text-field
                    label="搜索"
                    prepend-icon="search"
            ></v-text-field>
            </v-flex>
        </v-layout>
```

此刻效果如下：

![image-20200314103420235](乐优电商-03-品牌管理.assets/image-20200314103420235.png)

MyBrand.vue页面

```html
<template>
    <div>
        <v-layout row wrap>
            <v-flex xs6>
                <v-btn color="primary" round>品牌添加</v-btn>
            </v-flex>
            <v-flex xs6>
                <v-text-field
                        label="搜索"
                        prepend-icon="search"
                ></v-text-field>
            </v-flex>

        </v-layout>
        <!--
            headers: 定义表头信息
            items： 定义表的内容（数据列表） ***
            pagination： 定义分页参数数据  ***
            total-items： 总记录数   ***
            loading： 进度条效果
        -->
        <v-data-table
                :headers="headers"
                :items="desserts"
                :pagination.sync="pagination"
                :total-items="totalDesserts"
                :loading="loading"
                class="elevation-1"
        >
            <template v-slot:items="props">
                <td class="text-xs-center">{{ props.item.id }}</td>
                <td class="text-xs-center">{{ props.item.name }}</td>
                <td class="text-xs-center">{{ props.item.image }}</td>
                <td class="text-xs-center">{{ props.item.letter }}</td>
            </template>
        </v-data-table>
    </div>
</template>

<script>
    export default {
        data () {
            return {
                totalDesserts: 0,
                desserts: [],
                loading: true,
                pagination: {},
                headers: [
                    { text: '品牌编号', value: 'id' , align:'center'},
                    { text: '品牌名称', value: 'name', align:'center' ,sortable:false },
                    { text: '品牌图片', value: 'image', align:'center' ,sortable:false },
                    { text: '品牌字母', value: 'letter', align:'center' },
                ]
            }
        },
        watch: {
            pagination: {
                handler () {
                    this.getDataFromApi()
                        .then(data => {
                            this.desserts = data.items
                            this.totalDesserts = data.total
                        })
                },
                deep: true
            }
        },
        mounted () {
            this.getDataFromApi()
                .then(data => {
                    this.desserts = data.items
                    this.totalDesserts = data.total
                })
        },
        methods: {
            getDataFromApi () {
                this.loading = true
                return new Promise((resolve, reject) => {
                    const { sortBy, descending, page, rowsPerPage } = this.pagination

                    let items = this.getDesserts()
                    const total = items.length

                    if (this.pagination.sortBy) {
                        items = items.sort((a, b) => {
                            const sortA = a[sortBy]
                            const sortB = b[sortBy]

                            if (descending) {
                                if (sortA < sortB) return 1
                                if (sortA > sortB) return -1
                                return 0
                            } else {
                                if (sortA < sortB) return -1
                                if (sortA > sortB) return 1
                                return 0
                            }
                        })
                    }

                    if (rowsPerPage > 0) {
                        items = items.slice((page - 1) * rowsPerPage, page * rowsPerPage)
                    }

                    setTimeout(() => {
                        this.loading = false
                        resolve({
                            items,
                            total
                        })
                    }, 1000)
                })
            },
            getDesserts () {
                return  [
                    {id: 2032, name: "OPPO", image: "1.jpg", letter: "O"},
                    {id: 2033, name: "飞利浦", image: "2.jpg", letter: "F"},
                    {id: 2034, name: "华为", image: "3.jpg", letter: "H"},
                    {id: 2036, name: "酷派", image: "4.jpg", letter: "K"},
                    {id: 2037, name: "魅族", image: "5.jpg", letter: "M"}
                ]
            }
        }
    }
</script>
```





## 05、从零开始制作页面：改为服务端分页

### 1）删除客户端分页的代码

虽然我们用的是服务端分页的插件，但是vuetify为了便于前端工作人员，可以更好的调整页面样式，给我们临时做了一个页面效果出来，我们要去掉这个效果，其实就是删除getDataFromApi方法，并删除相关连带的部分，最终代码如下：

```vue
<template>
    <div>
        <v-layout row wrap>
            <v-flex xs6>
                <v-btn round color="primary" dark>品牌添加</v-btn>
            </v-flex>
            <v-flex xs6>
            <v-text-field
                    label="搜索"
                    prepend-icon="search"
            ></v-text-field>
            </v-flex>
        </v-layout>
        <v-data-table
                :headers="headers"
                :items="desserts"
                :pagination.sync="pagination"
                :total-items="totalDesserts"
                :loading="loading"
                class="elevation-1"
        >
            <!--
            slot="items" 指定要遍历的数据
            slot-scope="props" 把当前遍历的数据items起个别名
            props中有个固定的属性叫item，是props遍历时的临时变量
            也就是说item就相当于一个品牌对象了
            -->
            <template slot="items" slot-scope="props">
                <td class="text-xs-center">{{ props.item.id }}</td>
                <td class="text-xs-center">{{ props.item.name }}</td>
                <td class="text-xs-center">{{ props.item.image }}</td>
                <td class="text-xs-center">{{ props.item.letter }}</td>
            </template>
        </v-data-table>
    </div>
</template>
<script>
    export default {
        data () {
            return {
                totalDesserts: 0,//总记录数
                desserts: [],//当前页的数据列表
                loading: true,//加载进度条的特效
                pagination: {},//分页插件
                headers: [//表头信息
                    { text: '品牌编号', align: 'center', value: 'id'},
                    { text: '品牌名称', align: 'center', value: 'name' },
                    { text: '品牌图片', align: 'center', sortable: false, value: 'image' },
                    { text: '品牌字母', align: 'center', value: 'letter' }
                ]
            }
        },
        mounted () {

        },
        methods: {

            getDesserts () {
                return  [
                    {id: 2032, name: "OPPO", image: "1.jpg", letter: "O"},
                    {id: 2033, name: "飞利浦", image: "2.jpg", letter: "F"},
                    {id: 2034, name: "华为", image: "3.jpg", letter: "H"},
                    {id: 2036, name: "酷派", image: "4.jpg", letter: "K"},
                    {id: 2032, name: "OPPO", image: "1.jpg", letter: "O"},
                    {id: 2033, name: "飞利浦", image: "2.jpg", letter: "F"},
                    {id: 2034, name: "华为", image: "3.jpg", letter: "H"},
                    {id: 2036, name: "酷派", image: "4.jpg", letter: "K"},
                    {id: 2036, name: "酷派", image: "4.jpg", letter: "K"},
                    {id: 2036, name: "酷派", image: "4.jpg", letter: "K"},
                    {id: 2036, name: "酷派", image: "4.jpg", letter: "K"},
                    {id: 2037, name: "魅族", image: "5.jpg", letter: "M"}
                ]
            }
        }
    }
</script>
```

### 2）自己来定义一个服务端分页的请求方法

在methods中定义方法：

```js
loadBrandData(){
    this.desserts = this.getDesserts ()//给当前data中的数据列表赋值
    this.totalDesserts = 20 //给总数据量赋值
},
```

在钩子函数中调用上面的方法：

```js
mounted () {
    //发起服务端分页请求
    this.loadBrandData()
},
```

此刻最终代码如下：

```vue
<template>
    <div>
        <v-layout row wrap>
            <v-flex xs6>
                <v-btn color="primary" round>品牌添加</v-btn>
            </v-flex>
            <v-flex xs6>
                <v-text-field
                        label="搜索"
                        prepend-icon="search"
                ></v-text-field>
            </v-flex>

        </v-layout>
        <!--
            headers: 定义表头信息
            items： 定义表的内容（数据列表） ***
            pagination： 定义分页参数数据  ***
            total-items： 总记录数   ***
            loading： 进度条效果
        -->
        <v-data-table
                :headers="headers"
                :items="desserts"
                :pagination.sync="pagination"
                :total-items="totalDesserts"
                :loading="loading"
                class="elevation-1"
        >
            <template v-slot:items="props">
                <td class="text-xs-center">{{ props.item.id }}</td>
                <td class="text-xs-center">{{ props.item.name }}</td>
                <td class="text-xs-center">{{ props.item.image }}</td>
                <td class="text-xs-center">{{ props.item.letter }}</td>
            </template>
        </v-data-table>
    </div>
</template>

<script>
    export default {
        data () {
            return {
                totalDesserts: 0,
                desserts: [],
                loading: true,
                pagination: {},
                headers: [
                    { text: '品牌编号', value: 'id' , align:'center'},
                    { text: '品牌名称', value: 'name', align:'center' ,sortable:false },
                    { text: '品牌图片', value: 'image', align:'center' ,sortable:false },
                    { text: '品牌字母', value: 'letter', align:'center' },
                ]
            }
        },
        mounted () {
            //调用分页查询品牌
            this.loadBrandData();
        },
        methods: {
            //分页查询品牌
            loadBrandData(){
                this.desserts = this.getDesserts();
                this.totalDesserts = 20;
            },

            getDesserts () {
                return  [
                    {id: 2032, name: "OPPO", image: "1.jpg", letter: "O"},
                    {id: 2033, name: "飞利浦", image: "2.jpg", letter: "F"},
                    {id: 2034, name: "华为", image: "3.jpg", letter: "H"},
                    {id: 2036, name: "酷派", image: "4.jpg", letter: "K"},
                    {id: 2037, name: "魅族", image: "5.jpg", letter: "M"}
                ]
            }
        }
    }
</script>
```

## 06、从零开始制作页面：向后端请求品牌分页数据

### 说明

截至目前，我们的品牌静态页面已经做好了，接下来，就是vue代码部分了！

使用vue把静态页面变成动态页面的步骤如下：

### 第一步：参考开发api文档

![image-20200314105447150](乐优电商-03-品牌管理.assets/image-20200314105447150.png)

### 第二步：根据api要求提供要向后台传输的参数

在data中定义一个变量接收搜索数据

![image-20200314105657844](乐优电商-03-品牌管理.assets/image-20200314105657844.png)

在页面上使用双向绑定给searchKey赋值

![image-20200314105744685](乐优电商-03-品牌管理.assets/image-20200314105744685.png)



如果我们使用了vuetify，那么所有分页相关的数据，无需自己在data中定义，在data中的pagination是空对象，但是我们用vue的chrome插件查看页面的数据发现，里面都已经包含了所有的分页条件，如下：

![1575283525398](乐优电商-03-品牌管理.assets/1575283525398.png) 

条件如下：

```json
{"descending":false,"page":1,"rowsPerPage":5,"sortBy":"id","totalItems":0}
```

我们在代码中并没有给pagination赋值，但是发现打开页面它就自己有值了，所以是框架给我们赋的值，也就是说这些数据我们都不用关心了，我们只需要把后台的数据正确返回页面就能显示了。

### 第三步：页面发起后台服务器请求

修改向后台发起请求的方法：

```js
methods: {
            //分页查询品牌
            loadBrandData(){
                //请求后台
                this.$http.get('/item/brand/page',{
                    params:{
                      page:this.pagination.page,
                      rows:this.pagination.rowsPerPage,
                      key:this.searchKey,
                      sortBy:this.pagination.sortBy,
                      desc:this.pagination.descending
                    }
                }).then(resp=>{
                    this.desserts = this.getDesserts();
                    this.totalDesserts = 20;
                }).catch(e=>{
                    console.log('查询品牌失败');
                })
            },

            getDesserts () {
                return  [
                    {id: 2032, name: "OPPO", image: "1.jpg", letter: "O"},
                    {id: 2033, name: "飞利浦", image: "2.jpg", letter: "F"},
                    {id: 2034, name: "华为", image: "3.jpg", letter: "H"},
                    {id: 2036, name: "酷派", image: "4.jpg", letter: "K"},
                    {id: 2037, name: "魅族", image: "5.jpg", letter: "M"}
                ]
            }
        }
```

通过页面f12在网络中查看效果

![image-20200314111449691](乐优电商-03-品牌管理.assets/image-20200314111449691.png)



![image-20200314111504448](乐优电商-03-品牌管理.assets/image-20200314111504448.png)



## 07、从零开始制作页面：监听分页参数与查询条件

添加watch的监听事件，由于分页参数是一个对象，所以我们需要使用深度监听。

在Vue中添加watch事件

```js
//监听
        watch:{
            "searchKey":{
                handler(){
                    this.loadBrandData();
                }
            },
            "pagination":{
                deep:true,//深度监听。注意：监听对象里面的属性变化时用到
                handler(){
                    this.loadBrandData();
                }
            }
        },
```

**最终页面代码为：**

```vue
<template>
    <div>
        <v-layout row wrap>
            <v-flex xs6>
                <v-btn color="primary" round>品牌添加</v-btn>
            </v-flex>
            <v-flex xs6>
                <v-text-field
                        label="搜索"
                        prepend-icon="search"
                        v-model="searchKey"
                ></v-text-field>
            </v-flex>

        </v-layout>
        <!--
            headers: 定义表头信息
            items： 定义表的内容（数据列表） ***
            pagination： 定义分页参数数据  ***
            total-items： 总记录数   ***
            loading： 进度条效果
        -->
        <v-data-table
                :headers="headers"
                :items="desserts"
                :pagination.sync="pagination"
                :total-items="totalDesserts"
                :loading="loading"
                class="elevation-1"
        >
            <template v-slot:items="props">
                <td class="text-xs-center">{{ props.item.id }}</td>
                <td class="text-xs-center">{{ props.item.name }}</td>
                <td class="text-xs-center">{{ props.item.image }}</td>
                <td class="text-xs-center">{{ props.item.letter }}</td>
            </template>
        </v-data-table>
    </div>
</template>

<script>
    export default {
        data () {
            return {
                totalDesserts: 0,
                desserts: [],
                loading: true,
                pagination: {},
                headers: [
                    { text: '品牌编号', value: 'id' , align:'center'},
                    { text: '品牌名称', value: 'name', align:'center' ,sortable:false },
                    { text: '品牌图片', value: 'image', align:'center' ,sortable:false },
                    { text: '品牌字母', value: 'letter', align:'center' },
                ],
                searchKey:'',//搜索关键词
            }
        },
        mounted () {
            //调用分页查询品牌
            this.loadBrandData();
        },
        //监听
        watch:{
            "searchKey":{
                handler(){
                    this.loadBrandData();
                }
            },
            "pagination":{
                deep:true,//深度监听。注意：监听对象里面的属性变化时用到
                handler(){
                    this.loadBrandData();
                }
            }
        },
        methods: {
            //分页查询品牌
            loadBrandData(){
                //请求后台
                this.$http.get('/item/brand/page',{
                    params:{
                      page:this.pagination.page,
                      rows:this.pagination.rowsPerPage,
                      key:this.searchKey,
                      sortBy:this.pagination.sortBy,
                      desc:this.pagination.descending
                    }
                }).then(resp=>{
                    this.desserts = this.getDesserts();
                    this.totalDesserts = 20;
                }).catch(e=>{
                    console.log('查询品牌失败');
                })
            },

            getDesserts () {
                return  [
                    {id: 2032, name: "OPPO", image: "1.jpg", letter: "O"},
                    {id: 2033, name: "飞利浦", image: "2.jpg", letter: "F"},
                    {id: 2034, name: "华为", image: "3.jpg", letter: "H"},
                    {id: 2036, name: "酷派", image: "4.jpg", letter: "K"},
                    {id: 2037, name: "魅族", image: "5.jpg", letter: "M"}
                ]
            }
        }
    }
</script>
```





## 08、编写品牌后台接口：品牌模块的准备工作

### 1）通用的分页对象

我们把这个对象放到 ly-common 模块的pojo包中。

```java
package com.leyou.common.pojo;

import lombok.AllArgsConstructor;
import lombok.Data;
import lombok.NoArgsConstructor;

import java.util.List;

/**
 * 通用的分页封装对象
 */
@Data
@AllArgsConstructor
@NoArgsConstructor
public class PageResult<T> {
    private Long total;//总记录数
    private Long totalPage;//总页数
    private List<T> items;
}


```

### 2）品牌entity对象 

放在ly-item-pojo模块的pojo包下

```java
package com.leyou.item.pojo;

import com.baomidou.mybatisplus.annotation.IdType;
import com.baomidou.mybatisplus.annotation.TableId;
import com.baomidou.mybatisplus.annotation.TableName;
import lombok.Data;

import java.util.Date;

/**
 * 品牌
 */
@Data
@TableName("tb_brand")
public class Brand {
    @TableId(type = IdType.AUTO)
    private Long id;
    private String name;
    private String image;
    private String letter;
    private Date createTime;
    private Date updateTime;
}

```

### 3）创建Mapper

放在ly-item项目下

```java
package com.leyou.item.mapper;

import com.baomidou.mybatisplus.core.mapper.BaseMapper;
import com.leyou.item.entity.Brand;

public interface BrandMapper extends BaseMapper<Brand> {
}
```

### 4）创建service

放在ly-item项目下

```java
package com.leyou.item.service;

import com.leyou.item.mapper.BrandMapper;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.stereotype.Service;
import org.springframework.transaction.annotation.Transactional;

/**
 * 品牌Service
 */
@Service
@Transactional
public class BrandService {

    @Autowired
    private BrandMapper brandMapper;

}

```

### 5）创建controller

放在ly-item项目下

```java
package com.leyou.item.controller;

import com.leyou.item.service.BrandService;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.web.bind.annotation.RestController;

@RestController
public class BrandController {

    @Autowired
    private BrandService brandService;

}
```



## 09、编写品牌后台接口：品牌分页查询(**)

### 1） 独立创建MybatisPlus分页拦截器(*)

编写分页配置类

```java
package com.leyou.item.config;

import com.baomidou.mybatisplus.extension.plugins.PaginationInterceptor;
import org.springframework.context.annotation.Bean;
import org.springframework.context.annotation.Configuration;

/**
 * 分页插件配置类
 */
@Configuration
public class PageHelperConfiguration {

    /**
     * 创建分页插件拦截器对象
     */
    @Bean
    public PaginationInterceptor paginationInterceptor(){
        return new PaginationInterceptor();
    }

}



```

<img src="乐优电商-03-品牌管理.assets/assets/1603595828422.png" alt="1603595828422" style="zoom:67%;" />



### 2）编写处理器

```java
package com.leyou.item.controller;

import com.leyou.common.pojo.PageResult;
import com.leyou.item.pojo.Brand;
import com.leyou.item.service.BrandService;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.http.ResponseEntity;
import org.springframework.web.bind.annotation.GetMapping;
import org.springframework.web.bind.annotation.RequestParam;
import org.springframework.web.bind.annotation.RestController;

/**
 * 品牌
 */
@RestController
public class BrandController {
    @Autowired
    private BrandService brandService;

    /**
     * 品牌分页查询
     */
    @GetMapping("/brand/page")
    public ResponseEntity<PageResult<Brand>> brandPageQuery(
            @RequestParam(value = "page",defaultValue = "1") Integer page,
            @RequestParam(value = "rows",defaultValue = "5") Integer rows,
            @RequestParam(value = "key",required = false) String key,
            @RequestParam(value = "sortBy",required = false) String sortBy,
            @RequestParam(value = "desc",required = false) Boolean desc
    ){
        PageResult<Brand> pageResult = brandService.brandPageQuery(page,rows,key,sortBy,desc);
        return ResponseEntity.ok(pageResult);
    }
}



```

### 3）创建Service

```java
package com.leyou.item.service;

import com.baomidou.mybatisplus.core.conditions.query.QueryWrapper;
import com.baomidou.mybatisplus.core.metadata.IPage;
import com.baomidou.mybatisplus.core.toolkit.StringUtils;
import com.baomidou.mybatisplus.core.toolkit.Wrappers;
import com.baomidou.mybatisplus.extension.plugins.pagination.Page;
import com.leyou.common.pojo.PageResult;
import com.leyou.item.mapper.BrandMapper;
import com.leyou.item.pojo.Brand;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.stereotype.Service;
import org.springframework.transaction.annotation.Transactional;

/**
 * 品牌
 */
@Service
@Transactional
public class BrandService {
    @Autowired
    private BrandMapper brandMapper;

    public PageResult<Brand> brandPageQuery(Integer page, Integer rows, String key, String sortBy, Boolean desc) {
        //1.封装查询条件
        //1.1 封装分页参数
        IPage iPage = new Page(page,rows);

        //1.2 封装查询条件
        QueryWrapper<Brand> queryWrapper = Wrappers.query();

        //自行封装条件
        if(StringUtils.isNotEmpty(key)){
            // name like xxx or letter = xxxx
            /**
             * 参数一：字段名称（而不是属性名称）
             */
            queryWrapper
                    .like("name",key)
                    .or()
                    .eq("letter",key);

        }

        //排序条件
        if(StringUtils.isNotEmpty(sortBy)){
            if(desc){
                //降序
                queryWrapper.orderByDesc(sortBy);
            }else{
                //升序
                queryWrapper.orderByAsc(sortBy);
            }
        }


        //2.执行查询，获取结果
        iPage = brandMapper.selectPage(iPage,queryWrapper);

        //3.处理结果，返回结果
        PageResult<Brand> pageResult = new PageResult<Brand>(iPage.getTotal(),iPage.getPages(),iPage.getRecords());
        return pageResult;
    }
}


```

### 4）重启ly-item测试

返回状态码

![image-20200314142358935](乐优电商-03-品牌管理.assets/image-20200314142358935.png)

返回结果

![image-20200314142442476](乐优电商-03-品牌管理.assets/image-20200314142442476.png)

## 10、品牌查询：渲染品牌分页查询页面

### 1）页面接收服务器返回的分页数据

先通过页面f12的控制台查看回调函数中的resp结果的结构是如何的：

![image-20200314142856884](乐优电商-03-品牌管理.assets/image-20200314142856884.png)

由resp的数据结构得知，回调函数的代码应该为：

![1605755744135](乐优电商-03-品牌管理.assets/1605755744135.png)

### 2）修改品牌列表中图片的显示

![image-20200314143518011](乐优电商-03-品牌管理.assets/image-20200314143518011.png)

### 3）最终页面代码

```vue
<template>
    <div>
        <v-layout row wrap>
            <v-flex xs6>
                <v-btn color="primary" round>品牌添加</v-btn>
            </v-flex>

            <v-flex xs6>
                <v-text-field
                        label="搜索"
                        prepend-icon="search"
                        v-model="searchKey"
                ></v-text-field>
            </v-flex>
        </v-layout>
        <!--
               headers: 定义数据列表的表头数据。我们管理的
               items： 定义数据列表的内容数据。我们管理的
               pagination： 定义分页参数的对象。该对象是有Vuetify框架管理的
               total-items： 定义总记录数。我们管理的
               loading： 进度条 true： 显示，false：不显示。我们管理的
        -->
        <v-data-table
                :headers="headers"
                :items="desserts"
                :pagination.sync="pagination"
                :total-items="totalDesserts"
                :loading="loading"
                class="elevation-1"
        >
            <!--定义表格的每列的内容来自于items的哪个属性-->
            <template v-slot:items="props">
                <td class="text-xs-center">{{ props.item.id }}</td>
                <td class="text-xs-center">{{ props.item.name }}</td>
                <td class="text-xs-center"><img :src="props.item.image"/></td>
                <td class="text-xs-center">{{ props.item.letter }}</td>
            </template>
        </v-data-table>
    </div>
</template>

<script>
    export default {
        data () {
            return {
                totalDesserts: 0,
                desserts: [],
                loading: true,
                pagination: {},
                headers: [
                    { text: '品牌编号', value: 'id' , sortable:true, align:'center' },
                    { text: '品牌名称', value: 'name' , sortable:false, align:'center'},
                    { text: '品牌图片', value: 'image' , sortable:false, align:'center'},
                    { text: '品牌首字母', value: 'letter' , sortable:true, align:'center'},
                ],
                searchKey:'',//搜索关键词
            }
        },
        mounted () {
            //调用查询品牌
            this.loadBrandData();
        },
        //属性监听
        watch:{
           //监听搜索关键词
            "searchKey":{ //基本变量
                handler(){
                    //调用查询品牌
                    this.loadBrandData();
                }
            },
            "pagination":{ //监听对象，必须使用深度监听
                deep:true,
                handler(){
                    //调用查询品牌
                    this.loadBrandData();
                }
            }
        },
        methods: {
            //查询品牌分页列表
            loadBrandData(){
                //往后端微服务发送请求
                this.$http.get('/item/brand/page',{
                    params:{
                        page:this.pagination.page,
                        rows:this.pagination.rowsPerPage,
                        key:this.searchKey,
                        sortBy:this.pagination.sortBy,
                        desc:this.pagination.descending,
                    }
                }).then(resp=>{
                    this.desserts = resp.data.items; //当前页列表
                    this.totalDesserts = resp.data.total; //总记录数

                    //关闭进度条
                    this.loading = false;

                }).catch(e=>{
                    console.log('品牌查询失败');
                });
            }
        }
    }
</script>
```





## 11、新增品牌：思路分析

品牌查询已经做好了，那么新增品牌我们直接在Brand.vue文件中开发即可。

![1575365293099](乐优电商-03-品牌管理.assets/1575365293099.png) 

品牌数据如何添加？ 除了自己的数据，还有无其他数据？

之前分析过品牌表和分类表是多对多，分类的数据，一般变动的比较少，所以中间表我们一般让变动比较多的品牌表来维护，也就是说我们添加完品牌数据，还需要在中间表添加数据。

![1575365502869](乐优电商-03-品牌管理.assets/1575365502869.png) 



```
外键：
	逻辑外键：通过代码维护关系，
		优点：便于迁移
		缺点：出现脏数据
	物理外键：数据库维护关系，
		优点：数据完整
		缺点：不方便删除
		
```

品牌添加页面分析图：

![image-20200314144329397](乐优电商-03-品牌管理.assets/image-20200314144329397.png) 

由品牌添加页面分析得知，品牌添加步骤分三步：

第一：先把图片存入到图片服务器

第二：把品牌对象入库

第三：维护品牌和分类的中间表



## 12、新增品牌：完成品牌的保存和中间表的维护

### 1）编写Controller

```java
/**
     * 添加品牌
     *  1）使用对象接收数据问题
     *      Brand brand: 接收普通参数。格式： name=xxx&image=xxx&letter=xxxx
     *      @RequestBody Brand brand: 接收json字符串参数。格式： {name=xxx,image:xxx,letter:xxxx}
     *
     *  2）接收多个同名参数问题
     *      页面同名参数格式：
     *           1） cids=70&cids=80
     *           2） cids=70,80
     *      后端如何接收
     *         1）字符串： 如： String cids;  //  70,80
     *         2）数组： 如： Long[] cids;  //  [70,80]
     *         3）集合： 如： List<Long> cids;  // [70,80]  注意：集合接收强制带上@RequestParam注解
     */
    @PostMapping("/brand")
    public ResponseEntity<Void> saveBrand(
            Brand brand,
            @RequestParam("cids") List<Long> cids

    ){
           brandService.saveBrand(brand,cids);
           //return ResponseEntity.status(HttpStatus.CREATED).body(null);
           return ResponseEntity.status(HttpStatus.CREATED).build();
    }
```



### 2）编写Service

这里要注意，我们不仅要新增品牌，还要维护品牌和商品分类的中间表。

```java
 public void saveBrand(Brand brand, List<Long> cids) {
        try {
            //1.保存品牌表
            brandMapper.insert(brand); //注意：MyBatis-Plus底层会自动获取数据库自增值赋值给主键属性值

            //2.保存品牌分类中间表
            brandMapper.saveBrandAndCategory(brand.getId(),cids);
        } catch (Exception e) {
            e.printStackTrace();
            throw new LyException(ExceptionEnum.INSERT_OPERATION_FAIL);
        }
    }
```



### 3）编写Mapper

```java
package com.leyou.item.mapper;

import com.baomidou.mybatisplus.core.mapper.BaseMapper;
import com.leyou.item.pojo.Brand;
import org.apache.ibatis.annotations.Param;

import java.util.List;

/**
 * 品牌
 */
public interface BrandMapper extends BaseMapper<Brand>{
    void saveBrandAndCategory(@Param("bid") Long id,@Param("cids") List<Long> cids);
}


```

在resource下新建一个目录：`mappers`，并在下面新建文件：`BrandMapper.xml`

 ![image-20200314151249920](乐优电商-03-品牌管理.assets/image-20200314151249920.png)



然后在`application.yml`文件中配置mapper文件的地址：

```yaml
mybatis-plus:
  type-aliases-package: com.leyou.item.pojo
  configuration:
    map-underscore-to-camel-case: true
  mapper-locations: classpath:mappers/*.xml #修改Mapper映射文件的路径
```

在`BrandMapper.xml`中定义Sql的statement：

```xml
<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.leyou.item.mapper.BrandMapper">
    <!--
       foreach: 循环标签
         collection： 需要遍历的值。查询别名
         item：遍历的每个元素的别名
         separator: 间隔符
    -->
    <insert id="saveBrandAndCategory">
      INSERT INTO tb_category_brand(category_id,brand_id) VALUES
      <foreach collection="cids" item="cid" separator=",">
        (#{cid},#{bid})
      </foreach>
    </insert>
</mapper>
```



编写完成代码后，重启微服务，测试查看品牌和中间表的数据是否已经插入即可！



4）开启myBatis日志

```yml
# 开启日志  
logging:
  level:
    com.leyou: debug
```





## 13、课程总结



1）品牌分页列表

​     1.1 了解页面使用Vuetify组件完成基本页面制作

​     1.2 熟悉前端ajax请求后台过程！！！！

​    1.3 完成品牌列表展示

2）品牌添加

​       2.1 操作两种表，品牌表，品牌分类表















